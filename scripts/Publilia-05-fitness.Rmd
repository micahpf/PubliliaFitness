---
title: '05 - PubliliaFitness - Estimating lifetime fecundity and fitness'
author: "Micah Fletcher"
date: '`r Sys.Date()`'
output: 
  rmdformats::robobook:
  fig_width: 9
toc_depth: 3
---

# Load libraries

```{r}
library(here)
library(tidyverse)
library(rstatix)
library(effectsize)
library(multcompView)
source(here("R/utils.R"))
source(here("R/Publilia-05-fitness-functions.R"))
```

# 0 - Data import

```{r}
strats_data <- read_rds(here("saved_rds/strats_data.rds"))
clutch_survivorship_data <- read_rds(here("saved_rds/clutch_survivorship_data.rds"))
focalMb4h_sc2h <- read_rds(here("saved_rds/focalMb4h_sc2h.rds"))
moms_plant_data <- read_rds(here("saved_rds/moms_plant_data.rds"))
surv_model_fits <- read_rds(here("saved_rds/surv_model_fits.rds"))
```


# Estimating fitness using different methods
There are several outdated versions that I've since deleted
 - “v2”: (survivorship ~ ant_treatment * desL) * proportion of time on eggs
 - “v3”: (survivorship ~ ants_ever * desL) * proportion of time on eggs
 - “v4”: (survivorship ~ ants_ever * desP) * proportion of time on eggs
 - “v5”: (survivorship ~ ants_ever * I(desP^2)) * proportion of time on eggs

The current versions are:
 - v1: raw offspring count * proportion of time on eggs
 - v6: (survivorship ~ ant_treatment * I(desL^2)) * proportion of time on eggs

```{r}
est_fitness_prep <- strats_data %>%
  filter(!is.na(initiation_date)) %>%
  group_by(Female_ID) %>%
  mutate(started_by_initiating =
           any(clutch_visited_order==1&clutch_initiated_order==1)) %>%
  ungroup() %>%
  select(location, Female_ID, clutch_visited_order, clutch_initiated_order,
         desert_rel2h = est_rel2h, guard_duration,
         mom_at_init, started_by_initiating, ever_antsP) %>%
  left_join(select(clutch_survivorship_data, location:last_desert,
                   n_eggs, med_t5eggs, n_hatched, n_survived, DormPlant),
            by=c("location")) %>%
  left_join(select(focalMb4h_sc2h, Female_ID, location, focalMb4h_sc2h),
            by=c("Female_ID", "location")) %>%
  mutate(des=last_des_rel2h,
         ants=ifelse(ants_removed,"Removed","Control"),
         vis=`visited in 4 days`) %>%
  separate(location, into = c("DormPlant", "Leaf"), sep="_", remove=FALSE) %>%
  left_join(dplyr::select(moms_plant_data, DormPlant, last_visit_ends_P), by="DormPlant") %>%
  mutate(last_desP_rel2h = last_visit_ends_P-est_hatch,
         ant_treatment=ifelse(ants_removed,"Removed","Control"))

# beware that clutch_status_momDays_b4h was create by right-joining clutch_momDays_b4h; possible that some hidden filtering occurred there

# v6: (survivorship ~ ant_treatment * I(desL^2)) * proportion of time on eggs
est_fitness_hatch_fit_v6 <- 
  ci_for_fitness(data_in=est_fitness_prep, model=surv_model_fits$hatch$mai.qb) %>%
  mutate(est_hatch_fit_v6 = fit) %>%
  select(-(fit:conf_lwr))
est_fitness_Esurv_fit_v6 <- 
  ci_for_fitness(data_in=est_fitness_hatch_fit_v6, model=surv_model_fits$Esurv$mai.qb) %>%
  mutate(est_Esurv_fit_v6 = fit) %>%
  select(-(fit:conf_lwr))

est_fitness_clutch <- est_fitness_Esurv_fit_v6 %>%
  mutate(propD_b4h = focalMb4h_sc2h/mDb4h_sc2h,
         est_eggs_clutch = med_t5eggs*propD_b4h,
         est_hatched_clutch_v1 = n_hatched*propD_b4h,
         est_survived_clutch_v1 = n_survived*propD_b4h,
         est_hatched_clutch_v6 = est_eggs_clutch*est_hatch_fit_v6,
         est_survived_clutch_v6 = est_eggs_clutch*est_Esurv_fit_v6) %>%
  group_by(Female_ID) %>%
    mutate(est_eggs_life = sum(est_eggs_clutch, na.rm = T),
           est_hatched_life_v1 = sum(est_hatched_clutch_v1, na.rm = T),
           est_survived_life_v1 = sum(est_survived_clutch_v1, na.rm = T),
           est_hatched_life_v6 = sum(est_hatched_clutch_v6, na.rm = T),
           est_survived_life_v6 = sum(est_survived_clutch_v6, na.rm = T),
           n_clutches_iv = n(),
           n_initiated = sum(!is.na(clutch_initiated_order)),
           n_visited = sum(!is.na(initiation_date)&is.na(clutch_initiated_order)),
           n_feed = sum(is.na(initiation_date)),
           init_visit_life_tactic = ifelse(any(mom_at_init), 
                                           ifelse(any(!mom_at_init), "Both", "Initiated only"),
                                           ifelse(!any(mom_at_init), "Visited only", NA)),
           one_both_life_tactic = ifelse(any(mom_at_init), 
                                           ifelse(any(!mom_at_init), "Both", "One"),
                                           ifelse(!any(mom_at_init), "One", NA))) %>%
  ungroup()

est_fitness_future <- est_fitness_clutch %>%
  filter(clutch_visited_order == 1) %>%
  mutate(est_eggs_future = est_eggs_life - est_eggs_clutch,
         est_hatched_future_v1 = est_hatched_life_v1 - est_hatched_clutch_v1,
         est_hatched_future_v6 = est_hatched_life_v6 - est_hatched_clutch_v6,
         est_survived_future_v1 = est_survived_life_v1 - est_survived_clutch_v1,
         est_survived_future_v6 = est_survived_life_v6 - est_survived_clutch_v6)

est_fitness_strat_cats <- est_fitness_future %>%
  dplyr::select(Female_ID, location, desert_rel2h, last_des_rel2h,
         med_t5eggs, est_eggs_clutch, 
         est_hatched_life_v1, est_hatched_life_v6,
         est_hatched_future_v1, est_hatched_future_v6,
         est_survived_life_v1, est_survived_life_v6,
         est_survived_future_v1, est_survived_future_v6,
         females_removed, ants_removed, clutch_initiated_order,
         n_clutches_iv, n_initiated, n_visited, init_visit_life_tactic, `visited in 4 days`)
```

## Check how I'm calculating fecundity
```{r}
# no need to separate females_removed
est_fitness_clutch %>% 
  filter(!is.na(est_eggs_clutch)) %>%
  ggplot(data=., aes(x=des, y=est_eggs_clutch, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth() + ylim(0,60) +
  facet_wrap(vars(vis))

est_fitness_clutch %>%
  arrange(Female_ID) %>%
  select(Female_ID, location, focalMb4h_sc2h, mDb4h_sc2h, propD_b4h, 
         med_t5eggs, est_eggs_clutch, est_eggs_life) #%>% View()
```

## Check how I'm estimating hatching and survival and how many clutches are recovered
It might be that using the regression model with a continuous desertion date explanatory variable just cannot adequately capture the variation and will always deflate mean and variance in lifetime fitness (# N5). If I want a more accurate representation of the variation, maybe I should use discrete desertion date categories (boxplots) and explicitly include variance in the imputation. But will this lead to strange results when the metric determining eggs contributed is continuous? I don't have time to do this for the dissertation but I could explore it for the paper.
```{r}
# Check how I'm estimating hatching and survival and how many clutches are recovered
est_fitness_clutch %>%
  count(females_removed, !is.na(est_eggs_clutch), !is.na(est_hatched_clutch_v1), !is.na(est_survived_clutch_v1))

est_fitness_clutch %>%
  count(females_removed, !is.na(est_eggs_clutch), !is.na(est_hatched_clutch_v6), !is.na(est_survived_clutch_v6))

# It appears that my modeling is overestimating the number of nymphs hatched for clutches with very low est hatched v1
est_fitness_clutch %>% 
  filter(!is.na(est_hatched_clutch_v1),!is.na(est_hatched_clutch_v6)) %>%
  ggplot(data=., aes(x=est_hatched_clutch_v1, y=est_hatched_clutch_v6, color=vis)) +
  geom_abline(slope=1) +
  geom_point()

# v6: Consistency is MUCH worse for survivorship; MANY clutches with no surviving nymphs were predicted to have survived
est_fitness_clutch %>%
  filter(!is.na(est_survived_clutch_v1),!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=est_survived_clutch_v1, y=est_survived_clutch_v6, color=vis)) +
  geom_abline(slope=1) +
  geom_point() + facet_wrap(~females_removed)

est_fitness_clutch %>%
  filter(!is.na(est_survived_clutch_v1),!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=est_survived_clutch_v1, y=est_survived_clutch_v6, color=interaction(vis,ants))) +
  geom_abline(slope=1) +
  geom_point()  + xlim(0,60) + ylim(0,60)


### how well does this work from the perspective of imputation?
# hatching: ok correspondence, the spread is tighter, but range is preserved
est_fitness_clutch %>% 
  filter(!is.na(est_hatched_clutch_v1),!is.na(est_hatched_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_hatched_clutch_v1, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth() + ylim(0,60) +
  facet_wrap(vars(vis))

est_fitness_clutch %>% 
  filter(!is.na(est_hatched_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_hatched_clutch_v6, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth() + ylim(0,60) +
  facet_wrap(vars(vis))

# survival: ok correspondence, the spread is MUCH tighter and range is more limited; losing many higher values
est_fitness_clutch %>% 
  filter(!is.na(est_survived_clutch_v1),!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_survived_clutch_v1, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth() + ylim(0,60) +
  facet_wrap(vars(vis))

est_fitness_clutch %>% 
  filter(!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_survived_clutch_v6, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth() + ylim(0,60) +
  facet_wrap(vars(vis))
```

Only females that laid more than one clutch
```{r}
est_fitness_clutch %>%
  filter(!is.na(est_hatched_clutch_v1),!is.na(est_hatched_clutch_v6)) %>%
  ggplot(data=., aes(x=est_hatched_clutch_v1, y=est_hatched_clutch_v6)) +
  geom_abline(slope=1) +
  geom_point() +
  facet_wrap(~n_initiated>1)

est_fitness_clutch %>%
  filter(!is.na(est_survived_clutch_v1),!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=est_survived_clutch_v1, y=est_survived_clutch_v6)) +
  geom_abline(slope=1) +
  geom_point() +
  facet_wrap(~n_initiated>1)
```

### Life strategies: start by deserting early, guarding eggs, guarding nymphs or visited an existing clutch
```{r}
est_fitness_life_strats <- est_fitness_clutch %>%
  group_by(Female_ID) %>%
  # clutch visited order == 0 means she visited before initiation, so it shouldn't count
  mutate(started_by =
           ifelse(any(clutch_visited_order==1&!is.na(clutch_initiated_order)&clutch_initiated_order==1),
                  "initiating",
                  ifelse(any(clutch_visited_order==1&is.na(clutch_initiated_order)|
                             clutch_visited_order==1&!is.na(clutch_initiated_order)&clutch_initiated_order!=1),
                         "visiting", "other")),
         n_clutches_with_eggs_iv = sum(!is.na(clutch_visited_order)&(clutch_visited_order>0), na.rm=T)) %>%
  ungroup() %>%
  filter(clutch_visited_order==1) %>%
  # mutate(desert_cat = ifelse(started_by=="initiating",
  #                                ifelse(desert_rel2h <= -16, "desert",
  #                                       ifelse(desert_rel2h > -16 & desert_rel2h <= 4, "eggs", 
  #                                              ifelse(desert_rel2h >= 4,"nymphs",
  #                                                     NA))),
  #                                ifelse(started_by=="visiting", "visit", 
  #                                       NA)),
  mutate(desert_cat = ifelse(started_by=="initiating",
                                 ifelse(guard_duration <= 10, "desert",
                                        ifelse(guard_duration > 10 & desert_rel2h <= 4, "eggs", 
                                               ifelse(desert_rel2h >= 4,"nymphs",
                                                      NA))),
                                 ifelse(started_by=="visiting", "visit", 
                                        NA)),
         first_clutch_visited_in4d = ifelse(started_by=="initiating",
                                            ifelse(`visited in 4 days` == "Visited", "vis", "not"),
                                            NA),
         est_eggs_future = est_eggs_life - est_eggs_clutch,
         est_hatched_future_v1 = est_hatched_life_v1 - est_hatched_clutch_v1,
         est_hatched_future_v6 = est_hatched_life_v6 - est_hatched_clutch_v6,
         est_survived_future_v1 = est_survived_life_v1 - est_survived_clutch_v1,
         est_survived_future_v6 = est_survived_life_v6 - est_survived_clutch_v6) %>%
  distinct(Female_ID, ants_removed, females_removed, `visited in 4 days`,
           desert_cat, desert_rel2h, guard_duration,
           started_by, init_visit_life_tactic, one_both_life_tactic,
           first_clutch_visited_in4d, n_clutches_with_eggs_iv,
           est_eggs_clutch, est_eggs_life, est_eggs_future, 
           est_hatched_life_v1, est_hatched_life_v6, 
           est_hatched_future_v1, est_hatched_future_v6,
           est_hatched_clutch_v1, est_hatched_clutch_v6,
           est_survived_life_v1, est_survived_life_v6, 
           est_survived_future_v1, est_survived_future_v6,
           est_survived_clutch_v1, est_survived_clutch_v6) %>%
  # remove 4 females that visited clutches with unknown initiation dates
  filter(!is.na(ants_removed)) %>%
  # *** I need to figure out why these are NA!!! ***
  filter(!is.na(est_hatched_clutch_v6))
```


```{r}
est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat)) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  ylab("Estimated lifetime fecundity (eggs)")  +
  xlab("Reproductive strategy for first clutch") +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1)

est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v1, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  ylab("Estimated lifetime fitness (eggs hatched)")  + ylim(0,100) +
  xlab("Reproductive strategy for first clutch") +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1)

est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  ylab("Estimated lifetime fitness (eggs hatched)")  + ylim(0,100) +
  xlab("Reproductive strategy for first clutch") +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1)



est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v1, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  ylab("Estimated lifetime fitness (nymphs survived)")  + ylim(0,60) +
  xlab("Reproductive strategy for first clutch") +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1)

est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  ylab("Estimated lifetime fitness (nymphs survived)")  + ylim(0,60) +
  xlab("Reproductive strategy for first clutch") +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1)
```

## Boxplots

with jitter (messy)
```{r}
est_fitness_life_strats_eggs.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat)) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA, alpha=0) +
  #stat_summary(fun=mean, geom="point", shape=4, size=3) +
  ylab("Lifetime fecundity\n(total eggs laid)")  +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(),strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position='none')

est_fitness_life_strats_hatched.p <- est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA, key_glyph=draw_key_rect) +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3, key_glyph=draw_key_rect) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA, alpha=0, key_glyph=draw_key_rect) +
  #stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
  ylab("Lifetime fitness\n(total eggs hatched)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(),strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position = c(0.7,0.9))

est_fitness_life_strats_survived.p <- est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA, alpha=0) +
  #stat_summary(fun=mean, geom="point", shape=4, size=3) +
  ylab("Lifetime fitness\n(total nymphs survived)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(),strip.text.x = element_blank(),
        legend.position='none')

#library(egg)
egg::ggarrange(est_fitness_life_strats_eggs.p,
          est_fitness_life_strats_hatched.p,
          est_fitness_life_strats_survived.p,
          ncol=1, nrow=3)
```

with mean (clean)
```{r}
est_fitness_life_strats_eggs.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat)) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5) +
  stat_summary(fun=mean, geom="point", shape=4, size=3) +
  ylab("Lifetime fecundity\n(total eggs laid)")  +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(),strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position = "none")

est_fitness_life_strats_hatched.p <- est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, key_glyph=draw_key_rect) +
  stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
  ylab("Lifetime fitness\n(total eggs hatched)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(),strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position = c(0.7,0.9))

est_fitness_life_strats_survived.p <- est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5) +
  stat_summary(fun=mean, geom="point", shape=4, size=3) +
  ylab("Lifetime fitness\n(total nymphs survived)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(),strip.text.x = element_blank(),
        legend.position='none')

#library(egg)
egg::ggarrange(est_fitness_life_strats_eggs.p,
          est_fitness_life_strats_hatched.p,
          est_fitness_life_strats_survived.p,
          ncol=1, nrow=3)
```

splitting semelparous and iteroparous females (clean)
```{r}
est_fitness_life_strats_eggs_semel.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat), n_clutches_with_eggs_iv==1) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, key_glyph=draw_key_rect) +
  stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
  ylab("Lifetime fecundity\n(total eggs laid)")  + ylim(0,160) +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(), strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position="none")

est_fitness_life_strats_eggs_itero.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat), n_clutches_with_eggs_iv>1) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, key_glyph=draw_key_rect) +
  stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
  ylab("Lifetime fecundity\n(total eggs laid)")  + ylim(0,160) +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1) +
  theme(strip.background = element_blank(), strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position="none")

est_fitness_life_strats_hatched_semel.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat), n_clutches_with_eggs_iv==1) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, key_glyph=draw_key_rect) +
  stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
  ylab("Lifetime fitness\n(total eggs hatched)") + ylim(0,100) +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(), strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position=c(0.75,0.9))

est_fitness_life_strats_hatched_itero.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat), n_clutches_with_eggs_iv>1) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, key_glyph=draw_key_rect) +
  stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
   ylab("Lifetime fitness\n(total eggs hatched)") + ylim(0,100) +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1) +
  theme(strip.background = element_blank(), strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position=c(0.75,0.9))

est_fitness_life_strats_survived_semel.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat), n_clutches_with_eggs_iv==1) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, key_glyph=draw_key_rect) +
  stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
  ylab("Lifetime fitness\n(total nymphs survived)") + ylim(0,30) +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(), strip.text.x = element_blank(),
        legend.position="none",
        axis.text.x=element_text(angle=45, vjust=1, hjust=1))

est_fitness_life_strats_survived_itero.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat), n_clutches_with_eggs_iv>1) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, key_glyph=draw_key_rect) +
  stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
  ylab("Lifetime fitness\n(total nymphs survived)") + ylim(0,30) +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1) +
  theme(strip.background = element_blank(), strip.text.x = element_blank(),
        legend.position="none",
        axis.text.x=element_text(angle=45, vjust=1, hjust=1))

egg::ggarrange(est_fitness_life_strats_eggs_semel.p,est_fitness_life_strats_eggs_itero.p,
          est_fitness_life_strats_hatched_semel.p,est_fitness_life_strats_hatched_itero.p,
          est_fitness_life_strats_survived_semel.p,est_fitness_life_strats_survived_itero.p,
          ncol=2, nrow=3)
```

Should I include this raw data in the supplement? I think so.
```{r}
est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat)) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3) +
  ylab("Estimated lifetime fecundity (eggs)")  +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "white")) +
  theme_publilia() +
  facet_wrap(vars(ants_removed), nrow=1)

est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v1, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3) +
  ylab("Estimated lifetime fitness (eggs hatched)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "white")) +
  theme_publilia() +
  facet_wrap(vars(ants_removed), nrow=1)

est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v1, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3) +
  ylab("Estimated lifetime fitness (nymphs survived)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "white")) +
  theme_publilia() +
  facet_wrap(vars(ants_removed), nrow=1)
```

split violin v1
```{r}
est_fitness_life_strats_splitvio_eggs_v1.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=3) +
  ylab("Estimated lifetime fecundity (number of eggs laid)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia()

est_fitness_life_strats_splitvio_hatched_v1.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v1, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=3) +
  ylab("Estimated lifetime fitness (eggs hatched)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia()

est_fitness_life_strats_splitvio_survived_v1.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v1, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=3) +
  ylab("Estimated lifetime fitness (nymphs survived)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia()

egg::ggarrange(est_fitness_life_strats_splitvio_eggs_v1.p,
          est_fitness_life_strats_splitvio_hatched_v1.p,
          est_fitness_life_strats_splitvio_survived_v1.p,
          ncol=1, nrow=3)

est_fitness_life_strats_splitvio_eggs_v1_itero.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=2) +
  ylab("Estimated lifetime fecundity (number of eggs laid)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia() +
  facet_wrap(~n_clutches_with_eggs_iv>1)

est_fitness_life_strats_splitvio_hatched_v1_itero.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v1, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=2) +
  ylab("Estimated lifetime fitness (eggs hatched)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia() +
  facet_wrap(~n_clutches_with_eggs_iv>1)

est_fitness_life_strats_splitvio_survived_v1_itero.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v1, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=2) +
  ylab("Estimated lifetime fitness (nymphs survived)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia() +
  facet_wrap(~n_clutches_with_eggs_iv>1)

egg::ggarrange(est_fitness_life_strats_splitvio_eggs_v1_itero.p,
          est_fitness_life_strats_splitvio_hatched_v1_itero.p,
          est_fitness_life_strats_splitvio_survived_v1_itero.p,
          ncol=1, nrow=3)
```

split violin v6
```{r, fig.width = 6, fig.height = 4}
est_fitness_life_strats_splitvio_eggs_v6.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=3) +
  ylab("Estimated lifetime fecundity\n(number of eggs laid)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia()

est_fitness_life_strats_splitvio_hatched_v6.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v6, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50, key_glyph=draw_key_rect) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), 
             pch = 16, size=3, key_glyph=draw_key_rect) +
  ylab("Estimated lifetime fitness\n(eggs hatched)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ant exclusion"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ant exclusion"), values=c("brown1", "black")) +
  theme_publilia()

est_fitness_life_strats_splitvio_survived_v6.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v6, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=3) +
  ylab("Estimated lifetime fitness\n(nymphs survived)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia()

egg::ggarrange(est_fitness_life_strats_splitvio_eggs_v6.p +
                 theme(legend.position="none"),
          est_fitness_life_strats_splitvio_hatched_v6.p +
                 theme(legend.position=c(0.1,0.9)),
          est_fitness_life_strats_splitvio_survived_v6.p +
                 theme(legend.position="none"),
          ncol=1, nrow=3)

est_fitness_life_strats_splitvio_eggs_v6_itero.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=2) +
  ylab("Estimated lifetime fecundity\n(number of eggs laid)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia() +
  facet_wrap(~n_clutches_with_eggs_iv>1) + theme()

est_fitness_life_strats_splitvio_hatched_v6_itero.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v6, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50, key_glyph=draw_key_rect) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), 
             pch = 16, size=3, key_glyph=draw_key_rect) +
  ylab("Estimated lifetime fitness\n(eggs hatched)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia() +
  facet_wrap(~n_clutches_with_eggs_iv>1)

est_fitness_life_strats_splitvio_survived_v6_itero.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v6, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=2) +
  ylab("Estimated lifetime fitness\n(nymphs survived)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia() +
  facet_wrap(~n_clutches_with_eggs_iv>1)

egg::ggarrange(est_fitness_life_strats_splitvio_eggs_v6_itero.p +
                 theme(legend.position="none"),
          est_fitness_life_strats_splitvio_hatched_v6_itero.p +
                 theme(legend.position=c(0.1,0.8)),
          est_fitness_life_strats_splitvio_survived_v6_itero.p +
                 theme(legend.position="none"),
          ncol=1, nrow=3)
```

# Other measures of fecundity

### Number of clutches laid
```{r}
# est_fitness_future %>%
#   filter(!females_removed) %>%
#   count(desert_cat, ants_removed)
# 
# # Initiated or visited
# est_fecundity_future %>%
#   filter(!females_removed) %>%
#   ggplot(data=., aes(y = n_initiated+n_visited, x = desert_catL, fill=ants_removed)) +
#   stat_summary(fun="mean", geom = "bar", position = position_dodge(0.9)) +
#   stat_summary(fun.data="mean_se", geom = "errorbar",position = position_dodge(0.9), width = 0.2) +
#   stat_summary(fun.data="n", geom = "text", position = position_dodge(0.9)) +
#   theme_publilia()
# 
# # Initiated only
# est_fecundity_future %>%
#   filter(!females_removed) %>%
#   ggplot(data=., aes(y = n_initiated, x = desert_catL, fill=ants_removed)) +
#   stat_summary(fun="mean", geom = "bar", position = position_dodge(0.9)) +
#   stat_summary(fun.data="mean_se", geom = "errorbar",position = position_dodge(0.9), width = 0.2) +
#   theme_publilia()
# 
# # Visited only
# est_fecundity_future %>%
#   filter(!females_removed) %>%
#   ggplot(data=., aes(y = n_visited, x = desert_catL, fill=ants_removed)) +
#   stat_summary(fun="mean", geom = "bar", position = position_dodge(0.9)) +
#   stat_summary(fun.data="mean_se", geom = "errorbar",position = position_dodge(0.9), width = 0.2) +
#   theme_publilia()
# 
# # Feed only
# est_fecundity_future %>%
#   filter(!females_removed) %>%
#   ggplot(data=., aes(y = n_feed, x = desert_catL, fill=ants_removed)) +
#   stat_summary(fun="mean", geom = "bar", position = position_dodge(0.9)) +
#   stat_summary(fun.data="mean_se", geom = "errorbar",position = position_dodge(0.9), width = 0.2) +
#   theme_publilia()

```


## First clutch vs. future fecundity and fitness

```{r}
letterSize <- 3
```


Fecundity
```{r}
fitness_life_strats_data <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs"),
         desert_cat_ants = ifelse(ants_removed, 
                                 paste(desert_cat,"ants removed"),paste(desert_cat,"control")),
         desert_cat_ants = factor(desert_cat_ants,
          levels=c("visit control", "desert control", "eggs control","nymphs control",
                   "visit ants removed", "desert ants removed", "eggs ants removed","nymphs ants removed")))
  
# First
fitness_first_stats_eggs_v6 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_eggs_clutch, group=desert_cat_ants)
fitness_first_stats_eggs_v6["multcompLetters"]$multcompLetters$x <- 
  factor(rep(c("visit", "desert","eggs", "nymphs"),2), levels=c("visit", "desert","eggs", "nymphs"))
fitness_first_stats_eggs_v6["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_first_stats_eggs_v6["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_first_stats_eggs_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_clutch, group=desert_cat, 
                    itero=F, multcompLetters=fitness_first_stats_eggs_v6$multcompLetters,ymax=160) +
  ylab("First-clutch fecundity\n(eggs laid)") + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank())

# Future (all)
fitness_future_stats_eggs_v6 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_eggs_future, group=desert_cat_ants)
fitness_future_stats_eggs_v6["multcompLetters"]$multcompLetters$x <- 
  factor(rep(c("visit", "desert","eggs", "nymphs"),2), levels=c("visit", "desert","eggs", "nymphs"))
fitness_future_stats_eggs_v6["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_eggs_v6["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_future_stats_eggs_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_future, group=desert_cat, 
                    itero=F, multcompLetters=fitness_future_stats_eggs_v6$multcompLetters,
                    ymax=160) +
  ylab("Future fecundity\n(eggs laid)") + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank())

# Future (iteroparous only)
fitness_life_strats_data.itero <- filter(fitness_life_strats_data, n_clutches_with_eggs_iv>1)
fitness_future_stats_eggs.itero <- 
  fitness_KW_test(data=fitness_life_strats_data.itero, y=est_eggs_future, group=desert_cat_ants)
fitness_future_stats_eggs.itero["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_future_stats_eggs.itero["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_eggs.itero["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_future_stats_eggs_v6.itero.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data.itero, y=est_eggs_future, group=desert_cat, 
                    itero=T, multcompLetters=fitness_future_stats_eggs.itero$multcompLetters,
                    ymax=160)$itero +
  ylab("Multi-clutch future\nfecundity (eggs laid)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank())

# Life
fitness_life_stats_eggs_v6 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat_ants)
fitness_life_stats_eggs_v6["multcompLetters"]$multcompLetters$x <- 
  factor(rep(c("visit", "desert","eggs", "nymphs"),2), levels=c("visit", "desert","eggs", "nymphs"))
fitness_life_stats_eggs_v6["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_life_stats_eggs_v6["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_life_stats_eggs_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat, 
                    itero=F, multcompLetters=fitness_life_stats_eggs_v6$multcompLetters,
                    ymax=160) +
  ylab("Lifetime fecundity\n(eggs laid)") + 
    theme(legend.position="none")

fitness_eggs_future.v6.p <-
  egg::ggarrange(fitness_first_stats_eggs_v6.p, fitness_future_stats_eggs_v6.p, fitness_life_stats_eggs_v6.p,
                 labels=c("A","B","C"), ncol=1, nrow=3)

### trade-off
fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=desert_rel2h, est_eggs_future, color=ants_removed)) +
  geom_point() + geom_smooth(se=F, span=1)

fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=desert_rel2h, est_hatched_future_v6, color=ants_removed)) +
  geom_point() + geom_smooth(se=F, span=1)

fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=desert_rel2h, est_survived_future_v6, color=ants_removed)) +
  geom_point() + geom_smooth(se=F, span=1)

fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=est_eggs_clutch, est_eggs_future, color=ants_removed)) +
  geom_point() + geom_smooth(method=lm, se=F) +
  xlim(0,160) + ylim(0,160)

fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=est_hatched_clutch_v6, est_hatched_future_v6, color=ants_removed)) +
  geom_point() + geom_smooth(method=lm, se=F) +
  xlim(0,70) + ylim(0,70) # outlier at est_hatched_clutch_v6=90ish

fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=est_survived_clutch_v6, est_survived_future_v6, color=ants_removed)) +
  geom_point() + geom_smooth(method=lm, se=F) +
  xlim(0,25) + ylim(0,25)


fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=guard_duration, est_eggs_future, color=ants_removed)) +
  geom_point() + geom_smooth(method=lm, se=T)

fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=guard_duration, est_hatched_future_v6, color=ants_removed)) +
  geom_point() + geom_smooth(method=lm, se=F)

fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=guard_duration, est_survived_future_v6, color=ants_removed)) +
  geom_point() + geom_smooth(method=lm, se=F)

```

Future fecundity/fitness (itero)
```{r}
fitness_life_strats_data.itero <- filter(fitness_life_strats_data, n_clutches_with_eggs_iv>1)

# Eggs
fitness_future_stats_eggs.itero <- 
  fitness_KW_test(data=fitness_life_strats_data.itero, y=est_eggs_future, group=desert_cat_ants)
fitness_future_stats_eggs.itero["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_future_stats_eggs.itero["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_eggs.itero["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_future_stats_eggs_v6.itero.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data.itero, y=est_eggs_future, group=desert_cat, 
                    itero=T, multcompLetters=fitness_future_stats_eggs.itero$multcompLetters,
                    ymax=160)$itero +
  ylab("Multi-clutch future\nfecundity (eggs laid)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank())

# Hatch
fitness_future_stats_hatched.itero <- 
  fitness_KW_test(data=fitness_life_strats_data.itero, y=est_hatched_future_v6, group=desert_cat_ants)
fitness_future_stats_hatched.itero["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_future_stats_hatched.itero["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_hatched.itero["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_future_stats_hatched_v6.itero.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data.itero, y=est_hatched_future_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_future_stats_hatched.itero$multcompLetters,
                    ymax=75)$itero +
  ylab("Multi-clutch future\nfitness (eggs hatch)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank())

# Survive
fitness_future_stats_survived.itero <- 
  fitness_KW_test(data=fitness_life_strats_data.itero, y=est_survived_future_v6, group=desert_cat_ants)
fitness_future_stats_survived.itero["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_future_stats_survived.itero["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_survived.itero["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_future_stats_survived_v6.itero.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data.itero, y=est_survived_future_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_future_stats_survived.itero$multcompLetters,
                    ymax=22)$itero +
  ylab("Multi-clutch future\nfitness (nymphs survive)") + 
    theme(legend.position=c(0.8,0.8))

fitness_stats_future.v6.itero.p <-
  egg::ggarrange(fitness_future_stats_eggs_v6.itero.p, 
                 fitness_future_stats_hatched_v6.itero.p, 
                 fitness_future_stats_survived_v6.itero.p,
                 labels=c("A","B","C"), ncol=1, nrow=3)
```

Future fecundity/fitness (itero): Is the low sample size for visiting first undermining the power to detect differences among the more interesting groups?
```{r}
fitness_life_strats_data.itero.DEN <- filter(fitness_life_strats_data,
                                         n_clutches_with_eggs_iv>1,
                                         desert_cat != "visit")

# Eggs
fitness_future_stats_eggs.itero.DEN <- 
  fitness_KW_test(data=fitness_life_strats_data.itero.DEN, y=est_eggs_future, group=desert_cat_ants)
fitness_future_stats_eggs.itero.DEN["multcompLetters"]$multcompLetters$x <- 
  rep(c("desert","eggs", "nymphs"),2)
fitness_future_stats_eggs.itero.DEN["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_eggs.itero.DEN["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,T,T,T)))

fitness_future_stats_eggs_v6.itero.DEN.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data.itero.DEN, y=est_eggs_future, group=desert_cat, 
                    itero=T, multcompLetters=fitness_future_stats_eggs.itero.DEN$multcompLetters,
                    ymax=160)$itero +
  ylab("Multi-clutch future\nfecundity (eggs laid)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank())

# Hatch
fitness_future_stats_hatched.itero.DEN <- 
  fitness_KW_test(data=fitness_life_strats_data.itero.DEN, y=est_hatched_future_v6, group=desert_cat_ants)
fitness_future_stats_hatched.itero.DEN["multcompLetters"]$multcompLetters$x <- 
  rep(c("desert","eggs", "nymphs"),2)
fitness_future_stats_hatched.itero.DEN["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_hatched.itero.DEN["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,T,T,T)))

fitness_future_stats_hatched_v6.itero.DEN.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data.itero.DEN, y=est_hatched_future_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_future_stats_hatched.itero.DEN$multcompLetters,
                    ymax=75)$itero +
  ylab("Multi-clutch future\nfitness (eggs hatch)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank())

# Survive
fitness_future_stats_survived.itero.DEN <- 
  fitness_KW_test(data=fitness_life_strats_data.itero.DEN, y=est_survived_future_v6, group=desert_cat_ants)
fitness_future_stats_survived.itero.DEN["multcompLetters"]$multcompLetters$x <- 
  rep(c("desert","eggs", "nymphs"),2)
fitness_future_stats_survived.itero.DEN["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_survived.itero.DEN["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,T,T,T)))

fitness_future_stats_survived_v6.itero.DEN.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data.itero.DEN, y=est_survived_future_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_future_stats_survived.itero.DEN$multcompLetters,
                    ymax=22)$itero +
  ylab("Multi-clutch future\nfitness (nymphs survive)") + 
    theme(legend.position=c(0.8,0.8))

fitness_stats_future.v6.itero.DEN.p <-
  egg::ggarrange(fitness_future_stats_eggs_v6.itero.DEN.p, 
                 fitness_future_stats_hatched_v6.itero.DEN.p, 
                 fitness_future_stats_survived_v6.itero.DEN.p,
                 labels=c("A","B","C"), ncol=1, nrow=3)
```

Future fecundity/fitness (all)
```{r}
# Future
fitness_future_stats_hatched <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_hatched_future_v6, group=desert_cat_ants)
fitness_future_stats_hatched["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_future_stats_hatched["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_hatched["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_future_stats_hatched_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_hatched_future_v6, group=desert_cat, 
                    multcompLetters=fitness_future_stats_hatched$multcompLetters,
                    ymax=75) +
  ylab("Future\nfitness (eggs hatch)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank())

# Future
fitness_future_stats_survived <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_survived_future_v6, group=desert_cat_ants)
fitness_future_stats_survived["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_future_stats_survived["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_survived["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_future_stats_survived_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_survived_future_v6, group=desert_cat, 
                    multcompLetters=fitness_future_stats_survived$multcompLetters,
                    ymax=22) +
  ylab("Future\nfitness (nymphs survive)") + 
    theme(legend.position=c(0.8,0.8))

fitness_stats_future.v6.p <-
  egg::ggarrange(fitness_future_stats_eggs_v6.p, 
                 fitness_future_stats_hatched_v6.p, 
                 fitness_future_stats_survived_v6.p,
                 labels=c("A","B","C"), ncol=1, nrow=3)

ymax <-21
fitness_life_strats_data %>%
      filter(!females_removed, !is.na(desert_cat)) %>%
    ggplot(data = ., aes(x = desert_cat, y=est_survived_future_v6, fill=ants_removed, color=ants_removed)) + 
      ylim(-ymax * 0.05, ymax) + 
      geom_boxplot(alpha = 0.5, key_glyph = draw_key_rect) + 
      geom_point(position = position_jitterdodge(jitter.width = 0.08, dodge.width = 0.3), 
                 pch = 16, size = 2, key_glyph = draw_key_rect) + 
      xlab("Guarding strategy for first clutch") + theme_publilia() + 
      scale_fill_manual(labels = c("Control", "Ant exclusion"), values = c("brown1", "black")) + 
      scale_color_manual(labels = c("Control", "Ant exclusion"),  values = c("brown1", "black")) +
      geom_text(data = fitness_future_stats_survived$multcompLetters, 
                aes(x = x, y = -ymax * 0.05, label = label), 
                fontface = "bold", size = letterSize, position=position_dodge(width=0.5))

fitness_life_strats_data.itero %>%
      filter(!females_removed, !is.na(desert_cat)) %>%
    ggplot(data = ., aes(x = desert_cat, y=est_survived_future_v6, fill=ants_removed, color=ants_removed)) + 
      ylim(-ymax * 0.05, ymax) + 
      geom_boxplot(alpha = 0.5, key_glyph = draw_key_rect) + 
      geom_point(position = position_jitterdodge(jitter.width = 0.08, dodge.width = 0.3), 
                 pch = 16, size = 2, key_glyph = draw_key_rect) + 
      xlab("Guarding strategy for first clutch") + theme_publilia() + 
      scale_fill_manual(labels = c("Control", "Ant exclusion"), values = c("brown1", "black")) + 
      scale_color_manual(labels = c("Control", "Ant exclusion"),  values = c("brown1", "black")) +
      geom_text(data = fitness_future_stats_survived.itero$multcompLetters, 
                aes(x = x, y = -ymax * 0.05, label = label), 
                fontface = "bold", size = letterSize, position=position_dodge(width=0.5))


```



#######################################################################
#######################################################################
#######################################################################


# Final figures and statistics
## Lifetime fecundity and fitness
I want to know whether there is a difference in the lifetime fecundity or fitness yielded by different strategies.
Most importantly, I want to know whether there is a difference within ant-exclusion treatment, but I'm also want to know whether ant exclusion changes the fitness of a given strategy. The data are unpaired and probably no conforming well to a normal distribution.

## Not separating single-clutch and multi-clutch females (for main)
```{r}
letterSize<-3

fitness_life_strats_data <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs"),
         desert_cat_ants = ifelse(ants_removed, 
                                 paste(desert_cat,"ants removed"),paste(desert_cat,"control")),
         desert_cat_ants = factor(desert_cat_ants,
          levels=c("visit control", "desert control", "eggs control","nymphs control",
                   "visit ants removed", "desert ants removed", "eggs ants removed","nymphs ants removed")))

fitness_stats_eggs_v6 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat_ants)
fitness_stats_eggs_v6["multcompLetters"]$multcompLetters$x <- 
  factor(rep(c("visit", "desert","eggs", "nymphs"),2), levels=c("visit", "desert","eggs", "nymphs"))
fitness_stats_eggs_v6["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_eggs_v6["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_eggs_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat, 
                    itero=F, multcompLetters=fitness_stats_eggs_v6$multcompLetters,
                    ymax=160) +
  ylab("Lifetime fecundity\n(eggs laid)") + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank())


fitness_stats_hatched_v6 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_hatched_life_v6, group=desert_cat_ants)
fitness_stats_hatched_v6["multcompLetters"]$multcompLetters$x <- rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_hatched_v6["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_hatched_v6["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_hatched_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_hatched_life_v6, group=desert_cat, 
                    itero=F, multcompLetters=fitness_stats_hatched_v6$multcompLetters,
                    ymax=100) +
  ylab("Lifetime fitness\n(eggs hatched)") + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank())

fitness_stats_survived_v6 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_survived_life_v6, group=desert_cat_ants)
fitness_stats_survived_v6["multcompLetters"]$multcompLetters$x <- rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_survived_v6["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_survived_v6["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_survived_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_survived_life_v6, group=desert_cat, 
                    itero=F, multcompLetters=fitness_stats_survived_v6$multcompLetters,
                    ymax=30) +
  ylab("Lifetime fitness\n(nymphs survived)") + 
  theme(legend.position=c(0.3,0.9))

fitness_stats.v6.p.final <-
  egg::ggarrange(fitness_stats_eggs_v6.p, fitness_stats_hatched_v6.p, fitness_stats_survived_v6.p,
                 labels=c("A","B","C"), ncol=1, nrow=3)

ggsave(here("prelim_figs/Publilia-05-fitness/fitness_stats.violin.final.png"),
       fitness_stats.v6.p.final,
       device = "png",
       width = 120, height = 200, units = "mm", dpi = "print")
```

## Just offspring counts (no imputation)
```{r}
letterSize<-3

fitness_life_strats_data <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs"),
         desert_cat_ants = ifelse(ants_removed, 
                                 paste(desert_cat,"ants removed"),paste(desert_cat,"control")),
         desert_cat_ants = factor(desert_cat_ants,
          levels=c("visit control", "desert control", "eggs control","nymphs control",
                   "visit ants removed", "desert ants removed", "eggs ants removed","nymphs ants removed")))

fitness_stats_eggs_v1 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat_ants)
fitness_stats_eggs_v1["multcompLetters"]$multcompLetters$x <- 
  factor(rep(c("visit", "desert","eggs", "nymphs"),2), levels=c("visit", "desert","eggs", "nymphs"))
fitness_stats_eggs_v1["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_eggs_v1["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_eggs_v1.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat, 
                    itero=F, multcompLetters=fitness_stats_eggs_v1$multcompLetters,
                    ymax=160) +
  ylab("Lifetime fecundity\n(eggs laid)") + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank())


fitness_stats_hatched_v1 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_hatched_life_v1, group=desert_cat_ants)
fitness_stats_hatched_v1["multcompLetters"]$multcompLetters$x <- rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_hatched_v1["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_hatched_v1["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_hatched_v1.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_hatched_life_v1, group=desert_cat, 
                    itero=F, multcompLetters=fitness_stats_hatched_v1$multcompLetters,
                    ymax=100) +
  ylab("Lifetime fitness\n(eggs hatched)") + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank())

fitness_stats_survived_v1 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_survived_life_v1, group=desert_cat_ants)
fitness_stats_survived_v1["multcompLetters"]$multcompLetters$x <- rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_survived_v1["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_survived_v1["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_survived_v1.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_survived_life_v1, group=desert_cat, 
                    itero=F, multcompLetters=fitness_stats_survived_v1$multcompLetters,
                    ymax=30) +
  ylab("Lifetime fitness\n(nymphs survived)") + 
  theme(legend.position=c(0.3,0.9))

fitness_stats.v1.p.final <-
  egg::ggarrange(fitness_stats_eggs_v1.p, fitness_stats_hatched_v1.p, fitness_stats_survived_v1.p,
                 labels=c("A","B","C"), ncol=1, nrow=3)

ggsave(here("prelim_figs/Publilia-05-fitness/fitness_stats.supp_v1.violin.final.png"),
       fitness_stats.v1.p.final,
       device = "png",
       width = 120, height = 200, units = "mm", dpi = "print")
```

## Separating single-clutch and multi-clutch females (for main)
```{r}
letterSize<-3

fitness_life_strats_data.semel <- filter(fitness_life_strats_data, n_clutches_with_eggs_iv==1)
fitness_life_strats_data.itero <- filter(fitness_life_strats_data, n_clutches_with_eggs_iv>1)

fitness_stats_eggs.semel <- 
  fitness_KW_test(data=fitness_life_strats_data.semel, 
                  y=est_eggs_life, group=desert_cat_ants)
fitness_stats_eggs.semel["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_eggs.semel["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_eggs.semel["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_eggs.semel.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat, 
                    itero=T, multcompLetters=fitness_stats_eggs.semel$multcompLetters,
                    ymax=160)$semel +
  ylab("Single-clutch female\nfecundity (eggs laid)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank())

fitness_stats_eggs.itero <- 
  fitness_KW_test(data=fitness_life_strats_data.itero, 
                  y=est_eggs_life, group=desert_cat_ants)
fitness_stats_eggs.itero["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_eggs.itero["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_eggs.itero["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_eggs.itero.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat, 
                    itero=T, multcompLetters=fitness_stats_eggs.itero$multcompLetters,
                    ymax=160)$itero +
  ylab("Multi-clutch female\nfecundity (eggs laid)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank()) 


fitness_stats_hatched.semel <- 
  fitness_KW_test(data=fitness_life_strats_data.semel, 
                  y=est_hatched_life_v6, group=desert_cat_ants)
fitness_stats_hatched.semel["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_hatched.semel["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_hatched.semel["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_hatched.semel.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_hatched_life_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_stats_hatched.semel$multcompLetters,
                    ymax=100)$semel +
  ylab("Single-clutch female\nfitness (eggs hatched)") + 
    theme(legend.position=c(0.3,0.8), axis.title.x = element_blank(),axis.text.x=element_blank())

fitness_stats_hatched.itero <- 
  fitness_KW_test(data=fitness_life_strats_data.itero, 
                  y=est_hatched_life_v6, group=desert_cat_ants)
fitness_stats_hatched.itero["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_hatched.itero["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_hatched.itero["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_hatched.itero.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_hatched_life_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_stats_hatched.itero$multcompLetters,
                    ymax=100)$itero +
  ylab("Multi-clutch female\nfitness (eggs hatched)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank()) 


fitness_stats_survived.semel <- 
  fitness_KW_test(data=fitness_life_strats_data.semel, 
                  y=est_survived_life_v6, group=desert_cat_ants)
fitness_stats_survived.semel["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_survived.semel["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_survived.semel["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_survived.semel.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_survived_life_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_stats_survived.semel$multcompLetters,
                    ymax=30)$semel +
  ylab("Single-clutch female\nfitness (nymphs survived)") + 
    theme(legend.position="none")

fitness_stats_survived.itero <- 
  fitness_KW_test(data=fitness_life_strats_data.itero, 
                  y=est_survived_life_v6, group=desert_cat_ants)
fitness_stats_survived.itero["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_survived.itero["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_survived.itero["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_survived.itero.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_survived_life_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_stats_survived.itero$multcompLetters,
                    ymax=30)$itero +
  ylab("Multi-clutch female\nfitness (nymphs survived)") + 
    theme(legend.position="none") 

fitness_stats.parity.p.final <- egg::ggarrange(
  fitness_stats_eggs.semel.p, fitness_stats_eggs.itero.p,
  fitness_stats_hatched.semel.p, fitness_stats_hatched.itero.p,
  fitness_stats_survived.semel.p, fitness_stats_survived.itero.p,
  labels=c("A","B","C","D","E","F"), ncol=2, nrow=3)

ggsave(here("prelim_figs/Publilia-05-fitness/fitness_stats.violin.parity.final.png"),
       fitness_stats.parity.p.final,
       device = "png",
       width = 200, height = 200, units = "mm", dpi = "print")
```

## Clutch fitness prediction performance for imputation
```{r}
# Consistency is ok worse for hatching; MANY clutches with no surviving nymphs were predicted to have survived
(predicted_clutch_A <- est_fitness_clutch %>% 
  filter(!is.na(est_hatched_clutch_v1),!is.na(est_hatched_clutch_v6)) %>%
  ggplot(data=., aes(x=est_hatched_clutch_v1, y=est_hatched_clutch_v6, color=interaction(vis,ants))) +
  geom_abline(slope=1) +
  geom_point() + xlim(0,80) + ylim(0,80) +
  theme(legend.position="none"))

# Consistency is MUCH worse for survivorship; MANY clutches with no surviving nymphs were predicted to have survived
(predicted_clutch_B <- est_fitness_clutch %>%
  filter(!is.na(est_survived_clutch_v1),!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=est_survived_clutch_v1, y=est_survived_clutch_v6, color=interaction(vis,ants))) +
  geom_abline(slope=1) +
  geom_point()  + xlim(0,60) + ylim(0,60) +
  theme(legend.position=c(0.3,0.8)))

(predicted_clutch.p.final <- egg::ggarrange(
  predicted_clutch_A, predicted_clutch_B,
  labels=c("A","B"),
  ncol=2, nrow=1))
 
ggsave(here("prelim_figs/Publilia-05-fitness/predicted_clutch.final.png"),
       predicted_clutch.p.final,
       device = "png",
       width = 200, height = 100, units = "mm", dpi = "print")
```


### Life fitness prediction performance for imputation
Should I include this in the supplment?
```{r}
# hatching: ok correspondence, the spread is tighter, but range is preserved
(predicted_clutch_A <- est_fitness_clutch %>% 
  filter(!is.na(est_hatched_clutch_v1),!is.na(est_hatched_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_hatched_clutch_v1, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth(span=1) + ylim(0,60) +
   xlab("Desertion date relative to hatch\non first clutch") + 
   ylab("Clutch-level fitness\n(hatched eggs observed)") + 
   scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
   scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
   theme(legend.position="none",
         axis.text.x=element_text(angle=45, vjust=1, hjust=1),
         strip.background = element_blank()) +
  facet_wrap(vars(vis)))

(predicted_clutch_B <-est_fitness_clutch %>% 
  filter(!is.na(est_hatched_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_hatched_clutch_v6, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth(span=1) + ylim(0,60) +
   xlab("Desertion date relative to hatch\non first clutch") + 
   ylab("Clutch-level fitness\n(hatched eggs predicted by model)") + 
   scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
   scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
    theme(legend.position="none",
         axis.text.x=element_text(angle=45, vjust=1, hjust=1),
         strip.background = element_blank()) +
  facet_wrap(vars(vis)))

# survival: ok correspondence, the spread is MUCH tighter and range is more limited; losing many higher values
(predicted_clutch_C <- est_fitness_clutch %>% 
  filter(!is.na(est_survived_clutch_v1),!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_survived_clutch_v1, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth(span=1) + ylim(0,60) +
    xlab("Desertion date relative to hatch\non first clutch") + 
   ylab("Clutch-level fitness\n(surviving nymphs observed)") + 
   scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
   scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
    theme(legend.position="none",
         axis.text.x=element_text(angle=45, vjust=1, hjust=1),
         strip.background = element_blank()) +
  facet_wrap(vars(vis)))

(predicted_clutch_D <-est_fitness_clutch %>% 
  filter(!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_survived_clutch_v6, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth(span=1) + ylim(0,60) +
    xlab("Desertion date relative to hatch\non first clutch") + 
   ylab("Clutch-level fitness\n(hatched eggs predicted by model)") + 
   scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
   scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
    theme(legend.position=c(0.75,0.75),
         axis.text.x=element_text(angle=45, vjust=1, hjust=1),
         strip.background = element_blank()) +
  facet_wrap(vars(vis)))

(predicted_clutch.p.final <- egg::ggarrange(
  predicted_clutch_A, predicted_clutch_B,
  predicted_clutch_C, predicted_clutch_D,
  labels=c("A","B","C","D"),
  ncol=2, nrow=2))
 
ggsave(here("prelim_figs/Publilia-05-fitness/predicted_clutch.final.png"),
       predicted_clutch.p.final,
       device = "png",
       width = 200, height = 200, units = "mm", dpi = "print")
```

### Estimating fitness from counts instead of from survivorship function
2023.08.26 - `fitness_plot_dunn()` with `group=desert_cat_ants` caused error so changed to `group=desert_cat`, as for iterations above
```{r}
# fitness_life_strats_data <- fitness_life_strats_data %>%
#   mutate(desert_cat_ants = factor(desert_cat_ants, levels=c("desert control", "eggs control", 
#                                 "nymphs control", "visit control",
#                                 "desert ants removed", "eggs ants removed", 
#                                 "nymphs ants removed", "visit ants removed")))

fitness_stats_eggs_counted <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat_ants)
fitness_stats_eggs_counted["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_eggs_counted["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_eggs_counted["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

(fitness_counted_stats_eggs.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat, 
                    itero=F, multcompLetters=fitness_stats_eggs_counted$multcompLetters,
                    letterSize=4, ymax=160) +
  ylab("Lifetime fecundity\n(eggs laid)") + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank()))


fitness_stats_hatched_counted <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_hatched_life_v1, group=desert_cat_ants)
fitness_stats_hatched_counted["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_hatched_counted["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_hatched_counted["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

(fitness_counted_stats_hatched.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_hatched_life_v1, group=desert_cat, 
                    itero=F, multcompLetters=fitness_stats_hatched_counted$multcompLetters,
                    letterSize=4, ymax=75) +
  ylab("Lifetime fitness\n(eggs hatched)") + 
    theme(legend.position=c(0.75,0.9),
          axis.title.x = element_blank(),axis.text.x=element_blank()))


fitness_stats_survived_counted <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_survived_life_v1, group=desert_cat_ants)

fitness_stats_survived_counted <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_hatched_life_v1, group=desert_cat_ants)
fitness_stats_survived_counted["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_survived_counted["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_survived_counted["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

(fitness_counted_stats_survived.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_survived_life_v1, group=desert_cat, 
                    itero=F, multcompLetters=fitness_stats_survived_counted$multcompLetters,
                    letterSize=4, ymax=30) +
  ylab("Lifetime fitness\n(nymphs survived)") + 
    theme(legend.position="none",
          axis.text.x=element_text(angle=45, vjust=1, hjust=1)))

(fitness_counted_stats.p.final <- egg::ggarrange(
  fitness_counted_stats_eggs.p,
  fitness_counted_stats_hatched.p,
  fitness_counted_stats_survived.p,
  labels=c("A","B","C"),
  ncol=1, nrow=3))

ggsave(here("prelim_figs/Publilia-05-fitness/fitness_counted_stats.final.png"),
       fitness_counted_stats.p.final,
       device = "png",
       width = 120, height = 200, units = "mm", dpi = "print")
```






