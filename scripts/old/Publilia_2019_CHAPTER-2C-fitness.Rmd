---
title: "Publilia_2019_CHAPTER-2C-fitness"
author: "micah fletcher"
date: "2/24/2022"
output: html_document
---

# Publilia 2019 Chapter - Script 2C: estimating fitness
This is meant to consolidate previous scripts and provide a readable and reproducible record of the analyses for the Publilia Chapter.

## Lifetime fitness using regression predictions
Custom functions for using survivorship regression predictions to estimate fitness
```{r}
ci_for_fitness <- function(data_in, survNom, survDen, 
                        tenure, treatment, vis, model){
  data <- eval(substitute(
    data_in %>%
      add_column(fit = predict(model, newdata = ., type = 'response'))
    ))
  ## grad the inverse link function
  ilink <- family(model)$linkinv
  ## add fit and se.fit on the **link** scale
  data_fit_link <- eval(substitute(
    data %>% add_column(
  setNames(as_tibble(predict(model, data, se.fit = TRUE)[1:2]),
           c('fit_link','se_link'))) %>%
## create the interval and backtransform
  mutate(fit_resp  = ilink(fit_link),
         conf_upr = ilink(fit_link + (2 * se_link)),
         conf_lwr = ilink(fit_link - (2 * se_link)))
    ))
  return(data_fit_link)
}
```

# Estimating fitness using different methods
There are several outdated versions that I've since deleted
 - “v2”: (survivorship ~ ant_treatment * desL) * proportion of time on eggs
 - “v3”: (survivorship ~ ants_ever * desL) * proportion of time on eggs
 - “v4”: (survivorship ~ ants_ever * desP) * proportion of time on eggs
 - “v5”: (survivorship ~ ants_ever * I(desP^2)) * proportion of time on eggs

The current versions are:
 - v1: raw offspring count * proportion of time on eggs
 - v6: (survivorship ~ ant_treatment * I(desL^2)) * proportion of time on eggs

Not time for dissertation but I could experiment with using a square root function for egg laying (more eggs in the first few days of guarding/visiting) and see how robust these results are to our assumptions about egg laying behavior.
```{r}
est_fitness_prep <- visited_1st_4d_data %>%
  filter(!is.na(initiation_date)) %>%
  group_by(Female_ID) %>%
  mutate(started_by_initiating =
           any(clutch_visited_order==1&clutch_initiated_order==1)) %>%
  ungroup() %>%
  select(location, Female_ID, clutch_visited_order, clutch_initiated_order, 
         desert_rel2h = est_rel2h, guard_duration,
         mom_at_init, started_by_initiating) %>%
  left_join(select(clutch_survivorship_data, location:last_desert, 
                   n_eggs, med_t5eggs, n_hatched, n_survived, DormPlant), 
            by=c("location")) %>%
  left_join(select(focalMb4h_sc2h, Female_ID, location, focalMb4h_sc2h),
            by=c("Female_ID", "location")) %>%
  mutate(des=last_des_rel2h, 
         ants=ifelse(ants_removed,"Removed","Control"),
         vis=`visited in 4 days`) %>%
  left_join(select(ant_counts, location, ever_antsP)) %>%
  separate(location, into = c("DormPlant", "Leaf"), sep="_", remove=FALSE) %>%
  left_join(dplyr::select(moms_plant_data, DormPlant, last_visit_ends_P), by="DormPlant") %>%
  mutate(last_desP_rel2h = last_visit_ends_P-est_hatch,
         ant_treatment=ifelse(ants_removed,"Removed","Control"))

# v6: (survivorship ~ ant_treatment * I(desL^2)) * proportion of time on eggs
est_fitness_hatch_fit_v6 <- 
  ci_for_fitness(data_in=est_fitness_prep, model=des_hatch.desL.ant_treatment.quad.fits$mai.qb) %>%
  mutate(est_hatch_fit_v6 = fit) %>%
  select(-(fit:conf_lwr))
est_fitness_Esurv_fit_v6 <- 
  ci_for_fitness(data_in=est_fitness_hatch_fit_v6, model=des_Esurv.desL.ant_treatment.quad.fits$mai.qb) %>%
  mutate(est_Esurv_fit_v6 = fit) %>%
  select(-(fit:conf_lwr))

est_fitness_clutch <- est_fitness_Esurv_fit_v6 %>%
  mutate(propD_b4h = focalMb4h_sc2h/mDb4h_sc2h,
         est_eggs_clutch = med_t5eggs*propD_b4h,
         est_hatched_clutch_v1 = n_hatched*propD_b4h,
         est_survived_clutch_v1 = n_survived*propD_b4h,
         est_hatched_clutch_v6 = est_eggs_clutch*est_hatch_fit_v6,
         est_survived_clutch_v6 = est_eggs_clutch*est_Esurv_fit_v6) %>%
  group_by(Female_ID) %>%
    mutate(est_eggs_life = sum(est_eggs_clutch, na.rm = T),
           est_hatched_life_v1 = sum(est_hatched_clutch_v1, na.rm = T),
           est_survived_life_v1 = sum(est_survived_clutch_v1, na.rm = T),
           est_hatched_life_v6 = sum(est_hatched_clutch_v6, na.rm = T),
           est_survived_life_v6 = sum(est_survived_clutch_v6, na.rm = T),
           n_clutches_iv = n(),
           n_initiated = sum(!is.na(clutch_initiated_order)),
           n_visited = sum(!is.na(initiation_date)&is.na(clutch_initiated_order)),
           n_feed = sum(is.na(initiation_date)),
           init_visit_life_tactic = ifelse(any(mom_at_init), 
                                           ifelse(any(!mom_at_init), "Both", "Initiated only"),
                                           ifelse(!any(mom_at_init), "Visited only", NA)),
           one_both_life_tactic = ifelse(any(mom_at_init), 
                                           ifelse(any(!mom_at_init), "Both", "One"),
                                           ifelse(!any(mom_at_init), "One", NA))) %>%
  ungroup()

est_fitness_future <- est_fitness_clutch %>%
  filter(clutch_visited_order == 1) %>%
  mutate(est_eggs_future = est_eggs_life - est_eggs_clutch,
         est_hatched_future_v1 = est_hatched_life_v1 - est_hatched_clutch_v1,
         est_hatched_future_v6 = est_hatched_life_v6 - est_hatched_clutch_v6,
         est_survived_future_v1 = est_survived_life_v1 - est_survived_clutch_v1,
         est_survived_future_v6 = est_survived_life_v6 - est_survived_clutch_v6)

est_fitness_strat_cats <- est_fitness_future %>%
  dplyr::select(Female_ID, location, desert_rel2h, last_des_rel2h,
         med_t5eggs, est_eggs_clutch, 
         est_hatched_life_v1, est_hatched_life_v6,
         est_hatched_future_v1, est_hatched_future_v6,
         est_survived_life_v1, est_survived_life_v6,
         est_survived_future_v1, est_survived_future_v6,
         females_removed, ants_removed, clutch_initiated_order,
         n_clutches_iv, n_initiated, n_visited, init_visit_life_tactic, `visited in 4 days`)
```

## Check how I'm calculating fecundity
```{r}
# no need to separate females_removed
est_fitness_clutch %>% 
  filter(!is.na(est_eggs_clutch)) %>%
  ggplot(data=., aes(x=des, y=est_eggs_clutch, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth() + ylim(0,60) +
  facet_wrap(vars(vis))

est_fitness_clutch %>%
  arrange(Female_ID) %>%
  select(Female_ID, location, focalMb4h_sc2h, mDb4h_sc2h, propD_b4h, 
         med_t5eggs, est_eggs_clutch, est_eggs_life) #%>% View()
```

## Check how I'm estimating hatching and survival and how many clutches are recovered
It might be that using the regression model with a continuous desertion date explanatory variable just cannot adequately capture the variation and will always deflate mean and variance in lifetime fitness (# N5). If I want a more accurate representation of the variation, maybe I should use discrete desertion date categories (boxplots) and explicitly include variance in the imputation. But will this lead to strange results when the metric determining eggs contributed is continuous? I don't have time to do this for the dissertation but I could explore it for the paper.
```{r}
# Check how I'm estimating hatching and survival and how many clutches are recovered
est_fitness_clutch %>%
  count(females_removed, !is.na(est_eggs_clutch), !is.na(est_hatched_clutch_v1), !is.na(est_survived_clutch_v1))

est_fitness_clutch %>%
  count(females_removed, !is.na(est_eggs_clutch), !is.na(est_hatched_clutch_v6), !is.na(est_survived_clutch_v6))

# It appears that my modeling is overestimating the number of nymphs hatched for clutches with very low est hatched v1
est_fitness_clutch %>% 
  filter(!is.na(est_hatched_clutch_v1),!is.na(est_hatched_clutch_v6)) %>%
  ggplot(data=., aes(x=est_hatched_clutch_v1, y=est_hatched_clutch_v6, color=sum_vD==0)) +
  geom_abline(slope=1) +
  geom_point()

# v6: Consistency is MUCH worse for survivorship; MANY clutches with no surviving nymphs were predicted to have survived
est_fitness_clutch %>%
  filter(!is.na(est_survived_clutch_v1),!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=est_survived_clutch_v1, y=est_survived_clutch_v6, color=vis)) +
  geom_abline(slope=1) +
  geom_point() + facet_wrap(~females_removed)

est_fitness_clutch %>%
  filter(!is.na(est_survived_clutch_v1),!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=est_survived_clutch_v1, y=est_survived_clutch_v6, color=interaction(vis,ants))) +
  geom_abline(slope=1) +
  geom_point()  + xlim(0,60) + ylim(0,60)


### how well does this work from the perspective of imputation?
# hatching: ok correspondence, the spread is tighter, but range is preserved
est_fitness_clutch %>% 
  filter(!is.na(est_hatched_clutch_v1),!is.na(est_hatched_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_hatched_clutch_v1, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth() + ylim(0,60) +
  facet_wrap(vars(vis))

est_fitness_clutch %>% 
  filter(!is.na(est_hatched_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_hatched_clutch_v6, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth() + ylim(0,60) +
  facet_wrap(vars(vis))

# survival: ok correspondence, the spread is MUCH tighter and range is more limited; losing many higher values
est_fitness_clutch %>% 
  filter(!is.na(est_survived_clutch_v1),!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_survived_clutch_v1, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth() + ylim(0,60) +
  facet_wrap(vars(vis))

est_fitness_clutch %>% 
  filter(!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_survived_clutch_v6, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth() + ylim(0,60) +
  facet_wrap(vars(vis))
```

Only females that laid more than one clutch
```{r}
est_fitness_clutch %>%
  filter(!is.na(est_hatched_clutch_v1),!is.na(est_hatched_clutch_v6)) %>%
  ggplot(data=., aes(x=est_hatched_clutch_v1, y=est_hatched_clutch_v6)) +
  geom_abline(slope=1) +
  geom_point() +
  facet_wrap(~n_initiated>1)

est_fitness_clutch %>%
  filter(!is.na(est_survived_clutch_v1),!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=est_survived_clutch_v1, y=est_survived_clutch_v6)) +
  geom_abline(slope=1) +
  geom_point() +
  facet_wrap(~n_initiated>1)
```

### Life strategies: start by deserting early, guarding eggs, guarding nymphs or visited an existing clutch
```{r}
est_fitness_life_strats <- est_fitness_clutch %>%
  group_by(Female_ID) %>%
  # clutch visited order == 0 means she visited before initiation, so it shouldn't count
  mutate(started_by =
           ifelse(any(clutch_visited_order==1&!is.na(clutch_initiated_order)&clutch_initiated_order==1),
                  "initiating",
                  ifelse(any(clutch_visited_order==1&is.na(clutch_initiated_order)|
                             clutch_visited_order==1&!is.na(clutch_initiated_order)&clutch_initiated_order!=1),
                         "visiting", "other")),
         n_clutches_with_eggs_iv = sum(!is.na(clutch_visited_order)&(clutch_visited_order>0), na.rm=T)) %>%
  ungroup() %>%
  filter(clutch_visited_order==1) %>%
  # mutate(desert_cat = ifelse(started_by=="initiating",
  #                                ifelse(desert_rel2h <= -16, "desert",
  #                                       ifelse(desert_rel2h > -16 & desert_rel2h <= 4, "eggs", 
  #                                              ifelse(desert_rel2h >= 4,"nymphs",
  #                                                     NA))),
  #                                ifelse(started_by=="visiting", "visit", 
  #                                       NA)),
  mutate(desert_cat = ifelse(started_by=="initiating",
                                 ifelse(guard_duration <= 10, "desert",
                                        ifelse(guard_duration > 10 & desert_rel2h <= 4, "eggs", 
                                               ifelse(desert_rel2h >= 4,"nymphs",
                                                      NA))),
                                 ifelse(started_by=="visiting", "visit", 
                                        NA)),
         first_clutch_visited_in4d = ifelse(started_by=="initiating",
                                            ifelse(`visited in 4 days` == "Visited", "vis", "not"),
                                            NA),
         est_eggs_future = est_eggs_life - est_eggs_clutch,
         est_hatched_future_v1 = est_hatched_life_v1 - est_hatched_clutch_v1,
         est_hatched_future_v6 = est_hatched_life_v6 - est_hatched_clutch_v6,
         est_survived_future_v1 = est_survived_life_v1 - est_survived_clutch_v1,
         est_survived_future_v6 = est_survived_life_v6 - est_survived_clutch_v6) %>%
  distinct(Female_ID, ants_removed, females_removed, `visited in 4 days`,
           desert_cat, desert_rel2h, guard_duration,
           started_by, init_visit_life_tactic, one_both_life_tactic,
           first_clutch_visited_in4d, n_clutches_with_eggs_iv,
           est_eggs_clutch, est_eggs_life, est_eggs_future, 
           est_hatched_life_v1, est_hatched_life_v6, 
           est_hatched_future_v1, est_hatched_future_v6,
           est_hatched_clutch_v1, est_hatched_clutch_v6,
           est_survived_life_v1, est_survived_life_v6, 
           est_survived_future_v1, est_survived_future_v6,
           est_survived_clutch_v1, est_survived_clutch_v6) %>%
  # remove 4 females that visited clutches with unknown initiation dates
  filter(!is.na(ants_removed)) %>%
  # *** I need to figure out why these are NA!!! ***
  filter(!is.na(est_hatched_clutch_v6))
```


```{r}
est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat)) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  ylab("Estimated lifetime fecundity (eggs)")  +
  xlab("Reproductive strategy for first clutch") +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1)

est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v1, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  ylab("Estimated lifetime fitness (eggs hatched)")  + ylim(0,100) +
  xlab("Reproductive strategy for first clutch") +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1)

est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  ylab("Estimated lifetime fitness (eggs hatched)")  + ylim(0,100) +
  xlab("Reproductive strategy for first clutch") +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1)



est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v1, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  ylab("Estimated lifetime fitness (nymphs survived)")  + ylim(0,60) +
  xlab("Reproductive strategy for first clutch") +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1)

est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  ylab("Estimated lifetime fitness (nymphs survived)")  + ylim(0,60) +
  xlab("Reproductive strategy for first clutch") +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1)
```

## Boxplots

with jitter (messy)
```{r}
est_fitness_life_strats_eggs.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat)) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA, alpha=0) +
  #stat_summary(fun=mean, geom="point", shape=4, size=3) +
  ylab("Lifetime fecundity\n(total eggs laid)")  +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(),strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position='none')

est_fitness_life_strats_hatched.p <- est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA, key_glyph=draw_key_rect) +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3, key_glyph=draw_key_rect) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA, alpha=0, key_glyph=draw_key_rect) +
  #stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
  ylab("Lifetime fitness\n(total eggs hatched)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(),strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position = c(0.7,0.9))

est_fitness_life_strats_survived.p <- est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA, alpha=0) +
  #stat_summary(fun=mean, geom="point", shape=4, size=3) +
  ylab("Lifetime fitness\n(total nymphs survived)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(),strip.text.x = element_blank(),
        legend.position='none')

#library(egg)
egg::ggarrange(est_fitness_life_strats_eggs.p,
          est_fitness_life_strats_hatched.p,
          est_fitness_life_strats_survived.p,
          ncol=1, nrow=3)
```

with mean (clean)
```{r}
est_fitness_life_strats_eggs.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat)) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5) +
  stat_summary(fun=mean, geom="point", shape=4, size=3) +
  ylab("Lifetime fecundity\n(total eggs laid)")  +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(),strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position = "none")

est_fitness_life_strats_hatched.p <- est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, key_glyph=draw_key_rect) +
  stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
  ylab("Lifetime fitness\n(total eggs hatched)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(),strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position = c(0.7,0.9))

est_fitness_life_strats_survived.p <- est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5) +
  stat_summary(fun=mean, geom="point", shape=4, size=3) +
  ylab("Lifetime fitness\n(total nymphs survived)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(),strip.text.x = element_blank(),
        legend.position='none')

#library(egg)
egg::ggarrange(est_fitness_life_strats_eggs.p,
          est_fitness_life_strats_hatched.p,
          est_fitness_life_strats_survived.p,
          ncol=1, nrow=3)
```

splitting semelparous and iteroparous females (clean)
```{r}
est_fitness_life_strats_eggs_semel.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat), n_clutches_with_eggs_iv==1) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, key_glyph=draw_key_rect) +
  stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
  ylab("Lifetime fecundity\n(total eggs laid)")  + ylim(0,160) +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(), strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position="none")

est_fitness_life_strats_eggs_itero.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat), n_clutches_with_eggs_iv>1) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, key_glyph=draw_key_rect) +
  stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
  ylab("Lifetime fecundity\n(total eggs laid)")  + ylim(0,160) +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1) +
  theme(strip.background = element_blank(), strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position="none")

est_fitness_life_strats_hatched_semel.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat), n_clutches_with_eggs_iv==1) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, key_glyph=draw_key_rect) +
  stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
  ylab("Lifetime fitness\n(total eggs hatched)") + ylim(0,100) +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(), strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position=c(0.75,0.9))

est_fitness_life_strats_hatched_itero.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat), n_clutches_with_eggs_iv>1) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, key_glyph=draw_key_rect) +
  stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
   ylab("Lifetime fitness\n(total eggs hatched)") + ylim(0,100) +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1) +
  theme(strip.background = element_blank(), strip.text.x = element_blank(),
        axis.title.x = element_blank(),axis.text.x=element_blank(),
        legend.position=c(0.75,0.9))

est_fitness_life_strats_survived_semel.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat), n_clutches_with_eggs_iv==1) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, key_glyph=draw_key_rect) +
  stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
  ylab("Lifetime fitness\n(total nymphs survived)") + ylim(0,30) +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(~ants_removed, nrow=1) +
  theme(strip.background = element_blank(), strip.text.x = element_blank(),
        legend.position="none",
        axis.text.x=element_text(angle=45, vjust=1, hjust=1))

est_fitness_life_strats_survived_itero.p <- est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat), n_clutches_with_eggs_iv>1) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v6, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, key_glyph=draw_key_rect) +
  stat_summary(fun=mean, geom="point", shape=4, size=3,  key_glyph=draw_key_rect) +
  ylab("Lifetime fitness\n(total nymphs survived)") + ylim(0,30) +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray80")) +
  theme_publilia() +
  facet_wrap(vars(n_clutches_with_eggs_iv>1, ants_removed), nrow=1) +
  theme(strip.background = element_blank(), strip.text.x = element_blank(),
        legend.position="none",
        axis.text.x=element_text(angle=45, vjust=1, hjust=1))

egg::ggarrange(est_fitness_life_strats_eggs_semel.p,est_fitness_life_strats_eggs_itero.p,
          est_fitness_life_strats_hatched_semel.p,est_fitness_life_strats_hatched_itero.p,
          est_fitness_life_strats_survived_semel.p,est_fitness_life_strats_survived_itero.p,
          ncol=2, nrow=3)
```

Should I include this raw data in the supplement? I think so.
```{r}
est_fitness_life_strats %>%
  filter(!females_removed, !is.na(desert_cat)) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3) +
  ylab("Estimated lifetime fecundity (eggs)")  +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "white")) +
  theme_publilia() +
  facet_wrap(vars(ants_removed), nrow=1)

est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v1, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3) +
  ylab("Estimated lifetime fitness (eggs hatched)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "white")) +
  theme_publilia() +
  facet_wrap(vars(ants_removed), nrow=1)

est_fitness_life_strats %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v1, fill=ants_removed)) +
  geom_boxplot(position = position_dodge(0.75), size = 1.5, outlier.shape=NA) +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3) +
  ylab("Estimated lifetime fitness (nymphs survived)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "white")) +
  theme_publilia() +
  facet_wrap(vars(ants_removed), nrow=1)
```

## Split violin plots
geom_split_violin
```{r}
GeomSplitViolin <- ggproto("GeomSplitViolin", GeomViolin, 
                           draw_group = function(self, data, ..., draw_quantiles = NULL) {
  data <- transform(data, xminv = x - violinwidth * (x - xmin), xmaxv = x + violinwidth * (xmax - x))
  grp <- data[1, "group"]
  newdata <- plyr::arrange(transform(data, x = if (grp %% 2 == 1) xminv else xmaxv), if (grp %% 2 == 1) y else -y)
  newdata <- rbind(newdata[1, ], newdata, newdata[nrow(newdata), ], newdata[1, ])
  newdata[c(1, nrow(newdata) - 1, nrow(newdata)), "x"] <- round(newdata[1, "x"])

  if (length(draw_quantiles) > 0 & !scales::zero_range(range(data$y))) {
    stopifnot(all(draw_quantiles >= 0), all(draw_quantiles <=
      1))
    quantiles <- ggplot2:::create_quantile_segment_frame(data, draw_quantiles)
    aesthetics <- data[rep(1, nrow(quantiles)), setdiff(names(data), c("x", "y")), drop = FALSE]
    aesthetics$alpha <- rep(1, nrow(quantiles))
    both <- cbind(quantiles, aesthetics)
    quantile_grob <- GeomPath$draw_panel(both, ...)
    ggplot2:::ggname("geom_split_violin", grid::grobTree(GeomPolygon$draw_panel(newdata, ...), quantile_grob))
  }
  else {
    ggplot2:::ggname("geom_split_violin", GeomPolygon$draw_panel(newdata, ...))
  }
})

geom_split_violin <- function(mapping = NULL, data = NULL, stat = "ydensity", position = "identity", ..., 
                              draw_quantiles = NULL, trim = TRUE, scale = "area", na.rm = FALSE, 
                              show.legend = NA, inherit.aes = TRUE) {
  layer(data = data, mapping = mapping, stat = stat, geom = GeomSplitViolin, 
        position = position, show.legend = show.legend, inherit.aes = inherit.aes, 
        params = list(trim = trim, scale = scale, draw_quantiles = draw_quantiles, na.rm = na.rm, ...))
}
```


split violin v1
```{r}
est_fitness_life_strats_splitvio_eggs_v1.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=3) +
  ylab("Estimated lifetime fecundity (number of eggs laid)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia()

est_fitness_life_strats_splitvio_hatched_v1.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v1, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=3) +
  ylab("Estimated lifetime fitness (eggs hatched)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia()

est_fitness_life_strats_splitvio_survived_v1.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v1, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=3) +
  ylab("Estimated lifetime fitness (nymphs survived)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia()

egg::ggarrange(est_fitness_life_strats_splitvio_eggs_v1.p,
          est_fitness_life_strats_splitvio_hatched_v1.p,
          est_fitness_life_strats_splitvio_survived_v1.p,
          ncol=1, nrow=3)

est_fitness_life_strats_splitvio_eggs_v1_itero.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=2) +
  ylab("Estimated lifetime fecundity (number of eggs laid)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia() +
  facet_wrap(~n_clutches_with_eggs_iv>1)

est_fitness_life_strats_splitvio_hatched_v1_itero.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v1, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=2) +
  ylab("Estimated lifetime fitness (eggs hatched)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia() +
  facet_wrap(~n_clutches_with_eggs_iv>1)

est_fitness_life_strats_splitvio_survived_v1_itero.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v1, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=2) +
  ylab("Estimated lifetime fitness (nymphs survived)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia() +
  facet_wrap(~n_clutches_with_eggs_iv>1)

egg::ggarrange(est_fitness_life_strats_splitvio_eggs_v1_itero.p,
          est_fitness_life_strats_splitvio_hatched_v1_itero.p,
          est_fitness_life_strats_splitvio_survived_v1_itero.p,
          ncol=1, nrow=3)
```

split violin v6
```{r}
est_fitness_life_strats_splitvio_eggs_v6.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=3) +
  ylab("Estimated lifetime fecundity\n(number of eggs laid)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia()

est_fitness_life_strats_splitvio_hatched_v6.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v6, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50, key_glyph=draw_key_rect) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), 
             pch = 16, size=3, key_glyph=draw_key_rect) +
  ylab("Estimated lifetime fitness\n(eggs hatched)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ant exclusion"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ant exclusion"), values=c("brown1", "black")) +
  theme_publilia()

est_fitness_life_strats_splitvio_survived_v6.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v6, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=3) +
  ylab("Estimated lifetime fitness\n(nymphs survived)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia()

egg::ggarrange(est_fitness_life_strats_splitvio_eggs_v6.p +
                 theme(legend.position="none"),
          est_fitness_life_strats_splitvio_hatched_v6.p +
                 theme(legend.position=c(0.1,0.9)),
          est_fitness_life_strats_splitvio_survived_v6.p +
                 theme(legend.position="none"),
          ncol=1, nrow=3)

est_fitness_life_strats_splitvio_eggs_v6_itero.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_eggs_life, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=2) +
  ylab("Estimated lifetime fecundity\n(number of eggs laid)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia() +
  facet_wrap(~n_clutches_with_eggs_iv>1) + theme()

est_fitness_life_strats_splitvio_hatched_v6_itero.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_hatched_life_v6, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50, key_glyph=draw_key_rect) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), 
             pch = 16, size=3, key_glyph=draw_key_rect) +
  ylab("Estimated lifetime fitness\n(eggs hatched)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia() +
  facet_wrap(~n_clutches_with_eggs_iv>1)

est_fitness_life_strats_splitvio_survived_v6_itero.p <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs")) %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=est_survived_life_v6, fill=ants_removed, color=ants_removed)) +
  geom_split_violin(color=NA, alpha=0.50) +
  geom_point(position=position_jitterdodge(jitter.width=0.08, dodge.width=0.3), pch = 16, size=2) +
  ylab("Estimated lifetime fitness\n(nymphs survived)") +
  xlab("Reproductive strategy for first clutch") +
  scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "black")) +
  theme_publilia() +
  facet_wrap(~n_clutches_with_eggs_iv>1)

egg::ggarrange(est_fitness_life_strats_splitvio_eggs_v6_itero.p +
                 theme(legend.position="none"),
          est_fitness_life_strats_splitvio_hatched_v6_itero.p +
                 theme(legend.position=c(0.1,0.8)),
          est_fitness_life_strats_splitvio_survived_v6_itero.p +
                 theme(legend.position="none"),
          ncol=1, nrow=3)
```

## Comparing to Zink 2003 method

### 3 Zink 2003 model:
Lifetime fitness (number of eggs that hatched):
w(t_i) = sum(from i=1, to i=N, P_i*g(t_i))
P = number of eggs invested in a clutch (all the eggs go to the initiator?)
t_i = guarding duration in clutch i
N = lifetime number of clutches
g(t) = relationship between guarding duration and hatching success
 (assume g(t) equivalent across all clutches 1 to N)
 
* I think the main reason Zink found equivalent fitness is that he attributed all the eggs in a clutch to each primary female. Thus an early deserter is given all the eggs from a clutch, even if she leaves within a few days and another female arrives and lays additional eggs. The final nail in the coffin will be to do the exact same "zink" estimates but this time only attributing the egg to each female proportional to the time she spent on the clutch relative to other females.
```{r}
surv_reg_data_zink <- focalMb4h_sc2h %>%
  filter(!is.na(initiation_date), !is.na(guard_duration), !ants_removed) %>%
  filter(mom_at_init) %>% # primary females
  group_by(location) %>%
    summarize(max_primary_dur = max(guard_duration, na.rm=T),
              females_removed = first(females_removed),
              initiation_date = first(initiation_date)) %>%
  ungroup() %>%
  left_join(top5eggs_summary) %>%
  select(location, max_primary_dur,
         females_removed, initiation_date, med_t5eggs) %>%
  left_join(select(clutch_unambig_NOr_revised_ENAa_summary_imfilt_success_summary_v2,
                   -c(ants_removed, females_removed, initiation_date, n_eggs)),
            by=c("location"="NOr_rev_loc")) %>%
  select(location, initiation_date, hatch_date, 
         max_primary_dur, med_t5eggs, n_hatched, n_survived,
         females_removed)

ggplot(data=surv_reg_data_zink, 
       aes(x=max_primary_dur, y=n_hatched/med_t5eggs)) +
  geom_point() +
  geom_smooth(method=lm)

ggplot(data=filter(surv_reg_data_zink, initiation_date<=as_date("2019-06-10")), 
       aes(x=max_primary_dur, y=n_hatched/med_t5eggs)) +
  geom_point() +
  geom_smooth(method=lm)

ggplot(data=filter(surv_reg_data_zink, initiation_date<=as_date("2019-06-10"), !females_removed), 
       aes(x=max_primary_dur, y=n_hatched/med_t5eggs)) +
  geom_point() +
  geom_smooth(method=lm)

zink_hatch.m <- surv_reg_data_zink %>%
  filter(initiation_date<=as_date("2019-06-10"), !is.na(n_hatched/med_t5eggs)) %>%
lm(n_hatched/med_t5eggs ~ max_primary_dur, data=.)

summary(zink_hatch.m) # use this for predicting hatching success

zink_hatch.m.norem <- surv_reg_data_zink %>%
  filter(initiation_date<=as_date("2019-06-10"), !is.na(n_hatched/med_t5eggs), !females_removed) %>%
lm(n_hatched/med_t5eggs ~ max_primary_dur, data=.)

summary(zink_hatch.m.norem)

est_fitness_clutch_zink <- focalMb4h_sc2h %>%
  filter(!is.na(initiation_date), !ants_removed) %>%
  group_by(location) %>%
    mutate(max_primary_dur = max(mom_at_init*guard_duration, na.rm=T)) %>% # non-primary females are not counted
  ungroup() %>%
  left_join(top5eggs_summary) %>%
  left_join(clutch_momDays_b4h) %>%
  select(Female_ID, location, guard_duration, max_primary_dur, desert_rel2h=est_rel2h, focalMb4h_sc2h, mDb4h_sc2h,
         females_removed, initiation_date, med_t5eggs, 
         mom_at_init, clutch_visited_order, clutch_initiated_order) %>%
  left_join(select(clutch_unambig_NOr_revised_ENAa_summary_imfilt_success_summary_v2,
                   -c(ants_removed, females_removed, initiation_date, n_eggs)),
            by=c("location"="NOr_rev_loc")) %>%
  select(Female_ID, location, initiation_date, hatch_date, 
         guard_duration, max_primary_dur, desert_rel2h, focalMb4h_sc2h, mDb4h_sc2h,
         med_t5eggs, n_hatched, n_survived, females_removed,
         mom_at_init, clutch_visited_order, clutch_initiated_order) %>%
  mutate(propD_b4h = focalMb4h_sc2h/mDb4h_sc2h,
         est_eggs_clutch = med_t5eggs*propD_b4h,
         zink_est_hatch_clutch_v1 = med_t5eggs*(coef(zink_hatch.m)[[1]]+guard_duration*coef(zink_hatch.m)[[2]]),
         zink_est_hatch_clutch_v2 = est_eggs_clutch*(coef(zink_hatch.m)[[1]]+guard_duration*coef(zink_hatch.m)[[2]])) %>%
  group_by(Female_ID) %>%
    mutate(zink_est_hatch_life_v1 = sum(zink_est_hatch_clutch_v1, na.rm=T),
           zink_est_hatch_life_v2 = sum(zink_est_hatch_clutch_v2, na.rm=T)) %>%
  ungroup()

est_fitness_life_strats_Zink <- est_fitness_clutch_zink %>%
  group_by(Female_ID) %>%
  # clutch visited order == 0 means she visited before initiation, so it shouldn't count
  mutate(started_by =
           ifelse(any(clutch_visited_order==1&!is.na(clutch_initiated_order)&clutch_initiated_order==1),
                  "initiating",
                  ifelse(any(clutch_visited_order==1&is.na(clutch_initiated_order)|
                             clutch_visited_order==1&!is.na(clutch_initiated_order)&clutch_initiated_order!=1),
                         "visiting", "other")),
         n_clutches_with_eggs_iv = sum(!is.na(clutch_visited_order)&(clutch_visited_order>0), na.rm=T)) %>%
  ungroup() %>%
  filter(clutch_visited_order==1) %>%
  # mutate(desert_cat = ifelse(started_by=="initiating",
  #                                ifelse(desert_rel2h <= -16, "desert",
  #                                       ifelse(desert_rel2h > -16 & desert_rel2h <= 4, "eggs", 
  #                                              ifelse(desert_rel2h >= 4,"nymphs",
  #                                                     NA))),
  #                                ifelse(started_by=="visiting", "visit", 
  #                                       NA)),
  mutate(desert_cat = ifelse(started_by=="initiating",
                                 ifelse(guard_duration <= 10, "desert",
                                        ifelse(guard_duration > 10 & desert_rel2h <= 4, "eggs", 
                                               ifelse(guard_duration >= 4,"nymphs",
                                                      NA))),
                                 ifelse(started_by=="visiting", "visit", 
                                        NA)),
         zink_dur_cat = ifelse(started_by=="initiating",
                               ifelse(guard_duration<12, "desert",
                                      ifelse(guard_duration>=12, "stay", NA)),
                               ifelse(started_by=="visiting", "visit", 
                                        NA))) %>%
  distinct(Female_ID, females_removed,
           guard_duration, max_primary_dur,
           started_by, desert_cat, zink_dur_cat,
           zink_est_hatch_clutch_v1, zink_est_hatch_clutch_v2,
           zink_est_hatch_life_v1, zink_est_hatch_life_v2,
           n_clutches_with_eggs_iv)

# v1: Zink 2003 attributes all egg in a clutch to the primary female, even if they desert early and a visitor laid additional eggs
est_fitness_life_strats_Zink %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=zink_dur_cat, y=zink_est_hatch_life_v1, fill=zink_dur_cat)) +
  geom_boxplot(size=1.5) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  stat_summary(fun=mean, geom="point", shape=4, size=6) +
  ggtitle("v1: all eggs in clutch to primary female")

# v2: all calculations the same, but give eggs to females in proportion to the time they spent at clutch relative to other females
est_fitness_life_strats_Zink %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=zink_dur_cat, y=zink_est_hatch_life_v2, fill=zink_dur_cat)) +
  geom_boxplot(size=1.5) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  stat_summary(fun=mean, geom="point", shape=4, size=6) +
  ggtitle("v2: eggs to female by proportion of time guarding")

# same but separating females that laid one vs. multiple clutches
est_fitness_life_strats_Zink %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=zink_dur_cat, y=zink_est_hatch_life_v1, fill=zink_dur_cat)) +
  geom_boxplot(size=1.5) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  stat_summary(fun=mean, geom="point", shape=4, size=6) +
  facet_wrap(vars(n_clutches_with_eggs_iv!=1)) +
  ggtitle("v1: all eggs in clutch to primary female")

est_fitness_life_strats_Zink %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=zink_dur_cat, y=zink_est_hatch_life_v2, fill=zink_dur_cat)) +
  geom_boxplot(size=1.5) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  stat_summary(fun=mean, geom="point", shape=4, size=6) +
  facet_wrap(vars(n_clutches_with_eggs_iv!=1)) +
  ggtitle("v2: eggs to female by proportion of time guarding")

est_fitness_life_strats_Zink %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=zink_est_hatch_life_v1, fill=desert_cat)) +
  geom_boxplot(size=1.5) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  stat_summary(fun=mean, geom="point", shape=4, size=6) +
  ggtitle("v1: all eggs in clutch to primary female")

# same but using desert_cat instead of Zink 2003 cats
est_fitness_life_strats_Zink %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=zink_est_hatch_life_v1, fill=desert_cat)) +
  geom_boxplot(size=1.5) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  stat_summary(fun=mean, geom="point", shape=4, size=6) +
  facet_wrap(vars(n_clutches_with_eggs_iv!=1)) +
  ggtitle("v1: all eggs in clutch to primary female")

est_fitness_life_strats_Zink %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=zink_est_hatch_life_v2, fill=desert_cat)) +
  geom_boxplot(size=1.5) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  stat_summary(fun=mean, geom="point", shape=4, size=6) +
  ggtitle("v2: eggs to female by proportion of time guarding")

est_fitness_life_strats_Zink %>%
  filter(!females_removed) %>%
  ggplot(data=., aes(x=desert_cat, y=zink_est_hatch_life_v2, fill=desert_cat)) +
  geom_boxplot(size=1.5) +
  geom_jitter(pch = 21, size=3, width=0.35) +
  stat_summary(fun=mean, geom="point", shape=4, size=6) +
  facet_wrap(vars(n_clutches_with_eggs_iv!=1)) +
  ggtitle("v2: eggs to female by proportion of time guarding")

```

# Other measures of fecundity

### Number of clutches laid
```{r}
# est_fitness_future %>%
#   filter(!females_removed) %>%
#   count(desert_cat, ants_removed)
# 
# # Initiated or visited
# est_fecundity_future %>%
#   filter(!females_removed) %>%
#   ggplot(data=., aes(y = n_initiated+n_visited, x = desert_catL, fill=ants_removed)) +
#   stat_summary(fun="mean", geom = "bar", position = position_dodge(0.9)) +
#   stat_summary(fun.data="mean_se", geom = "errorbar",position = position_dodge(0.9), width = 0.2) +
#   stat_summary(fun.data="n", geom = "text", position = position_dodge(0.9)) +
#   theme_publilia()
# 
# # Initiated only
# est_fecundity_future %>%
#   filter(!females_removed) %>%
#   ggplot(data=., aes(y = n_initiated, x = desert_catL, fill=ants_removed)) +
#   stat_summary(fun="mean", geom = "bar", position = position_dodge(0.9)) +
#   stat_summary(fun.data="mean_se", geom = "errorbar",position = position_dodge(0.9), width = 0.2) +
#   theme_publilia()
# 
# # Visited only
# est_fecundity_future %>%
#   filter(!females_removed) %>%
#   ggplot(data=., aes(y = n_visited, x = desert_catL, fill=ants_removed)) +
#   stat_summary(fun="mean", geom = "bar", position = position_dodge(0.9)) +
#   stat_summary(fun.data="mean_se", geom = "errorbar",position = position_dodge(0.9), width = 0.2) +
#   theme_publilia()
# 
# # Feed only
# est_fecundity_future %>%
#   filter(!females_removed) %>%
#   ggplot(data=., aes(y = n_feed, x = desert_catL, fill=ants_removed)) +
#   stat_summary(fun="mean", geom = "bar", position = position_dodge(0.9)) +
#   stat_summary(fun.data="mean_se", geom = "errorbar",position = position_dodge(0.9), width = 0.2) +
#   theme_publilia()

```


## First clutch vs. future fecundity and fitness
Fecundity
```{r}
fitness_life_strats_data <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs"),
         desert_cat_ants = ifelse(ants_removed, 
                                 paste(desert_cat,"ants removed"),paste(desert_cat,"control")),
         desert_cat_ants = factor(desert_cat_ants,
          levels=c("visit control", "desert control", "eggs control","nymphs control",
                   "visit ants removed", "desert ants removed", "eggs ants removed","nymphs ants removed")))
  
# First
fitness_first_stats_eggs_v6 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_eggs_clutch, group=desert_cat_ants)
fitness_first_stats_eggs_v6["multcompLetters"]$multcompLetters$x <- 
  factor(rep(c("visit", "desert","eggs", "nymphs"),2), levels=c("visit", "desert","eggs", "nymphs"))
fitness_first_stats_eggs_v6["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_first_stats_eggs_v6["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_first_stats_eggs_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_clutch, group=desert_cat, 
                    itero=F, multcompLetters=fitness_first_stats_eggs_v6$multcompLetters,
                    letterSize=letterSize, ymax=160) +
  ylab("First-clutch fecundity\n(eggs laid)") + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank())

# Future (all)
fitness_future_stats_eggs_v6 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_eggs_future, group=desert_cat_ants)
fitness_future_stats_eggs_v6["multcompLetters"]$multcompLetters$x <- 
  factor(rep(c("visit", "desert","eggs", "nymphs"),2), levels=c("visit", "desert","eggs", "nymphs"))
fitness_future_stats_eggs_v6["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_eggs_v6["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_future_stats_eggs_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_future, group=desert_cat, 
                    itero=F, multcompLetters=fitness_future_stats_eggs_v6$multcompLetters,
                    letterSize=letterSize, ymax=160) +
  ylab("Future fecundity\n(eggs laid)") + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank())

# Future (iteroparous only)
fitness_life_strats_data.itero <- filter(fitness_life_strats_data, n_clutches_with_eggs_iv>1)
fitness_future_stats_eggs.itero <- 
  fitness_KW_test(data=fitness_life_strats_data.itero, y=est_eggs_future, group=desert_cat_ants)
fitness_future_stats_eggs.itero["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_future_stats_eggs.itero["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_eggs.itero["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_future_stats_eggs_v6.itero.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data.itero, y=est_eggs_future, group=desert_cat, 
                    itero=T, multcompLetters=fitness_future_stats_eggs.itero$multcompLetters,
                    letterSize=letterSize, ymax=160)$itero +
  ylab("Multi-clutch future\nfecundity (eggs laid)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank())

# Life
fitness_life_stats_eggs_v6 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat_ants)
fitness_life_stats_eggs_v6["multcompLetters"]$multcompLetters$x <- 
  factor(rep(c("visit", "desert","eggs", "nymphs"),2), levels=c("visit", "desert","eggs", "nymphs"))
fitness_life_stats_eggs_v6["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_life_stats_eggs_v6["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_life_stats_eggs_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat, 
                    itero=F, multcompLetters=fitness_life_stats_eggs_v6$multcompLetters,
                    letterSize=letterSize, ymax=160) +
  ylab("Lifetime fecundity\n(eggs laid)") + 
    theme(legend.position="none")

fitness_eggs_future.v6.p <-
  egg::ggarrange(fitness_first_stats_eggs_v6.p, fitness_future_stats_eggs_v6.p, fitness_life_stats_eggs_v6.p,
                 labels=c("A","B","C"), ncol=1, nrow=3)

### trade-off
fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=desert_rel2h, est_eggs_future, color=ants_removed)) +
  geom_point() + geom_smooth(se=F, span=1)

fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=desert_rel2h, est_hatched_future_v6, color=ants_removed)) +
  geom_point() + geom_smooth(se=F, span=1)

fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=desert_rel2h, est_survived_future_v6, color=ants_removed)) +
  geom_point() + geom_smooth(se=F, span=1)

fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=est_eggs_clutch, est_eggs_future, color=ants_removed)) +
  geom_point() + geom_smooth(method=lm, se=F) +
  xlim(0,160) + ylim(0,160)

fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=est_hatched_clutch_v6, est_hatched_future_v6, color=ants_removed)) +
  geom_point() + geom_smooth(method=lm, se=F) +
  xlim(0,70) + ylim(0,70) # outlier at est_hatched_clutch_v6=90ish

fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=est_survived_clutch_v6, est_survived_future_v6, color=ants_removed)) +
  geom_point() + geom_smooth(method=lm, se=F) +
  xlim(0,25) + ylim(0,25)


fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=guard_duration, est_eggs_future, color=ants_removed)) +
  geom_point() + geom_smooth(method=lm, se=T)

fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=guard_duration, est_hatched_future_v6, color=ants_removed)) +
  geom_point() + geom_smooth(method=lm, se=F)

fitness_life_strats_data.itero %>%
  ggplot(data=., aes(x=guard_duration, est_survived_future_v6, color=ants_removed)) +
  geom_point() + geom_smooth(method=lm, se=F)

```

Future fecundity/fitness (itero)
```{r}
fitness_life_strats_data.itero <- filter(fitness_life_strats_data, n_clutches_with_eggs_iv>1)

# Eggs
fitness_future_stats_eggs.itero <- 
  fitness_KW_test(data=fitness_life_strats_data.itero, y=est_eggs_future, group=desert_cat_ants)
fitness_future_stats_eggs.itero["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_future_stats_eggs.itero["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_eggs.itero["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_future_stats_eggs_v6.itero.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data.itero, y=est_eggs_future, group=desert_cat, 
                    itero=T, multcompLetters=fitness_future_stats_eggs.itero$multcompLetters,
                    letterSize=letterSize, ymax=160)$itero +
  ylab("Multi-clutch future\nfecundity (eggs laid)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank())

# Hatch
fitness_future_stats_hatched.itero <- 
  fitness_KW_test(data=fitness_life_strats_data.itero, y=est_hatched_future_v6, group=desert_cat_ants)
fitness_future_stats_hatched.itero["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_future_stats_hatched.itero["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_hatched.itero["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_future_stats_hatched_v6.itero.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data.itero, y=est_hatched_future_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_future_stats_hatched.itero$multcompLetters,
                    letterSize=letterSize, ymax=75)$itero +
  ylab("Multi-clutch future\nfitness (eggs hatch)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank())

# Survive
fitness_future_stats_survived.itero <- 
  fitness_KW_test(data=fitness_life_strats_data.itero, y=est_survived_future_v6, group=desert_cat_ants)
fitness_future_stats_survived.itero["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_future_stats_survived.itero["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_survived.itero["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_future_stats_survived_v6.itero.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data.itero, y=est_survived_future_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_future_stats_survived.itero$multcompLetters,
                    letterSize=letterSize, ymax=22)$itero +
  ylab("Multi-clutch future\nfitness (nymphs survive)") + 
    theme(legend.position=c(0.8,0.8))

fitness_stats_future.v6.itero.p <-
  egg::ggarrange(fitness_future_stats_eggs_v6.itero.p, 
                 fitness_future_stats_hatched_v6.itero.p, 
                 fitness_future_stats_survived_v6.itero.p,
                 labels=c("A","B","C"), ncol=1, nrow=3)
```

Future fecundity/fitness (itero): Is the low sample size for visiting first undermining the power to detect differences among the more interesting groups?
```{r}
fitness_life_strats_data.itero.DEN <- filter(fitness_life_strats_data,
                                         n_clutches_with_eggs_iv>1,
                                         desert_cat != "visit")

# Eggs
fitness_future_stats_eggs.itero.DEN <- 
  fitness_KW_test(data=fitness_life_strats_data.itero.DEN, y=est_eggs_future, group=desert_cat_ants)
fitness_future_stats_eggs.itero.DEN["multcompLetters"]$multcompLetters$x <- 
  rep(c("desert","eggs", "nymphs"),2)
fitness_future_stats_eggs.itero.DEN["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_eggs.itero.DEN["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,T,T,T)))

fitness_future_stats_eggs_v6.itero.DEN.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data.itero.DEN, y=est_eggs_future, group=desert_cat, 
                    itero=T, multcompLetters=fitness_future_stats_eggs.itero.DEN$multcompLetters,
                    letterSize=letterSize, ymax=160)$itero +
  ylab("Multi-clutch future\nfecundity (eggs laid)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank())

# Hatch
fitness_future_stats_hatched.itero.DEN <- 
  fitness_KW_test(data=fitness_life_strats_data.itero.DEN, y=est_hatched_future_v6, group=desert_cat_ants)
fitness_future_stats_hatched.itero.DEN["multcompLetters"]$multcompLetters$x <- 
  rep(c("desert","eggs", "nymphs"),2)
fitness_future_stats_hatched.itero.DEN["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_hatched.itero.DEN["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,T,T,T)))

fitness_future_stats_hatched_v6.itero.DEN.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data.itero.DEN, y=est_hatched_future_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_future_stats_hatched.itero.DEN$multcompLetters,
                    letterSize=letterSize, ymax=75)$itero +
  ylab("Multi-clutch future\nfitness (eggs hatch)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank())

# Survive
fitness_future_stats_survived.itero.DEN <- 
  fitness_KW_test(data=fitness_life_strats_data.itero.DEN, y=est_survived_future_v6, group=desert_cat_ants)
fitness_future_stats_survived.itero.DEN["multcompLetters"]$multcompLetters$x <- 
  rep(c("desert","eggs", "nymphs"),2)
fitness_future_stats_survived.itero.DEN["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_survived.itero.DEN["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,T,T,T)))

fitness_future_stats_survived_v6.itero.DEN.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data.itero.DEN, y=est_survived_future_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_future_stats_survived.itero.DEN$multcompLetters,
                    letterSize=letterSize, ymax=22)$itero +
  ylab("Multi-clutch future\nfitness (nymphs survive)") + 
    theme(legend.position=c(0.8,0.8))

fitness_stats_future.v6.itero.DEN.p <-
  egg::ggarrange(fitness_future_stats_eggs_v6.itero.DEN.p, 
                 fitness_future_stats_hatched_v6.itero.DEN.p, 
                 fitness_future_stats_survived_v6.itero.DEN.p,
                 labels=c("A","B","C"), ncol=1, nrow=3)
```

Future fecundity/fitness (all)
```{r}
# Future
fitness_future_stats_hatched <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_hatched_future_v6, group=desert_cat_ants)
fitness_future_stats_hatched["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_future_stats_hatched["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_hatched["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_future_stats_hatched_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_hatched_future_v6, group=desert_cat, 
                    multcompLetters=fitness_future_stats_hatched$multcompLetters,
                    letterSize=letterSize, ymax=75) +
  ylab("Future\nfitness (eggs hatch)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank())

# Future
fitness_future_stats_survived <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_survived_future_v6, group=desert_cat_ants)
fitness_future_stats_survived["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_future_stats_survived["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_future_stats_survived["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_future_stats_survived_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_survived_future_v6, group=desert_cat, 
                    multcompLetters=fitness_future_stats_survived$multcompLetters,
                    letterSize=letterSize, ymax=22) +
  ylab("Future\nfitness (nymphs survive)") + 
    theme(legend.position=c(0.8,0.8))

fitness_stats_future.v6.p <-
  egg::ggarrange(fitness_future_stats_eggs_v6.p, 
                 fitness_future_stats_hatched_v6.p, 
                 fitness_future_stats_survived_v6.p,
                 labels=c("A","B","C"), ncol=1, nrow=3)

ymax <-21
fitness_life_strats_data %>%
      filter(!females_removed, !is.na(desert_cat)) %>%
    ggplot(data = ., aes(x = desert_cat, y=est_survived_future_v6, fill=ants_removed, color=ants_removed)) + 
      ylim(-ymax * 0.05, ymax) + 
      geom_boxplot(alpha = 0.5, key_glyph = draw_key_rect) + 
      geom_point(position = position_jitterdodge(jitter.width = 0.08, dodge.width = 0.3), 
                 pch = 16, size = 2, key_glyph = draw_key_rect) + 
      xlab("Guarding strategy for first clutch") + theme_publilia() + 
      scale_fill_manual(labels = c("Control", "Ant exclusion"), values = c("brown1", "black")) + 
      scale_color_manual(labels = c("Control", "Ant exclusion"),  values = c("brown1", "black")) +
      geom_text(data = fitness_future_stats_survived$multcompLetters, 
                aes(x = x, y = -ymax * 0.05, label = label), 
                fontface = "bold", size = letterSize, position=position_dodge(width=0.5))

fitness_life_strats_data.itero %>%
      filter(!females_removed, !is.na(desert_cat)) %>%
    ggplot(data = ., aes(x = desert_cat, y=est_survived_future_v6, fill=ants_removed, color=ants_removed)) + 
      ylim(-ymax * 0.05, ymax) + 
      geom_boxplot(alpha = 0.5, key_glyph = draw_key_rect) + 
      geom_point(position = position_jitterdodge(jitter.width = 0.08, dodge.width = 0.3), 
                 pch = 16, size = 2, key_glyph = draw_key_rect) + 
      xlab("Guarding strategy for first clutch") + theme_publilia() + 
      scale_fill_manual(labels = c("Control", "Ant exclusion"), values = c("brown1", "black")) + 
      scale_color_manual(labels = c("Control", "Ant exclusion"),  values = c("brown1", "black")) +
      geom_text(data = fitness_future_stats_survived.itero$multcompLetters, 
                aes(x = x, y = -ymax * 0.05, label = label), 
                fontface = "bold", size = letterSize, position=position_dodge(width=0.5))


```



#######################################################################
#######################################################################
#######################################################################


# Final figures and statistics
## Lifetime fecundity and fitness
I want to know whether there is a difference in the lifetime fecundity or fitness yielded by different strategies.
Most importantly, I want to know whether there is a difference within ant-exclusion treatment, but I'm also want to know whether ant exclusion changes the fitness of a given strategy. The data are unpaired and probably no conforming well to a normal distribution.

plotting libraries
```{r}
library(multcompView)
```

geom_split_violin
```{r}
GeomSplitViolin <- ggproto("GeomSplitViolin", GeomViolin, 
                           draw_group = function(self, data, ..., draw_quantiles = NULL) {
  data <- transform(data, xminv = x - violinwidth * (x - xmin), xmaxv = x + violinwidth * (xmax - x))
  grp <- data[1, "group"]
  newdata <- plyr::arrange(transform(data, x = if (grp %% 2 == 1) xminv else xmaxv), if (grp %% 2 == 1) y else -y)
  newdata <- rbind(newdata[1, ], newdata, newdata[nrow(newdata), ], newdata[1, ])
  newdata[c(1, nrow(newdata) - 1, nrow(newdata)), "x"] <- round(newdata[1, "x"])

  if (length(draw_quantiles) > 0 & !scales::zero_range(range(data$y))) {
    stopifnot(all(draw_quantiles >= 0), all(draw_quantiles <=
      1))
    quantiles <- ggplot2:::create_quantile_segment_frame(data, draw_quantiles)
    aesthetics <- data[rep(1, nrow(quantiles)), setdiff(names(data), c("x", "y")), drop = FALSE]
    aesthetics$alpha <- rep(1, nrow(quantiles))
    both <- cbind(quantiles, aesthetics)
    quantile_grob <- GeomPath$draw_panel(both, ...)
    ggplot2:::ggname("geom_split_violin", grid::grobTree(GeomPolygon$draw_panel(newdata, ...), quantile_grob))
  }
  else {
    ggplot2:::ggname("geom_split_violin", GeomPolygon$draw_panel(newdata, ...))
  }
})

geom_split_violin <- function(mapping = NULL, data = NULL, stat = "ydensity", position = "identity", ..., 
                              draw_quantiles = NULL, trim = TRUE, scale = "area", na.rm = FALSE, 
                              show.legend = NA, inherit.aes = TRUE) {
  layer(data = data, mapping = mapping, stat = stat, geom = GeomSplitViolin, 
        position = position, show.legend = show.legend, inherit.aes = inherit.aes, 
        params = list(trim = trim, scale = scale, draw_quantiles = draw_quantiles, na.rm = na.rm, ...))
}
```

A function to run Kruskall-Wallis test and Dunn tests for each panel
```{r}
fitness_KW_test <- function(data, y, group){
  # non-parametric: Kruskall-Wallis test followed by Dunn test
  # run KW test using rstatix::kruskal_test
  KWtest <- eval(substitute(data %>% kruskal_test(y ~ group)))
  # get effect size using effectsize::rank_epsilon_squared
  KWepsilon2 <- eval(substitute(rank_epsilon_squared(y ~ group, data=data)))
  # run Dunn test using rstatix::dunn_test
  dunn <- eval(substitute(data %>% dunn_test(y ~ group)))
  # get multiple comparison groups letters using multcompView::multcompLetters
  dunn.vec <- dunn$p.adj.signif
  names(dunn.vec) <- paste(dunn$group1,dunn$group2,sep="-")
  multcompLetters <- tibble(x=names(multcompLetters(dunn.vec)$Letters),
                            label=unname(multcompLetters(dunn.vec)$Letters))
  # return
  out <- list(KWtest=KWtest, KWepsilon2=KWepsilon2, dunn=dunn, multcompLetters=multcompLetters)
  return(out)
}

fitness_life_strats_data.itero <- filter(fitness_life_strats_data, n_clutches_with_eggs_iv>1)
fitness_future_stats_eggs.itero <- 
  fitness_KW_test(data=fitness_life_strats_data.itero, y=est_eggs_future, group=desert_cat_ants)

KWtest <- fitness_life_strats_data %>% kruskal_test(est_eggs_future ~ desert_cat_ants)

# # test
# fitness_life_strats_data <- est_fitness_life_strats %>% 
#   mutate(desert_cat_ants = ifelse(ants_removed, 
#                                   paste(desert_cat,"ants removed"),paste(desert_cat,"control")))
# fitness_KW_test(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat_ants)

# # Troubleshooting:
# fitness_life_strats_data %>% filter(!females_removed, !is.na(desert_cat)) %>% 
#     ggplot(data = ., aes(x = desert_cat, y = est_eggs_life, fill = ants_removed, 
#         color = ants_removed)) + ylim(-160 * 0.05, 160) + 
#   geom_split_violin(color = NA, alpha = 0.5, key_glyph = draw_key_rect) + 
#   geom_point(position = position_jitterdodge(jitter.width = 0.08, dodge.width = 0.3), 
#              pch = 16, size = 2, key_glyph = draw_key_rect) + 
#     xlab("Guarding strategy for first clutch") + theme_publilia() + 
#     scale_fill_manual(labels = c("Control", "Ants removed"), 
#         values = c("brown1", "black")) + scale_color_manual(labels = c("Control", 
#     "Ants removed"), values = c("brown1", "black")) + 
#   geom_text(data = fitness_stats_eggs$multcompLetters, 
#             aes(x = x, y = -160 * 0.05, label = label), 
#             fontface = "bold", size = 4, position = position_dodge(width = 0.5)) + 
#   scale_x_discrete(labels = c("desert", "eggs", "nymphs", "visit"))
# 
# fitness_life_strats_data %>% filter(!females_removed, !is.na(desert_cat)) %>% 
#     ggplot(data = ., aes(x = desert_cat, y=est_eggs_life, fill=ants_removed, color=ants_removed)) + 
#   ylim(-160 * 0.05, 160) + 
#   geom_split_violin(color = NA, alpha = 0.5, key_glyph = draw_key_rect) + 
#   geom_point(position = position_jitterdodge(jitter.width = 0.08, dodge.width = 0.3), 
#              pch = 16, size = 2, key_glyph = draw_key_rect) + 
#     xlab("Guarding strategy for first clutch") + theme_publilia() + 
#     scale_fill_manual(labels = c("Control", "Ants removed"), values = c("brown1", "black")) + 
#   scale_color_manual(labels = c("Control", "Ants removed"),  values = c("brown1", "black")) + 
#   geom_text(data = fitness_stats_eggs$multcompLetters, 
#     aes(x = x, y = -160 * 0.05, label = label), 
#     fontface = "bold", size = 4, position=position_dodge(width=0.5)) + 
#   scale_x_discrete(labels = c("desert", "eggs", "nymphs", "visit"))

# plot boxplots, including KWtest letters
fitness_plot_dunn <- function(data, y, group, itero=F, multcompLetters, letterSize, ymax=160){
  if(itero==F){
    (p <- eval(substitute(data %>%
      filter(!females_removed, !is.na(group)) %>%
    ggplot(data = ., aes(x = group, y=y, fill=ants_removed, color=ants_removed)) + 
      ylim(-ymax * 0.05, ymax) + 
      geom_split_violin(color = NA, alpha = 0.5, key_glyph = draw_key_rect) + 
      geom_point(position = position_jitterdodge(jitter.width = 0.08, dodge.width = 0.3), 
                 pch = 16, size = 2, key_glyph = draw_key_rect) + 
      xlab("Guarding strategy for first clutch") + theme_publilia() + 
      scale_fill_manual(labels = c("Control", "Ant exclusion"), values = c("brown1", "black")) + 
      scale_color_manual(labels = c("Control", "Ant exclusion"),  values = c("brown1", "black")) +
      geom_text(data = multcompLetters, 
                aes(x = x, y = -ymax * 0.05, label = label), 
                fontface = "bold", size = letterSize, position=position_dodge(width=0.5)))))
    return(p)
  } else {
    # single-clutch females
    (p_semel <- eval(substitute(data %>%
      filter(!females_removed, !is.na(group),
             (n_clutches_with_eggs_iv==1)) %>%
        ggplot(data = ., aes(x = group, y=y, fill=ants_removed, color=ants_removed)) + 
          ylim(-ymax * 0.05, ymax) + 
          geom_split_violin(color = NA, alpha = 0.5, key_glyph = draw_key_rect) + 
          geom_point(position = position_jitterdodge(jitter.width = 0.08, dodge.width = 0.3), 
                     pch = 16, size = 2, key_glyph = draw_key_rect) + 
          xlab("Guarding strategy for first clutch") + theme_publilia() + 
          scale_fill_manual(labels = c("Control", "Ant exclusion"), values = c("brown1", "black")) + 
          scale_color_manual(labels = c("Control", "Ant exclusion"),  values = c("brown1", "black")) +
          geom_text(data = multcompLetters, 
                    aes(x = x, y = -ymax * 0.05, label = label), 
                    fontface = "bold", size = letterSize, position=position_dodge(width=0.5)))))
    # multi-clutch females
     (p_itero <- eval(substitute(data %>%
      filter(!females_removed, !is.na(group),
             (n_clutches_with_eggs_iv>1)) %>%
        ggplot(data = ., aes(x = group, y=y, fill=ants_removed, color=ants_removed)) + 
          ylim(-ymax * 0.05, ymax) + 
          geom_split_violin(color = NA, alpha = 0.5, key_glyph = draw_key_rect) + 
          geom_point(position = position_jitterdodge(jitter.width = 0.08, dodge.width = 0.3), 
                     pch = 16, size = 2, key_glyph = draw_key_rect) + 
          xlab("Guarding strategy for first clutch") + theme_publilia() + 
          scale_fill_manual(labels = c("Control", "Ant exclusion"), values = c("brown1", "black")) + 
          scale_color_manual(labels = c("Control", "Ant exclusion"),  values = c("brown1", "black")) +
          geom_text(data = multcompLetters, 
                    aes(x = x, y = -ymax * 0.05, label = label), 
                    fontface = "bold", size = letterSize, position=position_dodge(width=0.5)))))
    p_list<-list(semel=p_semel, itero=p_itero)
    return(p_list)
  }
}

# test
# fitness_life_strats_data <- est_fitness_life_strats %>%
#   mutate(desert_cat_ants = ifelse(ants_removed,
#                                   paste(desert_cat,"ants removed"),paste(desert_cat,"control")))
# eggs_fitness_stats <- fitness_KW_test(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat_ants)
# 
# fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat_ants,
#                   itero=F, multcompLetters=eggs_fitness_stats$multcompLetters,
#                   letterSize=8)
```


## Not separating single-clutch and multi-clutch females (for main)
```{r}
letterSize<-3

fitness_life_strats_data <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs"),
         desert_cat_ants = ifelse(ants_removed, 
                                 paste(desert_cat,"ants removed"),paste(desert_cat,"control")),
         desert_cat_ants = factor(desert_cat_ants,
          levels=c("visit control", "desert control", "eggs control","nymphs control",
                   "visit ants removed", "desert ants removed", "eggs ants removed","nymphs ants removed")))

fitness_stats_eggs_v6 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat_ants)
fitness_stats_eggs_v6["multcompLetters"]$multcompLetters$x <- 
  factor(rep(c("visit", "desert","eggs", "nymphs"),2), levels=c("visit", "desert","eggs", "nymphs"))
fitness_stats_eggs_v6["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_eggs_v6["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_eggs_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat, 
                    itero=F, multcompLetters=fitness_stats_eggs_v6$multcompLetters,
                    letterSize=letterSize, ymax=160) +
  ylab("Lifetime fecundity\n(eggs laid)") + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank())


fitness_stats_hatched_v6 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_hatched_life_v6, group=desert_cat_ants)
fitness_stats_hatched_v6["multcompLetters"]$multcompLetters$x <- rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_hatched_v6["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_hatched_v6["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_hatched_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_hatched_life_v6, group=desert_cat, 
                    itero=F, multcompLetters=fitness_stats_hatched_v6$multcompLetters,
                    letterSize=letterSize, ymax=100) +
  ylab("Lifetime fitness\n(eggs hatched)") + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank())

fitness_stats_survived_v6 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_survived_life_v6, group=desert_cat_ants)
fitness_stats_survived_v6["multcompLetters"]$multcompLetters$x <- rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_survived_v6["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_survived_v6["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_survived_v6.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_survived_life_v6, group=desert_cat, 
                    itero=F, multcompLetters=fitness_stats_survived_v6$multcompLetters,
                    letterSize=letterSize, ymax=30) +
  ylab("Lifetime fitness\n(nymphs survived)") + 
  theme(legend.position=c(0.3,0.9))

fitness_stats.v6.p.final <-
  egg::ggarrange(fitness_stats_eggs_v6.p, fitness_stats_hatched_v6.p, fitness_stats_survived_v6.p,
                 labels=c("A","B","C"), ncol=1, nrow=3)

ggsave("fitness_stats.violin.final.png",
       fitness_stats.v6.p.final,
       device = "png",
       width = 120, height = 200, units = "mm", dpi = "print")
```

## Just offspring counts (no imputation)
```{r}
letterSize<-3

fitness_life_strats_data <- est_fitness_life_strats %>%
  mutate(desert_cat = fct_relevel(desert_cat, "visit", "desert", "eggs", "nymphs"),
         desert_cat_ants = ifelse(ants_removed, 
                                 paste(desert_cat,"ants removed"),paste(desert_cat,"control")),
         desert_cat_ants = factor(desert_cat_ants,
          levels=c("visit control", "desert control", "eggs control","nymphs control",
                   "visit ants removed", "desert ants removed", "eggs ants removed","nymphs ants removed")))

fitness_stats_eggs_v1 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat_ants)
fitness_stats_eggs_v1["multcompLetters"]$multcompLetters$x <- 
  factor(rep(c("visit", "desert","eggs", "nymphs"),2), levels=c("visit", "desert","eggs", "nymphs"))
fitness_stats_eggs_v1["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_eggs_v1["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_eggs_v1.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat, 
                    itero=F, multcompLetters=fitness_stats_eggs_v1$multcompLetters,
                    letterSize=letterSize, ymax=160) +
  ylab("Lifetime fecundity\n(eggs laid)") + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank())


fitness_stats_hatched_v1 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_hatched_life_v1, group=desert_cat_ants)
fitness_stats_hatched_v1["multcompLetters"]$multcompLetters$x <- rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_hatched_v1["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_hatched_v1["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_hatched_v1.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_hatched_life_v1, group=desert_cat, 
                    itero=F, multcompLetters=fitness_stats_hatched_v1$multcompLetters,
                    letterSize=letterSize, ymax=100) +
  ylab("Lifetime fitness\n(eggs hatched)") + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank())

fitness_stats_survived_v1 <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_survived_life_v1, group=desert_cat_ants)
fitness_stats_survived_v1["multcompLetters"]$multcompLetters$x <- rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_survived_v1["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_survived_v1["multcompLetters"]$multcompLetters, tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_survived_v1.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_survived_life_v1, group=desert_cat, 
                    itero=F, multcompLetters=fitness_stats_survived_v1$multcompLetters,
                    letterSize=letterSize, ymax=30) +
  ylab("Lifetime fitness\n(nymphs survived)") + 
  theme(legend.position=c(0.3,0.9))

fitness_stats.v1.p.final <-
  egg::ggarrange(fitness_stats_eggs_v1.p, fitness_stats_hatched_v1.p, fitness_stats_survived_v1.p,
                 labels=c("A","B","C"), ncol=1, nrow=3)

ggsave("fitness_stats.supp_v1.violin.final.png",
       fitness_stats.v1.p.final,
       device = "png",
       width = 120, height = 200, units = "mm", dpi = "print")
```

## Separating single-clutch and multi-clutch females (for main)
```{r}
letterSize<-3

fitness_life_strats_data.semel <- filter(fitness_life_strats_data, n_clutches_with_eggs_iv==1)
fitness_life_strats_data.itero <- filter(fitness_life_strats_data, n_clutches_with_eggs_iv>1)

fitness_stats_eggs.semel <- 
  fitness_KW_test(data=fitness_life_strats_data.semel, 
                  y=est_eggs_life, group=desert_cat_ants)
fitness_stats_eggs.semel["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_eggs.semel["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_eggs.semel["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_eggs.semel.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat, 
                    itero=T, multcompLetters=fitness_stats_eggs.semel$multcompLetters,
                    letterSize=letterSize, ymax=160)$semel +
  ylab("Single-clutch female\nfecundity (eggs laid)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank())

fitness_stats_eggs.itero <- 
  fitness_KW_test(data=fitness_life_strats_data.itero, 
                  y=est_eggs_life, group=desert_cat_ants)
fitness_stats_eggs.itero["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_eggs.itero["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_eggs.itero["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_eggs.itero.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat, 
                    itero=T, multcompLetters=fitness_stats_eggs.itero$multcompLetters,
                    letterSize=letterSize, ymax=160)$itero +
  ylab("Multi-clutch female\nfecundity (eggs laid)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank()) 


fitness_stats_hatched.semel <- 
  fitness_KW_test(data=fitness_life_strats_data.semel, 
                  y=est_hatched_life_v6, group=desert_cat_ants)
fitness_stats_hatched.semel["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_hatched.semel["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_hatched.semel["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_hatched.semel.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_hatched_life_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_stats_hatched.semel$multcompLetters,
                    letterSize=letterSize, ymax=100)$semel +
  ylab("Single-clutch female\nfitness (eggs hatched)") + 
    theme(legend.position=c(0.3,0.8), axis.title.x = element_blank(),axis.text.x=element_blank())

fitness_stats_hatched.itero <- 
  fitness_KW_test(data=fitness_life_strats_data.itero, 
                  y=est_hatched_life_v6, group=desert_cat_ants)
fitness_stats_hatched.itero["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_hatched.itero["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_hatched.itero["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_hatched.itero.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_hatched_life_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_stats_hatched.itero$multcompLetters,
                    letterSize=letterSize, ymax=100)$itero +
  ylab("Multi-clutch female\nfitness (eggs hatched)") + 
    theme(legend.position="none", axis.title.x = element_blank(),axis.text.x=element_blank()) 


fitness_stats_survived.semel <- 
  fitness_KW_test(data=fitness_life_strats_data.semel, 
                  y=est_survived_life_v6, group=desert_cat_ants)
fitness_stats_survived.semel["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_survived.semel["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_survived.semel["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_survived.semel.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_survived_life_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_stats_survived.semel$multcompLetters,
                    letterSize=letterSize, ymax=30)$semel +
  ylab("Single-clutch female\nfitness (nymphs survived)") + 
    theme(legend.position="none")

fitness_stats_survived.itero <- 
  fitness_KW_test(data=fitness_life_strats_data.itero, 
                  y=est_survived_life_v6, group=desert_cat_ants)
fitness_stats_survived.itero["multcompLetters"]$multcompLetters$x <- 
  rep(c("visit", "desert","eggs", "nymphs"),2)
fitness_stats_survived.itero["multcompLetters"]$multcompLetters <- 
  bind_cols(fitness_stats_survived.itero["multcompLetters"]$multcompLetters, 
            tibble(ants_removed = c(F,F,F,F,T,T,T,T)))

fitness_stats_survived.itero.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_survived_life_v6, group=desert_cat, 
                    itero=T, multcompLetters=fitness_stats_survived.itero$multcompLetters,
                    letterSize=letterSize, ymax=30)$itero +
  ylab("Multi-clutch female\nfitness (nymphs survived)") + 
    theme(legend.position="none") 

fitness_stats.parity.p.final <- egg::ggarrange(
  fitness_stats_eggs.semel.p, fitness_stats_eggs.itero.p,
  fitness_stats_hatched.semel.p, fitness_stats_hatched.itero.p,
  fitness_stats_survived.semel.p, fitness_stats_survived.itero.p,
  labels=c("A","B","C","D","E","F"), ncol=2, nrow=3)

ggsave("fitness_stats.violin.parity.final.png",
       fitness_stats.parity.p.final,
       device = "png",
       width = 200, height = 200, units = "mm", dpi = "print")
```


## Comparing to Zink 2003 fitness measures
Lifetime fitness (number of eggs that hatched):
w(t_i) = sum(from i=1, to i=N, P_i*g(t_i))
P = number of eggs invested in a clutch (all the eggs go to the initiator?)
t_i = guarding duration in clutch i
N = lifetime number of clutches
g(t) = relationship between guarding duration and hatching success
 (assume g(t) equivalent across all clutches 1 to N)
 
* The main reason Zink found equivalent fitness is that he attributed all the eggs in a clutch to each primary female. Thus an early deserter is given all the eggs from a clutch, even if she leaves within a few days and another female arrives and lays additional eggs.
```{r}
ggplot(data=filter(surv_reg_data_zink, initiation_date<=as_date("2019-06-10")), 
       aes(x=max_primary_dur, y=n_hatched/med_t5eggs)) +
  geom_point() +
  geom_smooth(method=lm)

zink_hatch.m <- surv_reg_data_zink %>%
  filter(initiation_date<=as_date("2019-06-10"), !is.na(n_hatched/med_t5eggs)) %>%
lm(n_hatched/med_t5eggs ~ max_primary_dur, data=.)

summary(zink_hatch.m) # use this for predicting hatching success
```

```{r}
zink_fitness_plot_dunn <- function(data, y, group, multcompLetters, letterSize, ymax=160){
  (p <- eval(substitute(data %>%
    filter(!females_removed, !is.na(desert_cat)) %>%
    ggplot(data=., aes(x=group, y=y)) + ylim(-ymax*0.05,ymax) +
    geom_boxplot(aes(fill=group), 
                 position = position_dodge(0.75), size = 1.5, key_glyph=draw_key_rect) +
    stat_summary(aes(fill=group), 
                 fun=mean, geom="point", shape=4, size=3, color="black", key_glyph=draw_key_rect) +
    #ylab("Lifetime fecundity\n(eggs laid)")  +
    xlab("Guarding strategy for first clutch") +
    theme_publilia() +
    geom_text(data=multcompLetters, aes(x=x, y=-ymax*0.05, label=label), fontface="bold", size=letterSize))))
  return(p)
}
```


```{r}
# v1: Zink 2003 attributes all egg in a clutch to the primary female, even if they desert early and a visitor laid additional eggs
zink_fitness_stats_v1 <- 
  fitness_KW_test(data=est_fitness_life_strats_Zink, y=zink_est_hatch_life_v1, group=zink_dur_cat)
(Zink_fitness_v1.p <- 
  zink_fitness_plot_dunn(data=est_fitness_life_strats_Zink, y=zink_est_hatch_life_v1, group=zink_dur_cat, 
                    multcompLetters=zink_fitness_stats_v1$multcompLetters,
                    letterSize=4, ymax=150) +
  ylab("Lifetime fitness: Zink 2003\n(all eggs to primary mother,\nlinear model predicts hatching)") +
    # geom_jitter(aes(fill=ants_removed), pch = 21, size=3, width=0.35) + 
    theme(legend.position="none",
          axis.text.x=element_text(angle=45, vjust=1, hjust=1)))

est_fitness_life_strats_Zink %>%
  filter(!females_removed, !is.na(desert_cat)) %>%
  group_by(zink_dur_cat) %>% 
    summarize(mean_fitness=mean(zink_est_hatch_life_v1),
              median_fitness=median(zink_est_hatch_life_v1))

# v2: all calculations the same, but give eggs to females in proportion to the time they spent at clutch relative to other females
zink_fitness_stats_v2 <- 
  fitness_KW_test(data=est_fitness_life_strats_Zink, y=zink_est_hatch_life_v2, group=zink_dur_cat)
(Zink_fitness_v2.p <- 
  zink_fitness_plot_dunn(data=est_fitness_life_strats_Zink, y=zink_est_hatch_life_v2, group=zink_dur_cat, 
                    multcompLetters=zink_fitness_stats_v2$multcompLetters,
                    letterSize=4, ymax=150) +
  ylab("Lifetime fitness: modified from Zink 2003\n(eggs proportional to guarding,\nlinear model predicts hatching)") +
    # geom_jitter(aes(fill=ants_removed), pch = 21, size=3, width=0.35) + 
    theme(legend.position="none",
          axis.text.x=element_text(angle=45, vjust=1, hjust=1)))

(Zink_fitness.p.final <- egg::ggarrange(
  Zink_fitness_v1.p, Zink_fitness_v2.p, 
  labels=c("A","B"),
  ncol=2, nrow=1))

ggsave("Zink_fitness.final.png",
       Zink_fitness.p.final,
       device = "png",
       width = 200, height = 120, units = "mm", dpi = "print")

# same but separating females that laid one vs. multiple clutches
zink_fitness_data.semel <- est_fitness_life_strats_Zink %>% 
  filter(n_clutches_with_eggs_iv==1)
zink_fitness_stats_v1.semel <- 
  fitness_KW_test(data=zink_fitness_data.semel, y=zink_est_hatch_life_v1, group=zink_dur_cat)
(Zink_fitness_v1.semel.p <- 
  zink_fitness_plot_dunn(data=zink_fitness_data.semel, y=zink_est_hatch_life_v1, group=zink_dur_cat, 
                    multcompLetters=zink_fitness_stats_v1.semel$multcompLetters,
                    letterSize=4, ymax=150) +
  ylab("Lifetime fitness: Zink 2003\n(all eggs to primary mother,\nlinear model predicts hatching)") +
    ggtitle("Single-clutch mothers") +
    # geom_jitter(aes(fill=ants_removed), pch = 21, size=3, width=0.35) + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank()))

zink_fitness_data.itero <- est_fitness_life_strats_Zink %>% 
  filter(n_clutches_with_eggs_iv>1)
zink_fitness_stats_v1.itero <- 
  fitness_KW_test(data=zink_fitness_data.itero, y=zink_est_hatch_life_v1, group=zink_dur_cat)
(Zink_fitness_v1.itero.p <- 
  zink_fitness_plot_dunn(data=zink_fitness_data.itero, y=zink_est_hatch_life_v1, group=zink_dur_cat, 
                    multcompLetters=zink_fitness_stats_v1.itero$multcompLetters,
                    letterSize=4, ymax=150) + ggtitle("Multi-clutch mothers") +
    # geom_jitter(aes(fill=ants_removed), pch = 21, size=3, width=0.35) + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank(),
          axis.title.y = element_blank(),axis.text.y=element_blank()))

zink_fitness_data.semel <- est_fitness_life_strats_Zink %>% 
  filter(n_clutches_with_eggs_iv==1)
zink_fitness_stats_v2.semel <- 
  fitness_KW_test(data=zink_fitness_data.semel, y=zink_est_hatch_life_v2, group=zink_dur_cat)
(Zink_fitness_v2.semel.p <- 
  zink_fitness_plot_dunn(data=zink_fitness_data.semel, y=zink_est_hatch_life_v2, group=zink_dur_cat, 
                    multcompLetters=zink_fitness_stats_v2.semel$multcompLetters,
                    letterSize=4, ymax=150) +
  ylab("Lifetime fitness: modified from Zink 2003\n(all eggs to primary mother,\nlinear model predicts hatching)") +
    # geom_jitter(aes(fill=ants_removed), pch = 21, size=3, width=0.35) + 
    theme(legend.position="none",
          axis.text.x=element_text(angle=45, vjust=1, hjust=1)))

zink_fitness_data.itero <- est_fitness_life_strats_Zink %>% 
  filter(n_clutches_with_eggs_iv>1)
zink_fitness_stats_v2.itero <- 
  fitness_KW_test(data=zink_fitness_data.itero, y=zink_est_hatch_life_v2, group=zink_dur_cat)
(Zink_fitness_v2.itero.p <- 
  zink_fitness_plot_dunn(data=zink_fitness_data.itero, y=zink_est_hatch_life_v2, group=zink_dur_cat, 
                    multcompLetters=zink_fitness_stats_v2.itero$multcompLetters,
                    letterSize=4, ymax=150) +
    # geom_jitter(aes(fill=ants_removed), pch = 21, size=3, width=0.35) + 
    theme(legend.position="none",
          axis.text.x=element_text(angle=45, vjust=1, hjust=1),
          axis.title.y = element_blank(),axis.text.y=element_blank()))

(Zink_fitness.parity.p.final <- egg::ggarrange(
  Zink_fitness_v1.semel.p, Zink_fitness_v1.itero.p,
  Zink_fitness_v2.semel.p, Zink_fitness_v2.itero.p,
  labels=c("A","B","C","D"),
  ncol=2, nrow=2))

ggsave("Zink_fitness.parity.final.png",
       Zink_fitness.parity.p.final,
       device = "png",
       width = 200, height = 200, units = "mm", dpi = "print")

```

why such a small first clutch and larger future clutches for early deserters? early deserters lay more or larger clutches?
```{r}
est_fitness_life_strats_Zink %>%
  filter(!females_removed) %>%
  mutate(parity=ifelse(n_clutches_with_eggs_iv==1,"semel","itero")) %>%
  count(parity,zink_dur_cat)

est_fitness_life_strats_Zink %>%
  filter(!females_removed) %>%
  mutate(parity=ifelse(n_clutches_with_eggs_iv==1,"semel","itero")) %>%
  group_by(zink_dur_cat,parity) %>%
  summarize(n=n(),
            mean_n_clutches=mean(n_clutches_with_eggs_iv),
            mean_max_primary_dur=mean(max_primary_dur)) %>%
  ungroup()

est_fitness_life_strats_Zink %>%
  filter(!females_removed) %>%
  mutate(parity=ifelse(n_clutches_with_eggs_iv==1,"semel","itero")) %>%
  group_by(desert_cat,parity) %>%
  summarize(n=n(),
            mean_n_clutches=mean(n_clutches_with_eggs_iv),
            mean_max_primary_dur=mean(max_primary_dur)) %>%
  ungroup()

fitness_life_strats_data %>%
  filter(!females_removed) %>%
  mutate(parity=ifelse(n_clutches_with_eggs_iv==1,"semel","itero")) %>%
  group_by(parity, ants_removed, desert_cat) %>%
  summarize(n=n(),
            mean_n_clutches=mean(n_clutches_with_eggs_iv)) %>%
  ungroup()
  
```


## Clutch fitness prediction performance for imputation
```{r}
# Consistency is ok worse for hatching; MANY clutches with no surviving nymphs were predicted to have survived
(predicted_clutch_A <- est_fitness_clutch %>% 
  filter(!is.na(est_hatched_clutch_v1),!is.na(est_hatched_clutch_v6)) %>%
  ggplot(data=., aes(x=est_hatched_clutch_v1, y=est_hatched_clutch_v6, color=interaction(vis,ants))) +
  geom_abline(slope=1) +
  geom_point() + xlim(0,80) + ylim(0,80) +
  theme(legend.position="none"))

# Consistency is MUCH worse for survivorship; MANY clutches with no surviving nymphs were predicted to have survived
(predicted_clutch_B <- est_fitness_clutch %>%
  filter(!is.na(est_survived_clutch_v1),!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=est_survived_clutch_v1, y=est_survived_clutch_v6, color=interaction(vis,ants))) +
  geom_abline(slope=1) +
  geom_point()  + xlim(0,60) + ylim(0,60) +
  theme(legend.position=c(0.3,0.8)))

(predicted_clutch.p.final <- egg::ggarrange(
  predicted_clutch_A, predicted_clutch_B,
  labels=c("A","B"),
  ncol=2, nrow=1))
 
ggsave("predicted_clutch.final.png",
       predicted_clutch.p.final,
       device = "png",
       width = 200, height = 100, units = "mm", dpi = "print")
```


### Life fitness prediction performance for imputation
Should I include this in the supplment?
```{r}
# hatching: ok correspondence, the spread is tighter, but range is preserved
(predicted_clutch_A <- est_fitness_clutch %>% 
  filter(!is.na(est_hatched_clutch_v1),!is.na(est_hatched_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_hatched_clutch_v1, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth(span=1) + ylim(0,60) +
   xlab("Desertion date relative to hatch\non first clutch") + 
   ylab("Clutch-level fitness\n(hatched eggs observed)") + 
   scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
   scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
   theme(legend.position="none",
         axis.text.x=element_text(angle=45, vjust=1, hjust=1),
         strip.background = element_blank()) +
  facet_wrap(vars(vis)))

(predicted_clutch_B <-est_fitness_clutch %>% 
  filter(!is.na(est_hatched_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_hatched_clutch_v6, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth(span=1) + ylim(0,60) +
   xlab("Desertion date relative to hatch\non first clutch") + 
   ylab("Clutch-level fitness\n(hatched eggs predicted by model)") + 
   scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
   scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
    theme(legend.position="none",
         axis.text.x=element_text(angle=45, vjust=1, hjust=1),
         strip.background = element_blank()) +
  facet_wrap(vars(vis)))

# survival: ok correspondence, the spread is MUCH tighter and range is more limited; losing many higher values
(predicted_clutch_C <- est_fitness_clutch %>% 
  filter(!is.na(est_survived_clutch_v1),!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_survived_clutch_v1, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth(span=1) + ylim(0,60) +
    xlab("Desertion date relative to hatch\non first clutch") + 
   ylab("Clutch-level fitness\n(surviving nymphs observed)") + 
   scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
   scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
    theme(legend.position="none",
         axis.text.x=element_text(angle=45, vjust=1, hjust=1),
         strip.background = element_blank()) +
  facet_wrap(vars(vis)))

(predicted_clutch_D <-est_fitness_clutch %>% 
  filter(!is.na(est_survived_clutch_v6)) %>%
  ggplot(data=., aes(x=des, y=est_survived_clutch_v6, color=ants, fill=ants)) +
  geom_point() +
  geom_smooth(span=1) + ylim(0,60) +
    xlab("Desertion date relative to hatch\non first clutch") + 
   ylab("Clutch-level fitness\n(hatched eggs predicted by model)") + 
   scale_fill_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
   scale_color_manual(labels=c("Control","Ants removed"), values=c("brown1", "gray50")) +
    theme(legend.position=c(0.75,0.75),
         axis.text.x=element_text(angle=45, vjust=1, hjust=1),
         strip.background = element_blank()) +
  facet_wrap(vars(vis)))

(predicted_clutch.p.final <- egg::ggarrange(
  predicted_clutch_A, predicted_clutch_B,
  predicted_clutch_C, predicted_clutch_D,
  labels=c("A","B","C","D"),
  ncol=2, nrow=2))
 
ggsave("predicted_clutch.final.png",
       predicted_clutch.p.final,
       device = "png",
       width = 200, height = 200, units = "mm", dpi = "print")
```

### Estimating fitness from counts instead of from survivorship function
```{r}
# fitness_life_strats_data <- fitness_life_strats_data %>%
#   mutate(desert_cat_ants = factor(desert_cat_ants, levels=c("desert control", "eggs control", 
#                                 "nymphs control", "visit control",
#                                 "desert ants removed", "eggs ants removed", 
#                                 "nymphs ants removed", "visit ants removed")))

fitness_stats_eggs_counted <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat_ants)
(fitness_counted_stats_eggs.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_eggs_life, group=desert_cat_ants, 
                    itero=F, multcompLetters=fitness_stats_eggs_counted$multcompLetters,
                    letterSize=4, ymax=160) +
  ylab("Lifetime fecundity\n(eggs laid)") + 
    theme(legend.position="none",
          axis.title.x = element_blank(),axis.text.x=element_blank()))

fitness_stats_hatched_counted <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_hatched_life_v1, group=desert_cat_ants)
(fitness_counted_stats_hatched.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_hatched_life_v1, group=desert_cat_ants, 
                    itero=F, multcompLetters=fitness_stats_hatched_counted$multcompLetters,
                    letterSize=4, ymax=75) +
  ylab("Lifetime fitness\n(eggs hatched)") + 
    theme(legend.position=c(0.75,0.9),
          axis.title.x = element_blank(),axis.text.x=element_blank()))

fitness_stats_survived_counted <- 
  fitness_KW_test(data=fitness_life_strats_data, y=est_survived_life_v1, group=desert_cat_ants)
(fitness_counted_stats_survived.p <- 
  fitness_plot_dunn(data=fitness_life_strats_data, y=est_survived_life_v1, group=desert_cat_ants, 
                    itero=F, multcompLetters=fitness_stats_survived_counted$multcompLetters,
                    letterSize=4, ymax=30) +
  ylab("Lifetime fitness\n(nymphs survived)") + 
    theme(legend.position="none",
          axis.text.x=element_text(angle=45, vjust=1, hjust=1)))

(fitness_counted_stats.p.final <- egg::ggarrange(
  fitness_counted_stats_eggs.p,
  fitness_counted_stats_hatched.p,
  fitness_counted_stats_survived.p,
  labels=c("A","B","C"),
  ncol=1, nrow=3))

# ggsave("CHAPTER/fitness_counted_stats.final.png",
#        fitness_counted_stats.p.final,
#        device = "png",
#        width = 120, height = 200, units = "mm", dpi = "print")
```





