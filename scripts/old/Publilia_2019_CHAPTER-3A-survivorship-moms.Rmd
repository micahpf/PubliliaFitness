---
title: "Publilia_2019_CHAPTER-3A-survivorship-moms"
author: "micah fletcher"
date: "1/18/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Publilia 2019 Chapter - Script 3A: survivorship - clutch-level
This is meant to consolidate previous scripts and provide a readable and reproducible record of the analyses for the Publilia Chapter.

3) *Clutch-level survivorship regressions:* The impact of care on offspring survivorship depends on ants and offspring stage
  - *Dataset D [survivorship ~ guarding duration]* requirements:
    - Guarding durations (relative to [estimated] hatching) are accurate.
    - (Clutch-level) Hatching success is accurate.
    - Number of eggs is accurate.
    - Must exclude clutches where migration to/from other leaves obscured nymph count.
      - This biases the results toward only including clutches alone on a plant, while clearly it is common to have multiple clutches on a plant. One way to address this is to compare to plant-level analysis, so I may reuse parts of this pipeline for the plant-level analysis.
    - (Clutch-level) Nymph survivorship is accurate.
    - Must exclude clutches where migration to/from other leaves obscured nymph count. This biases the results in the same way as above.
    - Main analysis on first clutches laid before June 10. 
    - But also report on [] in the supplement.
      - the full dataset
      - single-female clutches only
      - female-removal included vs. excluded
    - Missing data is clearly represented; Compare the "original" unfiltered data to the final data and report why (and how many) data were excluded.
  - *Dataset E [clutch survivorship ~ ants]* requirements:
    - Same as Dataset B but also need a representative measure of ant attendance intensity/persistence, e.g.:
      - percent days attended before hatch
      - mean/median number of ants before hatch
      - number of days it took for ants to appear at clutch after hatch
      - Note: these would ideally be comparable to plant-level metrics

# 0 - Data import
```{r}
library(gt)
library(gtsummary)
library(flextable)
theme_gtsummary_compact()
```


# 1 - Data prep

## 1.0 - Assigning nymph origins
Nymphs migrate away from their natal leaf. On plants with multiple clutches, it was sometimes possible to determine the origin of nymphs later in the season because sometimes groups of nymph don't travel very far from their natal leaf and mix with other groups. I manually curated examples of this, so that clutch-level stats on hatching success and nymph survivorship could be determined on the plants with multiple clutches. Some clutches (as a rule only on multi-clutch plants) did not have a clear record of nymphs that emigrated from the natal leaf and thus could not be included in future clutch-level analyses of survivorship.

## 1.1 - Adding second gen adult counts per leaf to clutch status stats
```{r}
# counting adults
eA_status_v1 <- All_data_v6 %>%
  group_by(row_number()) %>% # sum of newly exclosed adults
  filter(any(!is.na(c(New_eA, Old_eA)))) %>%
  mutate(n_newA = ifelse(is.na(New_eA),
                         NA,
                         sum(as.numeric(regmatches(New_eA, gregexpr("[0-9]+", New_eA))[[1]]))),
         n_oldA = ifelse(is.na(Old_eA),
                         NA,
                         sum(as.numeric(regmatches(Old_eA, gregexpr("[0-9]+", Old_eA))[[1]]))),
         n_A = sum(n_newA, n_oldA, na.rm = TRUE)) %>%
  ungroup() %>%
  select(Date, location, n_newA, n_oldA, n_A)

All_data_v6_clutch_status_stats_v2 <- All_data_v6 %>%
  # add egg measures, clutch status stats (including initiation dates, hatch dates, egg fate, etc)
  left_join(clutch_status_v2, by = c("location", "Date")) %>%
  left_join(clutch_status_stats_v1, by = c("location")) %>%
  left_join(eA_status_v1, by = c("Date", "location")) %>%
  left_join(select(clutch_status_guarding_summary_v2, location, never_hatched)) %>%
  mutate(N1 = as.numeric(N1),
         N2 = as.numeric(N2),
         N5 = as.numeric(N5))
```

## 1.2 - Manually check nymph origins for revision
First create a table of all entried from clutches that were not flagged in the field as having ambiguous origin (e.g. "leaf 6 or 9") in cases were more than one clutch was on the plant. These were revised manually to specify a leaf of origin for the nymphs, where possible.
```{r}
NOr_status_resolveable_all_unambig_clutches <- All_data_v6_clutch_status_stats_v2 %>% 
  select(Date, Dorm, Plant, Leaf, location, 
         egg_num, N1, N2, N5, n_A, nymph_origin, initiation_date, hatch_date,
         any_NOr_ambig_loc, Omit_for_abandon_time, never_hatched,
         n_clutches_on_plant) %>%
  # keep only entries with some nymphs or adults on a leaf
  # OR entries for leaves where clutches have been initiated
  group_by(row_number()) %>%
  filter(!is.na(Leaf) & any(N1 > 0, N2 > 0, N5 > 0, n_A > 0) | 
           Date >= initiation_date) %>% # nrow = 17944
  # flag entries where the nymph origin is text (typically ambiguous, e.g. "8 or 9")
  mutate(NOr_ambig_entry = !is.na(nymph_origin) & is.na(as.numeric(nymph_origin))) %>% 
  ungroup() %>%
  # get rid of duplicate rows from multiple females in the same location
  distinct(Date, location, .keep_all = TRUE) %>% # nrow = 15674
  group_by(Dorm, Plant) %>%
    # filter out any plants with a clutch that was omitted for abandon time
    filter(!any(!is.na(Omit_for_abandon_time))) %>%
    # flag plants with any ambiguous entries (e.g. "8 or 9") skip for checking
    mutate(NOr_ambig_plant = any(NOr_ambig_entry)) %>%
  ungroup()

NOr_status_resolveable_mult_clutches <- NOr_status_resolveable_all_unambig_clutches %>% # nrow = 15674
  group_by(Dorm, Plant) %>%
    # plants with mutliple clutches only
    filter(any(n_clutches_on_plant > 1)) %>%
  ungroup() %>%
  group_by(row_number()) %>%
    # flag for manual checking entries with any nymphs/adults, missing nymph origin, 
    # but not flagged for ambiguous origin in the field.
    # these are the most likely to be easily resolved with minimal work
    mutate(revise_NOr = ifelse(any(N1 > 0, N2 > 0, N5 > 0, n_A > 0) &
             !NOr_ambig_plant,
           "MANUAL CHECK",
           NA)) %>% 
  ungroup()

NOr_manual_check_table <- NOr_status_resolveable_mult_clutches %>%
  group_by(Dorm, Plant) %>%
    filter(any(revise_NOr == "MANUAL CHECK")) %>% # nrow = 2830
  ungroup() %>%
    group_by(row_number()) %>%
    filter(any(N1 > 0, N2 > 0, N5 > 0, n_A > 0)) %>%
  ungroup() %>%
  select(Date, Dorm, Plant, Leaf, location, egg_num, N1, N2, N5, n_A, nymph_origin,
         initiation_date, hatch_date,
         revise_NOr) %>%
  arrange(Dorm, as.numeric(Plant), as.numeric(Leaf), Date)
# 83 clutches on 34 plants to check

# write_csv(NOr_manual_check_table %>% filter(revise_NOr == "MANUAL CHECK"), "NOr_manual_check_tmp.csv")

NOr_manual_revisions <- read_xlsx(in_filename, sheet = "NOr_manual_check", col_types = c("date", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "logical", "text")) %>%
  mutate(Date = as_date(Date),
         NOr_rev_loc_manual = paste0(Dorm, Plant, "_", NOr_revised)) %>%
  filter(!cant_resolve) %>%
  select(Date, location, NOr_rev_loc_manual, NOr_revised_manual = NOr_revised)

NOr_manual_revisions %>%
  distinct(NOr_rev_loc_manual) # 43/83 initiated clutches (43/59 hatched) with successfully revised NOr
```

## 1.3 - Implement revisions by creating the new variables NOr_revised and NOr_rev_loc
```{r}
# if nymph origin was clearly resolveable, the revisions were made in NOr_manual_revisions
# updating NOr_status with revisions so that it can be left_joined to other data and
# counts of nymphs and adults on NOr can be calculated
NOr_status_revised_all_unambig_clutches <- NOr_status_resolveable_all_unambig_clutches %>%
  left_join(NOr_manual_revisions, by = c("Date", "location")) %>%
  group_by(Dorm, Plant) %>%
    mutate(lone_hatcher_leaf = ifelse(length(unique(Leaf[!is.na(initiation_date)])) == 1,
                                 unique(Leaf[!is.na(initiation_date)]),
                                 NA),
           NOr_revised = ifelse(!is.na(NOr_revised_manual),
                                       NOr_revised_manual,
                                ifelse(any(!is.na(lone_hatcher_leaf)),
                                       lone_hatcher_leaf,
                                       # if no clutches hatched on the plant, NOr_revised = Leaf
                                       # for leaves with eggs
                                       ifelse(!any(!is.na(hatch_date)) & !is.na(egg_num),
                                              Leaf,
                                              NA)))) %>%
  ungroup() %>%  
  group_by(location) %>%
    mutate(NOr_revised = ifelse(any(NOr_revised == Leaf) & is.na(NOr_revised),
                                Leaf,#unique(NOr_revised[!is.na(NOr_revised)]),
                                NOr_revised)) %>%
  ungroup() %>%
  mutate(NOr_rev_loc = ifelse(is.na(NOr_revised),
                              NA,
                              paste0(Dorm, Plant, "_", NOr_revised))) %>%
  select(Date, location, NOr_revised, NOr_rev_loc) %>%
  filter(!is.na(NOr_rev_loc))

All_data_v6_N_NOr_counts_unambig_clutches <- All_data_v6_clutch_status_stats_v2 %>%
  right_join(NOr_status_revised_all_unambig_clutches, by = c("Date", "location")) %>%
  group_by(Date, Dorm, Plant, NOr_revised, NOr_rev_loc) %>%
    summarize(N1_NOr = sum(N1, na.rm= TRUE),
              N2_NOr = sum(N2, na.rm= TRUE),
              N5_NOr = sum(N5, na.rm= TRUE),
              N_NOr = sum(N1, N2, N5, na.rm = TRUE),
              A_NOr = sum(n_A, na.rm= TRUE),
              N5plusA_NOr = sum(N5, n_A, na.rm= TRUE)) %>%
  ungroup() # n = 186
 
# All_data_v6_N_NOr_counts_unambig_clutches %>% distinct(Dorm, Plant, NOr_rev_loc) # n = 186

All_data_v6_N_NOr_counts_unambig_clutches_summary <- All_data_v6_N_NOr_counts_unambig_clutches %>%
  group_by(Date) %>%
    mutate(mean_N_NOr = mean(N_NOr, na.rm = TRUE),
           mean_N1_NOr = mean(N1_NOr, na.rm = TRUE),
           mean_N2_NOr = mean(N2_NOr, na.rm = TRUE),
           mean_N5_NOr = mean(N5_NOr, na.rm = TRUE),
           mean_A_NOr = mean(A_NOr, na.rm = TRUE),
           mean_N5plusA_NOr = mean(N5plusA_NOr, na.rm = TRUE),
           All_N_NOr = sum(N_NOr),
           All_A_NOr = sum(A_NOr)) %>%
  ungroup() %>%
  group_by(Date, Dorm) %>%
    mutate(All_N_NOr_Dorm = sum(N_NOr),
           All_N1_NOr_Dorm = sum(N1_NOr),
           All_N2_NOr_Dorm = sum(N2_NOr),
           All_N5_NOr_Dorm = sum(N5_NOr),
           All_A_NOr_Dorm = sum(sum(A_NOr))) %>%
  ungroup()

ggplot(data = All_data_v6_N_NOr_counts_unambig_clutches_summary) +
  geom_boxplot(aes(x = Date, y = N_NOr, group = Date)) +
  geom_line(aes(x = Date, y = mean_N_NOr), color = "red")

ggplot(data = All_data_v6_N_NOr_counts_unambig_clutches_summary) +
  geom_line(aes(x = Date, y = mean_N_NOr), color = "black") +
  geom_line(aes(x = Date, y = mean_N1_NOr), color = "green") +  
  geom_line(aes(x = Date, y = mean_N2_NOr), color = "blue") +
  geom_line(aes(x = Date, y = mean_N5_NOr), color = "purple") +
  geom_line(aes(x = Date, y = mean_A_NOr), color = "pink") +
  geom_line(aes(x = Date, y = mean_N5plusA_NOr), color = "red")

ggplot(data = All_data_v6_N_NOr_counts_unambig_clutches_summary) +
  geom_line(aes(x = Date, y = All_N_NOr), color = "black")

ggplot(data = All_data_v6_N_NOr_counts_unambig_clutches_summary) +
  geom_line(aes(x = Date, y = All_N_NOr_Dorm, color = Dorm))

All_data_v6_all_nymphs_unambig_clutches <- All_data_v6_N_NOr_counts_unambig_clutches %>%
  group_by(Date) %>%
    summarize(All_N_NOr = sum(N_NOr)) %>%
  ungroup()

ggplot(data = All_data_v6_all_nymphs_unambig_clutches) +
  geom_line(aes(x = Date, y = All_N_NOr), color = "black")

All_data_v6_max_N_NOr_counts_unambig_clutches <-
  All_data_v6_N_NOr_counts_unambig_clutches %>%
  group_by(Dorm, Plant, NOr_revised, NOr_rev_loc) %>%
    summarize(max_N_NOr = max(N_NOr)) %>%
  ungroup()
  
clutch_status_stats_v1_unambig_clutches_hatch_success <- clutch_status_stats_v1 %>%
  separate(location, c("DormPlant", "Leaf"), sep = "_", remove = FALSE) %>%
  mutate(Dorm = substr(DormPlant, 1, 1),
         Plant = substring(DormPlant, 2)) %>%
  left_join(distinct(clutch_status_guarding_summary_v2, location, never_hatched)) %>%
  right_join(All_data_v6_max_N_NOr_counts_unambig_clutches, by = c("Dorm", "Plant", "Leaf" = "NOr_revised")) %>%
  # why did I originally say to make hatch_success = NA if never_hatched == TRUE?
  mutate(hatch_success = ifelse(!is.na(initiation_date) & is.na(hatch_date),
                                0,
                                max_N_NOr/max_egg_num))
```

Is 190/ really the best we can do for the sample size of clutches with known hatching success?
```{r}
clutch_status_guarding_summary_v2 %>%
# add number of clutches per plant
  separate(location, c("DormPlant", "Leaf"), "_", remove = FALSE) %>%
  mutate(Dorm = substr(DormPlant, 1,1),
         Plant = substring(DormPlant, 2)) %>%
  distinct(location, n_clutches_on_plant, initiation_date, any_NOr_ambig_loc) %>%
  group_by(n_clutches_on_plant == 1, initiation_date <= as_date("2019-06-10"), any_NOr_ambig_loc) %>%
  summarize(N = n()) %>%
  ungroup()

# there are 319 unique clutches with known inits that have not been flagged for ambig nymph origin in the field
clutch_status_guarding_summary_v2 %>%
# add number of clutches per plant
  separate(location, c("DormPlant", "Leaf"), "_", remove = FALSE) %>%
  mutate(Dorm = substr(DormPlant, 1,1),
         Plant = substring(DormPlant, 2)) %>%
  distinct(location, n_clutches_on_plant, initiation_date, any_NOr_ambig_loc) %>%
  group_by(!is.na(initiation_date), any_NOr_ambig_loc) %>%
  summarize(N = n()) %>%
  ungroup()


NOr_status_resolveable_all_unambig_clutches <- All_data_v6_clutch_status_stats_v2 %>% 
  select(Date, Dorm, Plant, Leaf, location, 
         egg_num, N1, N2, N5, n_A, nymph_origin, initiation_date, hatch_date,
         any_NOr_ambig_loc, Omit_for_abandon_time, never_hatched,
         n_clutches_on_plant) %>%
  # keep only entries with some nymphs or adults on a leaf
  # OR entries for leaves where clutches have been initiated
  group_by(row_number()) %>%
  filter(!is.na(Leaf) & any(N1 > 0, N2 > 0, N5 > 0, n_A > 0) | 
           Date >= initiation_date) %>% # nrow = 17944
  # flag entries where the nymph origin is text (typically ambiguous, e.g. "8 or 9")
  mutate(NOr_ambig_entry = !is.na(nymph_origin) & is.na(as.numeric(nymph_origin))) %>% 
  ungroup() %>%
  # get rid of duplicate rows from multiple females in the same location
  distinct(Date, location, .keep_all = TRUE) %>% # nrow = 15674
  group_by(Dorm, Plant) %>%
    # filter out any plants with a clutch that was omitted for abandon time
    filter(!any(!is.na(Omit_for_abandon_time))) %>%
    # flag plants with any ambiguous entries (e.g. "8 or 9") skip for checking
    mutate(NOr_ambig_plant = any(NOr_ambig_entry)) %>%
  ungroup()

NOr_status_resolveable_all_unambig_clutches %>% 
  filter(!is.na(initiation_date)) %>% 
  distinct(location) # 314

NOr_status_resolveable_mult_clutches <- NOr_status_resolveable_all_unambig_clutches %>% # nrow = 15674
  group_by(Dorm, Plant) %>%
    # plants with mutliple clutches only
    filter(any(n_clutches_on_plant > 1)) %>%
  ungroup() %>%
  group_by(row_number()) %>%
    # flag for manual checking entries with any nymphs/adults, missing nymph origin, 
    # but not flagged for ambiguous origin in the field.
    # these are the most likely to be easily resolved with minimal work
    mutate(revise_NOr = ifelse(any(N1 > 0, N2 > 0, N5 > 0, n_A > 0) &
             !NOr_ambig_plant,
           "MANUAL CHECK",
           NA)) %>% 
  ungroup()

NOr_status_resolveable_mult_clutches %>%
  filter(!is.na(initiation_date)) %>%
  distinct(location, revise_NOr) %>%
  group_by(revise_NOr) %>%
  summarize(n())

############## looking at what clutches are NOT included in hatch success data
clutch_status_stats_v1 %>%
  separate(location, c("DormPlant", "Leaf"), sep = "_", remove = FALSE) %>%
  mutate(Dorm = substr(DormPlant, 1, 1),
         Plant = substring(DormPlant, 2)) %>%
  left_join(distinct(clutch_status_guarding_summary, location, never_hatched)) %>%
  full_join(All_data_v6_max_N_NOr_counts_unambig_clutches, by = c("Dorm", "Plant", "Leaf" = "NOr_revised")) %>%
  # why are so many "never_hatched" NA?
  mutate(hatch_success = ifelse(is.na(hatch_date),
                                0,
                                max_N_NOr/max_egg_num)) %>%
  group_by(Dorm, Plant) %>%
  mutate(any_NOr_ambig_loc_Plant = any(any_NOr_ambig_loc)) %>%
  ungroup() %>%
  filter(is.na(hatch_success), !any_NOr_ambig_loc_Plant) %>% View()


hatch_success_tmp1 <- clutch_status_stats_v1 %>%
  separate(location, c("DormPlant", "Leaf"), sep = "_", remove = FALSE) %>%
  mutate(Dorm = substr(DormPlant, 1, 1),
         Plant = substring(DormPlant, 2)) %>%
  left_join(distinct(clutch_status_guarding_summary_v2, location, never_hatched)) %>%
  full_join(All_data_v6_max_N_NOr_counts_unambig_clutches, by = c("Dorm", "Plant", "Leaf" = "NOr_revised")) %>%
  # why are so many "never_hatched" NA?
  mutate(hatch_success = ifelse(!is.na(initiation_date) & is.na(hatch_date),
                                0,
                                max_N_NOr/max_egg_num))

# hatch_success_tmp1 %>%
#   filter(!is.na(hatch_success), initiation_date <= as_date("2019-06-10")) %>% View()

ggplot(data = filter(hatch_success_tmp1, initiation_date <= as_date("2019-06-10"))) +
  geom_histogram(aes(x = hatch_success))

```

```{r}
# Fixing the omission of clutches that never had first instar nymphs
NOr_status_revised_all_unambig_clutches_v2 <- NOr_status_resolveable_all_unambig_clutches %>%
  left_join(NOr_manual_revisions, by = c("Date", "location")) %>%
  group_by(Dorm, Plant) %>%
    mutate(lone_hatcher_leaf = ifelse(length(unique(Leaf[!is.na(initiation_date)])) == 1,
                                 unique(Leaf[!is.na(initiation_date)]),
                                 NA),
           NOr_revised = ifelse(!is.na(NOr_revised_manual), # if I manually annotated a revised location
                                       NOr_revised_manual, # make manual location the new nymph origin
                                ifelse(any(!is.na(lone_hatcher_leaf)), # if only one clutch hatched on the plant
                                       lone_hatcher_leaf, # make that clutch the new nymph origin
                                       # if no clutches hatched on the plant, NOr_revised = Leaf
                                       # for leaves with eggs
                                       ifelse(!any(!is.na(hatch_date)) & !is.na(egg_num), # if no clutches hatched on the plant (but there are eggs)
                                              Leaf, # make the given leaf the new nymph origin
                                              NA)))) %>% # BUT THIS STILL EXCLUDES CLUTCHES THAT DIDN'T HATCH ON A PLANT WITH SOME CLUTCHES THAT DID HATCH
  ungroup() %>%  
  group_by(location) %>%
    mutate(NOr_revised = ifelse(any(NOr_revised == Leaf) & is.na(NOr_revised), # DOES THIS INCLUDE UNHATCHED CLUTCHES? NO
                                Leaf,#unique(NOr_revised[!is.na(NOr_revised)]),
                                NOr_revised),
           NOr_revised = ifelse(any(is.na(NOr_revised)) & # if no revised nymph origin yet
                                                  any(!is.na(egg_num)&egg_num>0 & !any(!is.na(N1)&N1>0)), # and N1 never on clutch (not hatched or spuriously visited by N1)
                                Leaf, # make this leaf the new nymph origin (so we include unhatched clutches)
                                NOr_revised)) %>% 
  ungroup() %>%
  mutate(NOr_rev_loc = ifelse(is.na(NOr_revised),
                              NA,
                              paste0(Dorm, Plant, "_", NOr_revised))) %>%
  select(Date, location, NOr_revised, NOr_rev_loc) %>%
  filter(!is.na(NOr_rev_loc))

All_data_v6_N_NOr_counts_unambig_clutches_v2 <- All_data_v6_clutch_status_stats_v2 %>%
  right_join(NOr_status_revised_all_unambig_clutches_v2, by = c("Date", "location")) %>%
  group_by(Date, Dorm, Plant, NOr_revised, NOr_rev_loc) %>%
    summarize(N1_NOr = sum(N1, na.rm= TRUE),
              N2_NOr = sum(N2, na.rm= TRUE),
              N5_NOr = sum(N5, na.rm= TRUE),
              N_NOr = sum(N1, N2, N5, na.rm = TRUE),
              A_NOr = sum(n_A, na.rm= TRUE),
              N5plusA_NOr = sum(N5, n_A, na.rm= TRUE)) %>%
  ungroup() # n = 186
 
# All_data_v6_N_NOr_counts_unambig_clutches %>% distinct(Dorm, Plant, NOr_rev_loc) # n = 186


All_data_v6_N_NOr_counts_unambig_clutches_summary_v2 <- All_data_v6_N_NOr_counts_unambig_clutches_v2 %>%
  group_by(Date) %>%
    mutate(mean_N_NOr = mean(N_NOr, na.rm = TRUE),
           mean_N1_NOr = mean(N1_NOr, na.rm = TRUE),
           mean_N2_NOr = mean(N2_NOr, na.rm = TRUE),
           mean_N5_NOr = mean(N5_NOr, na.rm = TRUE),
           mean_A_NOr = mean(A_NOr, na.rm = TRUE),
           mean_N5plusA_NOr = mean(N5plusA_NOr, na.rm = TRUE),
           All_N_NOr = sum(N_NOr),
           All_A_NOr = sum(A_NOr)) %>%
  ungroup() %>%
  group_by(Date, Dorm) %>%
    mutate(All_N_NOr_Dorm = sum(N_NOr),
           All_N1_NOr_Dorm = sum(N1_NOr),
           All_N2_NOr_Dorm = sum(N2_NOr),
           All_N5_NOr_Dorm = sum(N5_NOr),
           All_A_NOr_Dorm = sum(sum(A_NOr))) %>%
  ungroup()

```

Calculate hatch success (strict sense; max N1 / max eggs) and nymph survivorship (max N5+A / max eggs AND/OR max N5+A / max N1)
- Filtered out clutches with outlier numbers of N1 or N5 etc at early or late clutch ages, which were assumed to be cases of immigration that weren't caught during manual nymph origin filtering
```{r}
# Filter to only include curated list of clutches with unambiguous nymph counts after accounting for immigration to non-natal leaves and then sum all nymphs (including emigrants) for each clutch
# I also added clutch_age variables to help identify clutches that were started too close to the end of sampling to be useful
clutch_unambig_NOr_revised_ENAa_summary_v2 <- All_data_v6_clutch_status_stats_v2 %>%
  right_join(NOr_status_revised_all_unambig_clutches_v2, by = c("Date", "location")) %>%
  select(Date, NOr_rev_loc, location, egg_num, N1, N2, N5, n_A, ants_L) %>%
    # remove any duplicates - I need to figure out why there are dups later but for 4th yr talk
  distinct(Date, NOr_rev_loc, location, egg_num, N1, N2, N5, n_A, ants_L, .keep_all = TRUE) %>%
  mutate(egg_num_NOr = ifelse(NOr_rev_loc == location, egg_num, NA)) %>%
  group_by(Date, NOr_rev_loc) %>%
    summarize(eggs_NOr = first(egg_num_NOr[!is.na(egg_num_NOr)]), # only use eggs from origin leaf!
              N1_NOr = sum(N1, na.rm= TRUE),
              N2_NOr = sum(N2, na.rm= TRUE),
              N5_NOr = sum(N5, na.rm= TRUE),
              N_NOr = sum(N1, N2, N5, na.rm = TRUE),
              A_NOr = sum(n_A, na.rm= TRUE),
              N5toA_NOr = sum(N5, n_A, na.rm= TRUE),
              ants_NOr = sum(ants_L, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(filter(clutch_status_guarding_summary_v2, mom_at_init), by = c("NOr_rev_loc" = "location")) %>%
  mutate(clutch_age1 = Date - initiation_date,
         clutch_age2 = ceiling((Date - initiation_date)/2)*2,
         clutch_age4 = ceiling((Date - initiation_date)/4)*4,
         after_hatch1 = Date - hatch_date,
         after_hatch2 = ceiling((Date - hatch_date)/2)*2,
         after_hatch4 = ceiling((Date - hatch_date)/4)*4) %>%
  select(Date, NOr_rev_loc, clutch_age1, after_hatch1, eggs_NOr, 
         N1_NOr, N2_NOr, N5_NOr, N_NOr, A_NOr, N5toA_NOr, ants_NOr,
         init_fem = Female_ID,
         initiation_date, hatch_date, guard_duration, relative_desert_date,
         clutch_initiated_order, females_removed, ants_removed, 
         clutch_age2, clutch_age4, after_hatch2, after_hatch4) #%>%
  # filter(initiation_date <= as_date("2019-06-10"),
  #        clutch_age4 <= 68)

max_N1_date_v2 <- clutch_unambig_NOr_revised_ENAa_summary_v2 %>%
  group_by(NOr_rev_loc) %>%
  arrange(NOr_rev_loc, desc(N1_NOr), Date) %>%
  filter(row_number() == 1) %>%
  ungroup() %>%
  select(NOr_rev_loc, max_N1_date = Date, max_N1_age = clutch_age1)

max_N5_date_v2 <- clutch_unambig_NOr_revised_ENAa_summary_v2 %>%
  group_by(NOr_rev_loc) %>%
  arrange(NOr_rev_loc, desc(N5_NOr), Date) %>%
  filter(row_number() == 1) %>%
  ungroup() %>%
  select(NOr_rev_loc, max_N5_date = Date, max_N5_age = clutch_age1)

max_A_date_v2 <- clutch_unambig_NOr_revised_ENAa_summary_v2 %>%
  group_by(NOr_rev_loc) %>%
  arrange(NOr_rev_loc, desc(A_NOr), Date) %>%
  filter(row_number() == 1) %>%
  ungroup() %>%
  select(NOr_rev_loc, max_A_date = Date, max_A_age = clutch_age1)

max_N5toA_date_v2 <- clutch_unambig_NOr_revised_ENAa_summary_v2 %>%
  group_by(NOr_rev_loc) %>%
  arrange(NOr_rev_loc, desc(N5toA_NOr), Date) %>%
  filter(row_number() == 1) %>%
  ungroup() %>%
  select(NOr_rev_loc, max_N5toA_date = Date, max_N5toA_age = clutch_age1)

max_N5toA_Date_v2 <- clutch_unambig_NOr_revised_ENAa_summary_v2 %>%
  group_by(NOr_rev_loc) %>%
  summarize(max_N1 = max(N1_NOr),
            max_N5toA = max(N5toA_NOr),
            max_clutch_age = max(clutch_age1),
            max_after_hatch = max(after_hatch1),
            max_Date = max(Date),
            hatched = any(!is.na(hatch_date)),
            initiation_date = first(initiation_date)) %>%
  ungroup() %>%
  arrange(desc(max_N5toA)) %>%
  full_join(max_N1_date_v2) %>%
  full_join(max_N5_date_v2) %>%
  full_join(max_A_date_v2) %>%
  full_join(max_N5toA_date_v2)

ggplot(data = max_N5toA_Date_v2) +
  geom_point(aes(x = initiation_date, y = max_N5toA_age))

ggplot(data = max_N5toA_Date_v2) +
  geom_point(aes(x = initiation_date, y = max_N1_age))

ggplot(data = max_N5toA_Date_v2) +
  geom_point(aes(x = initiation_date, y = max_N5_age))

ggplot(data = max_N5toA_Date_v2) +
  geom_point(aes(x = initiation_date, y = max_A_age))

ggplot(data = max_N5toA_Date_v2) +
  geom_point(aes(x = max_clutch_age, y = max_N1, 
                 color = initiation_date >= as_date("2019-06-10"))) 

ggplot(data = max_N5toA_Date_v2) +
  geom_point(aes(x = initiation_date, y = max_N1)) 

ggplot(data = max_N5toA_Date_v2) +
  geom_point(aes(x = max_clutch_age, y = max_N5toA, 
                 color = initiation_date >= as_date("2019-06-10"))) 

ggplot(data = max_N5toA_Date_v2) +
  geom_point(aes(x = initiation_date, y = max_N5toA)) 

clutch_unambig_NOr_revised_ENAa_summary_imfilt_v2 <- clutch_unambig_NOr_revised_ENAa_summary_v2 %>%
  mutate(N_imm_likely_d15 = clutch_age1 < 15 & N_NOr > 0,
         N5_imm_likely_d40 = clutch_age1 < 40 & N5_NOr > 0,
         A_imm_likely_d40 = clutch_age1 < 40 & A_NOr > 0) %>%
  group_by(NOr_rev_loc) %>%
    filter(!any(N_imm_likely_d15, N5_imm_likely_d40, A_imm_likely_d40, na.rm = TRUE)) %>% # n = 168
  ungroup()
          
clutch_unambig_NOr_revised_ENAa_summary_imfilt_success_v2 <-
  clutch_unambig_NOr_revised_ENAa_summary_imfilt_v2 %>%
  group_by(NOr_rev_loc) %>%
    mutate(hatch_success_N1 = max(N1_NOr, na.rm = TRUE)/max(eggs_NOr, na.rm = TRUE),
           survival_rate = max(N5toA_NOr, na.rm = TRUE)/max(eggs_NOr, na.rm = TRUE),
           prop_E2Ni = max(N1_NOr, na.rm = TRUE)/max(eggs_NOr, na.rm = TRUE),
           prop_E2N = max(N_NOr, na.rm = TRUE)/max(eggs_NOr, na.rm = TRUE),
           prop_Ni2Nv = max(N5toA_NOr, na.rm = TRUE)/max(N1_NOr, na.rm = TRUE),
           prop_E2Nv = max(N5toA_NOr, na.rm = TRUE)/max(eggs_NOr, na.rm = TRUE),
           n_eggs = max(eggs_NOr, na.rm = TRUE),
           n_hatched = max(N1_NOr, na.rm = TRUE),
           n_N = max(N_NOr, na.rm = TRUE),
           n_survived = max(N5toA_NOr, na.rm = TRUE)) %>%
  ungroup()

clutch_unambig_NOr_revised_ENAa_summary_imfilt_success_summary_v2 <- clutch_unambig_NOr_revised_ENAa_summary_imfilt_success_v2 %>%
  distinct(NOr_rev_loc, n_eggs, n_hatched, n_survived, n_N,
           prop_E2Ni, prop_Ni2Nv, prop_E2Nv, prop_E2N, hatch_success_N1, survival_rate,
           initiation_date, hatch_date, females_removed, ants_removed) 
```

# Ant counts on clutch; some ants_removed clutches were visited by ants, and vice versa
```{r}
ant_counts <- All_data_v6 %>%
  left_join(select(visited_1st_4d_data, location, initiation_date, est_hatch, ants_removed, females_removed)) %>%
  filter(!is.na(initiation_date)) %>%
  distinct(Date,location,ants_removed,females_removed,initiation_date,est_hatch,ants_L,ants_P) %>%
  group_by(location) %>%
    mutate(b4h=Date>=initiation_date&Date<est_hatch,
           afh=Date>=est_hatch) %>%
    summarize(ants_removed=first(ants_removed),
              females_removed=first(females_removed),
              n_antsP=sum(ants_P,na.rm=T),
              ever_antsP=n_antsP>0,
              mean_antsP=mean(ants_P,na.rm=T),
              med_antsP=median(ants_P,na.rm=T),
              
              n_antsP_b4h=sum(ants_P&b4h),
              ever_antsP_b4h=n_antsP_b4h>0,
              mean_antsP_b4h=mean(ifelse(b4h,ants_P,NA),na.rm=T),
              med_antsP_b4h=median(ifelse(b4h,ants_P,NA),na.rm=T),
              
              n_antsP_afh=sum(ants_P&afh),
              ever_antsP_afh=n_antsP_afh>0,
              mean_antsP_afh=mean(ifelse(afh,ants_P,NA),na.rm=T),
              med_antsP_afh=median(ifelse(afh,ants_P,NA),na.rm=T)) %>%
  ungroup() %>%
  mutate(Dorm=substr(location,1,1),
         ant_treatment=ifelse(ants_removed,"Ants removed","Control"))

ggplot(data=ant_counts,aes(x=Dorm,y=n_antsP, fill=ant_treatment)) +
  geom_boxplot()

ggplot(data=ant_counts,aes(x=Dorm,y=mean_antsP, fill=ant_treatment)) +
  geom_boxplot()

ggplot(data=ant_counts,aes(x=Dorm,y=mean_antsP_b4h, fill=ant_treatment)) +
  geom_boxplot()

ggplot(data=ant_counts,aes(x=Dorm,y=mean_antsP_afh, fill=ant_treatment)) +
  geom_boxplot()

ant_counts %>%
  count(Dorm,ant_treatment,ever_antsP)

ant_counts %>%
  count(Dorm,ant_treatment,ever_antsP_b4h)

ant_counts %>%
  count(Dorm,ant_treatment,ever_antsP_afh)

# how many clutches ever had ants in each of the dorms?
ant_counts %>%
  ggplot(data=., aes(y=as.numeric(ever_antsP), x=Dorm, fill=ant_treatment)) +
  stat_summary(fun="mean", geom = "bar", position = position_dodge(0.9)) +
  stat_summary(fun.data="mean_se", geom = "errorbar",position = position_dodge(0.9), width = 0.2) +
  stat_summary(fun.data="n", geom = "text", position = position_dodge(0.9)) +
  theme_publilia()

ant_counts %>%
  ggplot(data=., aes(y=as.numeric(ever_antsP_b4h), x=Dorm, fill=ant_treatment)) +
  stat_summary(fun="mean", geom = "bar", position = position_dodge(0.9)) +
  stat_summary(fun.data="mean_se", geom = "errorbar",position = position_dodge(0.9), width = 0.2) +
  stat_summary(fun.data="n", geom = "text", position = position_dodge(0.9)) +
  theme_publilia()

ant_counts %>%
  ggplot(data=., aes(y=as.numeric(ever_antsP_afh), x=Dorm, fill=ant_treatment)) +
  stat_summary(fun="mean", geom = "bar", position = position_dodge(0.9)) +
  stat_summary(fun.data="mean_se", geom = "errorbar",position = position_dodge(0.9), width = 0.2) +
  stat_summary(fun.data="n", geom = "text", position = position_dodge(0.9)) +
  theme_publilia()

# how extreme was the break-through?
ant_counts %>%
  ggplot(data=., aes(x=mean_antsP_b4h, color=ant_treatment, linetype=females_removed, group=Dorm)) +
  geom_freqpoly(bins=100)

ant_counts %>%
  ggplot(data=., aes(x=med_antsP_b4h, color=ant_treatment, linetype=females_removed, group=Dorm)) +
  geom_freqpoly()

ant_counts %>%
  ggplot(data=., aes(x=mean_antsP_afh, color=ant_treatment, linetype=females_removed, group=Dorm)) +
  geom_freqpoly(bins=100)

ant_counts %>%
  ggplot(data=., aes(x=med_antsP_afh, color=ant_treatment, linetype=females_removed, group=Dorm)) +
  geom_freqpoly()

# how many clutches actually ever had ants vs. not?
ant_counts %>%
  ggplot(data=., aes(x=ever_antsP_b4h, fill=ant_treatment)) +
  geom_bar() +
  theme_publilia() + facet_wrap(~females_removed)

ant_counts %>%
  ggplot(data=., aes(x=ever_antsP_afh, fill=ant_treatment)) +
  geom_bar() +
  theme_publilia() + facet_wrap(~females_removed)

ant_counts %>%
  ggplot(data=., aes(x=ever_antsP_b4h|ever_antsP_afh, fill=ant_treatment)) +
  geom_bar() +
  theme_publilia() + facet_wrap(~females_removed)

```

Should I be more lenient with my threshold, so I can have more even sample sizes between "ants" and "no ants"?
- ants_ever = n_days_ants>0: F = 95-12=83, T = 234-91=143
- antsP_gt2d = n_days_ants>2: F = 156-33=123, T = 173-70=103 * most even sample size
- antsP_gt3d = n_days_ants>3: F = 172-39=133, T = 157-64=90
```{r}
ant_n_days <- All_data_v6 %>%
  left_join(select(visited_1st_4d_data, location, initiation_date, est_hatch, ants_removed, females_removed)) %>%
  filter(!is.na(initiation_date)) %>%
  distinct(Date,location,ants_removed,females_removed,initiation_date,est_hatch,ants_L,ants_P) %>%
  mutate(ant_treatment=ifelse(ants_removed,"Ants removed","Control"),
         Dorm=substr(location,1,1)) %>%
  group_by(Date, location) %>%
    summarize(any_antsP_day = any(ants_P>0, na.rm=T),
              females_removed = first(females_removed),
              ant_treatment = first(ant_treatment),
              Dorm = first(Dorm)) %>%
  ungroup() %>%
  group_by(location) %>%
    summarize(n_days_ants = sum(as.numeric(any_antsP_day)),
              females_removed = first(females_removed),
              ant_treatment = first(ant_treatment),
              Dorm = first(Dorm))%>%
  ungroup() %>%
  mutate(antsP_gt2d = !is.na(n_days_ants)&n_days_ants>2,
         antsP_gt3d = !is.na(n_days_ants)&n_days_ants>3,
         ants_everP = is.na(n_days_ants)|n_days_ants>0)
  
ggplot(ant_n_days, aes(x=Dorm, y=n_days_ants, fill=ant_treatment)) +
  geom_boxplot()

ggplot(ant_n_days, aes(x=Dorm, y=n_days_ants, fill=ant_treatment)) +
  geom_violin() +
  geom_hline(yintercept=2.5)

ant_n_days %>%
  select(-location) %>%
  tbl_summary(by=ants_everP)

ant_n_days %>%
  select(-location) %>%
  tbl_summary(by=antsP_gt2d)

ant_n_days %>%
  select(-location) %>%
  tbl_summary(by=antsP_gt3d)
```


# 2 - egg survivorship ~ guarding duration * ants_removed * `visited in 4 days`

`The sum of all females’ egg-guarding durations was more predictive of final clutch size than egg guarding duration of the initiator alone (Table S1 with alternative models and their AICs), showing that females lay eggs while visiting existing clutches.`
```{r}
visited_1st_4d_data_tb
visited_1st_4d_data_tb %>% filter(!is.na(initiation_date))
visited_1st_4d_data_tb %>% filter(!is.na(initiation_date), !is.na(num_at_init))

##### initiator guarding time: mDb4h
initiator_days_b4hatch <- visited_1st_4d_data_tb %>%
  filter(!is.na(initiation_date),
         # exclude clutches for which the initiators are not known
         !is.na(num_at_init),
         mom_at_init) %>%
  group_by(row_number()) %>%
  # Use median init to hatch interval (20 days) to est hatch date of clutch with no hatch date
  mutate(init_dur = ifelse(min(est_hatch, visit_ends) - 
                                       max(initiation_date, visit_starts) >= 0,
                           visit_ends-initiation_date+1, 
                           NA),
         initMb4hatch = ifelse(min(est_hatch, visit_ends) - 
                                       max(initiation_date, visit_starts) >= 0,
           min(est_hatch, visit_ends) - 
           max(initiation_date, visit_starts) + 1,
           ifelse(visit_starts > est_hatch | visit_ends < initiation_date,
                  NA,
                  NA)),
         initMb4h_sc2h = initMb4hatch/as.numeric((est_hatch-initiation_date+1))) %>%
  ungroup()

initMb4h_tbL <- initiator_days_b4hatch %>%
  filter(initL) %>%
  select(location, desert_rel2hL=est_rel2h, init_durL=init_dur, initMb4h_tbL=initMb4hatch, initMb4h_sc2hL=initMb4h_sc2h,
         females_removed, ants_removed, initiation_date, num_at_init,
         initiator_tbL=Female_ID, n_clutches_on_plant)

initMb4h_tbS <- initiator_days_b4hatch %>%
  filter(initS) %>%
  select(location, desert_rel2hS=est_rel2h, init_durS=init_dur, initMb4h_tbS=initMb4hatch, initMb4h_sc2hS=initMb4h_sc2h,
         females_removed, ants_removed, initiation_date, num_at_init,
         initiator_tbS=Female_ID, n_clutches_on_plant)

##### proportional time: mDb4h
focalMb4h_sc2h <- visited_1st_4d_data_tb  %>%
  # exclude visits to leaves that never had eggs; only interested in clutches
  filter(!is.na(initiation_date),
         # exclude clutches for which the initiators are not known (why?)
         !is.na(num_at_init)) %>%
  group_by(row_number()) %>%
  # Use median init to hatch interval (20 days) to est hatch date of clutch with no hatch date
  mutate(mD = ifelse(min(est_hatch, visit_ends) - 
                                       max(initiation_date, visit_starts) >= 0,
                     visit_ends-initiation_date+1,
                     NA),
         days_guard_b4hatch = ifelse(min(est_hatch, visit_ends) - 
                                       max(initiation_date, visit_starts) >= 0,
           min(est_hatch, visit_ends) - 
           max(initiation_date, visit_starts) + 1,
           ifelse(visit_starts > est_hatch | visit_ends < initiation_date,
                  NA,
                  NA)),
         focalMb4h_sc2h = days_guard_b4hatch/as.numeric((est_hatch-initiation_date+1))) %>%
  ungroup()

clutch_momDays_b4h <- focalMb4h_sc2h %>%
  group_by(location) %>%
    summarize(sum_mD = sum(mD, na.rm=T),
              sum_vD = sum(mD*!mom_at_init, na.rm=T),
              sum_gD = sum(mD*mom_at_init, na.rm=T),
              vDb4h_sc2h = sum(days_guard_b4hatch*!mom_at_init, na.rm = T)/
                # scale to init-hatch interval so clutches with different intervals are comparable 
                as.numeric(first(est_hatch)-first(initiation_date)+1),
              gDb4h_sc2h = sum(days_guard_b4hatch*mom_at_init, na.rm = T)/
                as.numeric((first(est_hatch)-first(initiation_date)+1)),
              mDb4h_sc2h = sum(days_guard_b4hatch, na.rm = T)/
                as.numeric((first(est_hatch)-first(initiation_date)+1))) %>%
  ungroup()

clutch_status_momDays_b4h <- visited_1st_4d_data_tb %>%
  distinct(location, initiation_date, hatch_date, num_at_init,
           females_removed, ants_removed, egg_fate, egg_fate_date,
           max_egg_num, max_egg_len, `visited in 4 days`) %>%
  right_join(clutch_momDays_b4h, by=c("location")) %>%
  left_join(top5eggs_summary)

#### latest desertion
latest_desertions <- visited_1st_4d_data %>%
  filter(!is.na(initiation_date),
         !(visit_ends<initiation_date), # visits that end before initiation are irrelevant
         !(visit_starts>est_hatch+4)) %>% # there are a few cases where clutches are visited long after hatching, which wouldn't affect hatching success
  left_join(first_visit_cuts) %>%
  select(Female_ID:visit_ends, initiation_date, est_hatch, est_rel2h, 
         `visited in 4 days`, mom_at_init, ants_removed, females_removed) %>%
  group_by(location) %>%
  filter(any(mom_at_init)) %>% # remove any clutches where there was no apparent mother at initiation
  summarize(last_des_rel2h = max(ifelse(visit_starts<=initiation_date, est_rel2h, NA), na.rm=T),
            first_des_rel2h_init = min(ifelse(mom_at_init, est_rel2h, NA), na.rm=T),
            last_desert = ifelse(last_des_rel2h>=-2, "after hatch",
                                 ifelse(last_des_rel2h<=0, "before hatch", NA)),
            females_removed = first(females_removed),
            ants_removed = first(ants_removed),
            `visited in 4 days` = first(`visited in 4 days`),
            init_desert_early = ifelse(first(first_des_rel2h_init<=-16), "deserted early", "didn't desert early"),
            est_hatch = first(est_hatch)) %>%
  ungroup() #%>%
  # filter(!is.na(`visited in 4 days`)) %>% # E40_9 for some reason didn't get a valid visited in 4 days entry
  # filter(location!="A23_8") %>% # A23_8 has two moms at init but for some reason not `visited in 4 days`?


#### combine the three (but after getting more comfortable with the "latest_desertions" results I can omit the initL/S for simplicity)
clutch_egg_num_data <- latest_desertions %>%
  left_join(initMb4h_tbL) %>%
  left_join(initMb4h_tbS) %>%
  separate(location, sep = "_", into = c("DormPlant"),  remove = FALSE, extra = "drop") %>%
  left_join(select(clutch_status_momDays_b4h, location, sum_mD, sum_vD, sum_gD,
                   mDb4h_sc2h, gDb4h_sc2h, vDb4h_sc2h, max_egg_num, max_egg_len,
                   `visited in 4 days`)) %>%
  # if tbL and tbS are not the same female, add the female that lost the tie-break to the total sum of visit days
  mutate(sum_vD_initL = ifelse(initiator_tbL!=initiator_tbS,
                           sum_vD+init_durS, sum_vD),
         sum_vD_initS = ifelse(initiator_tbS!=initiator_tbL,
                           sum_vD+init_durL, sum_vD),
         visited = vDb4h_sc2h > 0,
         pmDvD = vDb4h_sc2h/mDb4h_sc2h) %>%
  left_join(top5eggs_summary) %>%
  select(location, last_des_rel2h, first_des_rel2h_init,
         ants_removed, females_removed, initiation_date, est_hatch, `visited in 4 days`,
         sum_mD, sum_vD, sum_gD, mDb4h_sc2h,
         num_at_init, init_desert_early, last_desert,
         n_eggs = max_egg_num, med_t5eggs, mean_t5eggs, max_n_eggs,
         max_egg_len, med_l_t5eggs, mean_l_t5eggs, max_l_eggs,
         init_durL, init_durS, desert_rel2hL, desert_rel2hS,
         sum_vD_initL, sum_vD_initS, initMb4h_sc2hL, initMb4h_sc2hS,
         initiator_tbL, initiator_tbS,
         n_clutches_on_plant, visited, pmDvD, DormPlant)

# add filtered and curated nymph and adult counts
clutch_survivorship_data <- clutch_egg_num_data %>%
  left_join(select(clutch_unambig_NOr_revised_ENAa_summary_imfilt_success_summary_v2,
                   -c(ants_removed, females_removed, initiation_date, n_eggs)),
            by=c("location"="NOr_rev_loc"))

# older version so I can compare
clutch_egg_num_success_data_old <- initMb4h_tbL %>%
  left_join(initMb4h_tbS) %>%
  separate(location, sep = "_", into = c("DormPlant"),  remove = FALSE, extra = "drop") %>%
  left_join(select(clutch_status_momDays_b4h, location, mDb4h_sc2h, gDb4h_sc2h, vDb4h_sc2h, max_egg_num)) %>%
  mutate(visited = vDb4h_sc2h > 0,
         pmDvD = vDb4h_sc2h/mDb4h_sc2h) %>%
  # left_join(select(pDaysb4h_ants_moms, location, anyMb4h)) %>%
  # left_join(select(clutch_status_uDur_b4h, location, uDur_norm)) %>%
  # select(location, initMb4h_sc2hL, initMb4h_sc2hS, desert_rel2hL, desert_rel2hS, mDb4h_sc2h,
  #        anyMb4h, uDur_norm, females_removed, ants_removed, initiation_date, num_at_init, 
  #        n_eggs = max_egg_num, initiator_tbL, initiator_tbS, n_clutches_on_plant, 
  #        visited, visited_early, pmDvD, DormPlant) %>%
  left_join(select(clutch_unambig_NOr_revised_ENAa_summary_imfilt_success_summary_v2, 
                   -females_removed, -ants_removed, -initiation_date, -n_eggs), by=c("location"="NOr_rev_loc"))
  # filter(initiation_date <= as_date("2019-06-10"), n_hatched/n_eggs <= 0.80)

```

## Quick plots before I start modeling
Note that there is a much steeper slope for hatching success for females forcibly removed than for control, suggesting that females are somehow aware of when deserting early is inconsequential.

Note that most of the late-season clutches do not pass the filtering and curation steps for n_hatched/n_eggs, and a few fewer were valid for n_survived/n_hatched
```{r}
clutch_survivorship_data %>%
  ggplot(data=., aes(x=n_hatched/n_eggs)) +
  geom_histogram()

clutch_survivorship_data %>%
  ggplot(data=., aes(x=n_hatched/med_t5eggs)) +
  geom_histogram()

clutch_survivorship_data %>%
  ggplot(data=., aes(x=n_survived/n_hatched)) +
  geom_histogram()

clutch_survivorship_data %>%
  ggplot(data=., aes(x=initiation_date, fill=!is.na(n_hatched/n_eggs))) +
  geom_histogram()

clutch_survivorship_data %>%
  ggplot(data=., aes(x=initiation_date, fill=!is.na(n_survived/n_hatched))) +
  geom_histogram()

clutch_survivorship_data %>%
  ggplot(data=., aes(y=n_hatched/n_eggs, x=last_des_rel2h)) +
  geom_point() +
  geom_smooth(method=lm)

# n_hatched/n_eggs
clutch_survivorship_data %>%
  ggplot(data=., aes(y=n_hatched/n_eggs, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm)

clutch_survivorship_data %>%
  ggplot(data=., aes(y=n_hatched/n_eggs, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(females_removed))

# n_hatched/med_t5eggs
clutch_survivorship_data %>%
  ggplot(data=., aes(y=n_hatched/med_t5eggs, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm)

clutch_survivorship_data %>%
  ggplot(data=., aes(y=n_hatched/med_t5eggs, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(females_removed))

# n_hatched/med_t5eggs comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_hatched/med_t5eggs, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(`visited in 4 days`)) +
  ggtitle("intercept higher for clutches that were visited early, but only for ants?")

# n_hatched/med_t5eggs comparing early vs. late season
clutch_survivorship_data %>% filter(!is.na(initiation_date)) %>% # 2 points
  ggplot(data=., aes(y=n_hatched/med_t5eggs, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(initiation_date > as_date("2019-06-15"))) +
  ggtitle("not really enough valid data in late season for comparison")

# n_survived/n_hatched
clutch_survivorship_data %>%
  ggplot(data=., aes(y=n_survived/n_hatched, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm)

clutch_survivorship_data %>%
  ggplot(data=., aes(y=n_survived/n_hatched, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(females_removed)) +
  ggtitle("intercept higher for clutches with females removed, but only for ants!")

# n_survived/n_hatched comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_survived/n_hatched, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(`visited in 4 days`)) +
  ggtitle("intercept higher for clutches that were visited early, but only for ants!")


# n_hatched/med_t5eggs comparing `visited in 4 days`*females_removed
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_hatched/med_t5eggs, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(`visited in 4 days`, females_removed)) +
  ggtitle("Intercept of hatching success higher if visited early, but only if females not removed?")

# n_survived/n_hatched comparing `visited in 4 days`*females_removed
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_survived/n_hatched, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(`visited in 4 days`, females_removed)) +
  ggtitle("Survivorship higher for females that were visited before being removed, but only if ants present
          suggests that early-visits lead to larger clutches that can attract ants better.
          Survivorship also higher for early-visited females that were not removed, only if ants present.")

##### Egg-number on survivorship
# n_hatched/med_t5eggs comparing `visited in 4 days`*females_removed
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_hatched/med_t5eggs, x=med_t5eggs, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(`visited in 4 days`, females_removed))

# n_hatched/med_t5eggs comparing `visited in 4 days`*females_removed
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_survived/n_hatched, x=med_t5eggs, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(`visited in 4 days`, females_removed)) +
  ggtitle("Strong effect of clutch size on nymph survivorship for unvisited, removed females with ants;
          but no effect if visited...
          and no effect if female not removed")

# # There appear to be 3 outliers with hatch success > 1 and 1 with slightly higher than 1
# clutch_hatch_success_data_filt <- clutch_egg_num_success_data_filt %>%
#   filter(!is.na(prop_E2Ni)) %>%
#   filter(initiation_date <= as_date("2019-06-10"), n_hatched/n_eggs <= 1)
```

*Focus on recreating these two figures with negative binomial regression.*
The first shows that longer guarding improves hatching success in unvisited females, especially when ants are present, and that when females are visited, hatching success intercept increases and guarding remains helpful for clutches with ants but hatching success does not improve for females without ants.

The second shows that nymph survivorship is improved by guarding only in the absence of ants, but that if females are visited early with ants their intercept of nymph survivorship improves dramatically, allowing them to desert early with the same nymph survivorship as attended or unattended females that stayed long after hatching.
```{r} 
# n_hatched/med_t5eggs comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_hatched/med_t5eggs, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(`visited in 4 days`)) +
  ggtitle("intercept higher for clutches that were visited early, but only for ants?")

# n_survived/n_hatched comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_survived/n_hatched, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(`visited in 4 days`)) +
  ggtitle("intercept higher for clutches that were visited early, but only for ants!")

```

Same thing but filtering out later season clutches, which we can't reliably determine survival to adulthood (because E->A is about 45-75 days, mean=60)
```{r}
date_cutoff <- as_date("2019-06-10")

clutch_survivorship_data %>%
  count(females_removed, ants_removed, !is.na(n_hatched/med_t5eggs)) %>%
  filter(`!is.na(n_hatched/med_t5eggs)`)

clutch_survivorship_data %>%
  filter(initiation_date<=date_cutoff) %>%
  count(females_removed, ants_removed, !is.na(n_hatched/med_t5eggs)) %>%
  filter(`!is.na(n_hatched/med_t5eggs)`)

clutch_survivorship_data %>%
  count(females_removed, ants_removed, !is.na(n_survived/n_hatched)) %>%
  filter(`!is.na(n_survived/n_hatched)`)

clutch_survivorship_data %>%
  filter(initiation_date<=date_cutoff) %>%
  count(females_removed, ants_removed, !is.na(n_survived/n_hatched)) %>%
  filter(`!is.na(n_survived/n_hatched)`)

clutch_survivorship_data %>%
  count(females_removed, ants_removed, !is.na(n_survived/med_t5eggs)) %>%
  filter(`!is.na(n_survived/med_t5eggs)`)

clutch_survivorship_data %>%
  filter(initiation_date<=date_cutoff) %>%
  count(females_removed, ants_removed, !is.na(n_survived/med_t5eggs)) %>%
  filter(`!is.na(n_survived/med_t5eggs)`)

# n_hatched/med_t5eggs comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_hatched/med_t5eggs, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  #facet_wrap(vars(`visited in 4 days`)) +
  ggtitle("unfilt")

# n_hatched/med_t5eggs comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  filter(initiation_date<=date_cutoff) %>%
  ggplot(data=., aes(y=n_hatched/med_t5eggs, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  #facet_wrap(vars(`visited in 4 days`)) +
  ggtitle("initiation_date<=date_cutoff")

# n_survived/n_hatched comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_survived/n_hatched, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  #facet_wrap(vars(`visited in 4 days`)) +
  ggtitle("unfilt")

# n_survived/n_hatched comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  filter(initiation_date<=date_cutoff) %>%
  ggplot(data=., aes(y=n_survived/n_hatched, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  #facet_wrap(vars(`visited in 4 days`)) +
  ggtitle("initiation_date<=date_cutoff")

# n_survived/n_hatched comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_survived/med_t5eggs, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  #facet_wrap(vars(`visited in 4 days`)) +
  ggtitle("unfilt")

# n_survived/n_hatched comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  filter(initiation_date<=date_cutoff) %>%
  ggplot(data=., aes(y=n_survived/med_t5eggs, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  #facet_wrap(vars(`visited in 4 days`)) +
  ggtitle("initiation_date<=date_cutoff")

```

Can we account for the high survivorship based on ant arrival times?
```{r}
# n_survived/n_hatched comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  left_join(ant_data) %>%
  filter(initiation_date<=date_cutoff) %>%
  ggplot(data=., aes(y=n_survived/med_t5eggs, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(~(antL_arrival_afh<=4)) +
  ggtitle("antL_arrival_afh<=4")

# n_survived/n_hatched comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  left_join(ant_data) %>%
  filter(initiation_date<=date_cutoff) %>%
  ggplot(data=., aes(y=n_survived/med_t5eggs, x=last_des_rel2h, 
                     color=as.numeric(antL_arrival_afh))) +
  geom_point() +
  geom_smooth(method=lm)
```


And these are important too. They show that early visits increase nymph survivorship, but only in the presence of ants. And importantly, early visits increase the intercept of nymph survivorship, such that laying more eggs doesn't improve survivorship further.

It's hard to decouple the benefit of eggs from continued nymph guarding without focusing on the female removal treatment. If females were removed before hatching, clutch size improved hatching success only if females were not visited, because if they were visited their nymph survivorship intercept increased dramatically and weakly decreased with increasing clutch sizes. So it would be perfectly fine to desert a clutch early if ants are present. All of this is only true when ants are present though, otherwise nymph survivorship is always very low.
```{r}
# n_survived/n_hatched comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_survived/n_hatched, x=med_t5eggs, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(`visited in 4 days`)) +
  ggtitle("intercept higher for clutches that were visited early, but only for ants!")

# n_survived/n_hatched comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_survived/n_hatched, x=med_t5eggs, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(ifelse(females_removed,"females removed","control"),
             `visited in 4 days`)) +
  ggtitle("intercept higher for clutches that were visited early, but only for ants!")

# n_survived/n_hatched comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  filter(females_removed, n_survived/n_hatched<=1) %>%
  ggplot(data=., aes(y=n_survived/n_hatched, x=med_t5eggs, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(ifelse(females_removed,"females removed","control"),
             `visited in 4 days`)) +
  ggtitle("intercept higher for clutches that were visited early, but only for ants!")

# n_survived/n_hatched comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  filter(females_removed, n_survived/n_hatched<=1) %>%
  ggplot(data=., aes(y=n_survived/n_hatched, x=med_t5eggs, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=loess) +
  facet_wrap(vars(ifelse(females_removed,"females removed","control"))) +
  ggtitle("intercept higher for clutches that were visited early, but only for ants!")
```

n_hatched/med_t5eggs ~ des+ants+vis+des:ants+des:vis+ants:vis
```{r}
# n_hatched/med_t5eggs comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_hatched/med_t5eggs, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(`visited in 4 days`)) +
  ggtitle("intercept higher for clutches that were visited early, but only for ants?")

### fit model
hatch.data <- clutch_survivorship_data %>% 
  filter(!is.na(`visited in 4 days`)) %>%
  select(location, n_hatched, med_t5eggs, 
         des=last_des_rel2h, ants=ants_removed, vis=`visited in 4 days`) %>%
  mutate(ants=ifelse(ants, "Removed", "Control"))

hatch.mai.full.qb <- glm(n_hatched/med_t5eggs ~ 
            des*ants*vis,
          data = hatch.data,
          weights = med_t5eggs,
          family = quasibinomial)
summary(hatch.mai.full.qb)

hatch.mai.pw.qb <- glm(n_hatched/med_t5eggs ~ 
            des+ants+vis+des:ants+des:vis+ants:vis,
          data = hatch.data,
          weights = med_t5eggs,
          family = quasibinomial)
summary(hatch.mai.pw.qb)

hatch.mai.pw.b <- glm(n_hatched/med_t5eggs ~ 
            des+ants+vis+des:ants+des:vis+ants:vis,
          data = hatch.data,
          weights = med_t5eggs,
          family = binomial)
summary(hatch.mai.pw.b)
```

n_survived/n_hatched ~ des+ants+vis+des:ants+des:vis+ants:vis
```{r}
# n_survived/n_hatched comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_survived/n_hatched, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(`visited in 4 days`)) +
  ggtitle("intercept higher for clutches that were visited early, but only for ants?")

### fit model
Nsurv.data <- clutch_survivorship_data %>% 
  filter(!is.na(`visited in 4 days`)) %>%
  select(location, n_hatched, n_survived, 
         des=last_des_rel2h, ants=ants_removed, vis=`visited in 4 days`) %>%
  mutate(n_survived = ifelse(n_survived/n_hatched > 1, # if n_survived/n_hatched>1
                             n_hatched, n_survived), # force n_survived/n_hatched=1
         ants=ifelse(ants, "Removed", "Control"))

Nsurv.mai.full.qb <- glm(n_survived/n_hatched ~ 
            des*ants*vis,
          data = Nsurv.data,
          weights = n_hatched,
          family = quasibinomial)
summary(Nsurv.mai.full.qb)

Nsurv.mai.pw.qb <- glm(n_survived/n_hatched ~ 
            des+ants+vis+des:ants+des:vis+ants:vis,
          data = Nsurv.data,
          weights = n_hatched,
          family = quasibinomial)
summary(Nsurv.mai.pw.qb)

Nsurv.mai.pw.b <- glm(n_survived/n_hatched ~ 
            des+ants+vis+des:ants+des:vis+ants:vis,
          data = Nsurv.data,
          weights = n_hatched,
          family = binomial)
summary(Nsurv.mai.pw.b)
```

n_survived/med_t5eggs ~ des+ants+vis+des:ants+des:vis+ants:vis
```{r}
# n_survived/n_hatched comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  ggplot(data=., aes(y=n_survived/med_t5eggs, x=last_des_rel2h, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(`visited in 4 days`)) +
  ggtitle("intercept higher for clutches that were visited early, but only for ants?")

### fit model
Esurv.data <- clutch_survivorship_data %>% 
  filter(!is.na(`visited in 4 days`)) %>%
  select(location, med_t5eggs, n_survived, 
         des=last_des_rel2h, ants=ants_removed, vis=`visited in 4 days`) %>%
  mutate(n_survived = ifelse(n_survived/med_t5eggs > 1,# if n_survived/med_t5eggs>1
                             med_t5eggs, n_survived), # force n_survived/n_hatched=1
         ants=ifelse(ants, "Removed", "Control"))

Esurv.mai.full.qb <- glm(n_survived/med_t5eggs ~ 
            des*ants*vis,
          data = Esurv.data,
          weights = med_t5eggs,
          family = quasibinomial)
summary(Esurv.mai.full.qb)

Esurv.mai.pw.qb <- glm(n_survived/med_t5eggs ~ 
            des+ants+vis+des:ants+des:vis+ants:vis,
          data = Esurv.data,
          weights = med_t5eggs,
          family = quasibinomial)
summary(Esurv.mai.pw.qb)

Esurv.mai.pw.b <- glm(n_survived/med_t5eggs ~ 
            des+ants+vis+des:ants+des:vis+ants:vis,
          data = Esurv.data,
          weights = med_t5eggs,
          family = binomial)
summary(Esurv.mai.pw.b)
```

n_survived/n_hatched ~ med_t5eggs * ants * vis
```{r}
# n_survived/n_hatched comparing `visited in 4 days`
clutch_survivorship_data %>% filter(!is.na(`visited in 4 days`)) %>% # 2 points
  filter(females_removed, n_survived/n_hatched<=1) %>%
  ggplot(data=., aes(y=n_survived/n_hatched, x=med_t5eggs, 
                     color=ants_removed, fill=ants_removed)) +
  geom_point() +
  geom_smooth(method=lm) +
  facet_wrap(vars(ifelse(females_removed,"females removed","control"),
             `visited in 4 days`)) +
  ggtitle("intercept higher for clutches that were visited early, but only for ants!")

### fit model
n_eggs.Nsurv.data <- clutch_survivorship_data %>% 
  filter(females_removed) %>%
  filter(!is.na(`visited in 4 days`)) %>%
  select(location, med_t5eggs, n_survived, 
         des=last_des_rel2h, ants=ants_removed, vis=`visited in 4 days`) %>%
  mutate(n_survived = ifelse(n_survived/med_t5eggs > 1,# if n_survived/med_t5eggs>1
                             med_t5eggs, n_survived), # force n_survived/n_hatched=1
         ants=ifelse(ants, "Removed", "Control"))

n_eggs.Nsurv.mai.full.qb <- glm(n_survived/med_t5eggs ~ 
            med_t5eggs*ants*vis,
          data = n_eggs.Nsurv.data,
          weights = med_t5eggs,
          family = quasibinomial)
summary(n_eggs.Nsurv.mai.full.qb)

n_eggs.Nsurv.mai.full.b <- glm(n_survived/med_t5eggs ~ 
            med_t5eggs*ants*vis,
          data = n_eggs.Nsurv.data,
          weights = med_t5eggs,
          family = binomial)
summary(n_eggs.Nsurv.mai.full.b)

n_eggs.Nsurv.mai.pw.qb <- glm(n_survived/med_t5eggs ~ 
            med_t5eggs+ants+vis+med_t5eggs:ants+med_t5eggs:vis+ants:vis,
          data = n_eggs.Nsurv.data,
          weights = med_t5eggs,
          family = quasibinomial)
summary(Esurv.mai.pw.qb)

n_eggs.Nsurv.mai.pw.b <- glm(n_survived/med_t5eggs ~ 
            med_t5eggs+ants+vis+med_t5eggs:ants+med_t5eggs:vis+ants:vis,
          data = n_eggs.Nsurv.data,
          weights = med_t5eggs,
          family = binomial)
summary(n_eggs.Nsurv.mai.pw.b)
```


## Functions to create plots and run stats using each model
with the visit in first four days parameter
```{r}
### fit survivorship model
fit_surv_vis <- function(data_in, survNom, survDen, tenure, 
                     treatment, vis, interaction=c("full","pw")){
  data <- eval(substitute(data_in %>% filter(!is.na(tenure))))
  
  if(interaction=="full"){
      mai.b <- eval(substitute(glm(survNom/survDen ~ 
                tenure*treatment*vis,
              data = data, weights = survDen, family = binomial)))
      print("Interaction, Binomial: ")
      print(capture.output(summary(mai.b))[-(6:which(grepl("Deviance Residuals: ", capture.output(summary(mai.b))))-1)])
      
      mai.qb <- eval(substitute(glm(survNom/survDen ~ 
                tenure*treatment*vis,
              data = data, weights = survDen, family = quasibinomial)))
      print("Interaction, Quasibinomial: ")
      print(capture.output(summary(mai.qb))[-(6:which(grepl("Deviance Residuals: ", capture.output(summary(mai.qb))))-1)])
      
      ma.qb <- eval(substitute(glm(survNom/survDen ~ 
                tenure+treatment,
              data = data, weights = survDen, family = quasibinomial)))
      print("No Interaction, Quasibinomial: ")
      print(capture.output(summary(mai.qb))[-(6:which(grepl("Deviance Residuals: ", capture.output(summary(mai.qb))))-1)])
  } else if(interaction=="pw"){
      mai.b <- eval(substitute(glm(survNom/survDen ~ 
                tenure+treatment+vis+tenure:treatment+tenure:vis+treatment:vis,
              data = data, weights = survDen, family = binomial)))
      print("Interaction, Binomial: ")
      print(capture.output(summary(mai.b))[-(6:which(grepl("Deviance Residuals: ", capture.output(summary(mai.b))))-1)])
      
      mai.qb <- eval(substitute(glm(survNom/survDen ~ 
                tenure+treatment+vis+tenure:treatment+tenure:vis+treatment:vis,
              data = data, weights = survDen, family = quasibinomial)))
      print("Interaction, Quasibinomial: ")
      print(capture.output(summary(mai.qb))[-(6:which(grepl("Deviance Residuals: ", capture.output(summary(mai.qb))))-1)])
      
      ma.qb <- eval(substitute(glm(survNom/survDen ~ 
                tenure+treatment+vis,
              data = data, weights = survDen, family = quasibinomial)))
      print("No Interaction, Quasibinomial: ")
      print(capture.output(summary(mai.qb))[-(6:which(grepl("Deviance Residuals: ", capture.output(summary(mai.qb))))-1)])
  } else {print("Must specify interaction=c(\"full\", \"pw\"")
  }
    mai.models <- list(mai.b = mai.b, mai.qb = mai.qb, ma.qb = ma.qb)
  return(mai.models)
}
  
# Example
# test_fits <- fit_surv(data_in=hatch.data, tenure=des, treatment=ants, vis=vis,
#                  interaction="pw", survNom=n_hatched, survDen=med_t5eggs)

### Create confidence intervals in the link scale for plotting, and backtransform for plot
# Based on: https://fromthebottomoftheheap.net/2018/12/10/confidence-intervals-for-glms/
ci_for_plot_vis <- function(data_in, survNom, survDen, 
                        tenure, treatment, vis, model){
  
  data <- eval(substitute(
    data_in %>% filter(!is.na(tenure)) %>%
      select(location, tenure, treatment, vis, survDen, survNom) %>%
      add_column(fit = predict(model, newdata = ., type = 'response'))
    ))
  
  ## grad the inverse link function
  ilink <- family(model)$linkinv
  
  ## add fit and se.fit on the **link** scale
  data_fit_link <- eval(substitute(
    data %>% add_column(
  setNames(as_tibble(predict(model, data, se.fit = TRUE)[1:2]),
           c('fit_link','se_link'))) %>%
## create the interval and backtransform
  mutate(fit_resp  = ilink(fit_link),
         conf_upr = ilink(fit_link + (2 * se_link)),
         conf_lwr = ilink(fit_link - (2 * se_link)))
    ))
  
  return(data_fit_link)
}

# Example
# test_fits.pw <- fit_surv(data_in=hatch.data, tenure=des, treatment=ants, vis=vis,
#                  interaction="pw", survNom=n_hatched, survDen=med_t5eggs)
# 
# test_ci_data <- ci_for_plot(data_in=hatch.data, tenure=des, treatment=ants, vis=vis,
#                  survNom=n_hatched, survDen=med_t5eggs,
#                  model = test_fits.pw$mai.qb)

### Plot model results with confidence intervals
plot_ci_vis <- function(ci_data, survNom, survDen, treatment, tenure, vis){
  (eval(substitute(plot <- ggplot(data = ci_data, 
       aes(x = tenure, y = fit, 
           color = treatment, fill = treatment)) +
    theme_publilia() +
    geom_point(aes(y = survNom/survDen), alpha = 0.1, size = 5) + 
    geom_line(aes(y = fit), size = 1) +
    geom_ribbon(aes(ymin = conf_upr, ymax = conf_lwr),
                    alpha = 0.3, color = NA)))) +
    facet_wrap(vars(vis))
#
}

# Example
test_fits.pw <- fit_surv_vis(data_in=hatch.data, tenure=des, treatment=ants, vis=vis,
                 interaction="pw", survNom=n_hatched, survDen=med_t5eggs)

test_ci_data <- ci_for_plot_vis(data_in=hatch.data, tenure=des, treatment=ants, vis=vis,
                 survNom=n_hatched, survDen=med_t5eggs,
                 model = test_fits.pw$mai.qb)

(p <- plot_ci_vis(ci_data = test_ci_data, tenure = des, treatment=ants, vis=vis,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success") +
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))
summary(test_fits.pw$mai.qb)
```

without the visit in first four days parameter
```{r}
### fit survivorship model
fit_surv <- function(data_in, survNom, survDen, tenure, 
                     treatment, vis, interaction=c("full","pw")){
  data <- eval(substitute(data_in %>% filter(!is.na(tenure))))
  
  mai.b <- eval(substitute(glm(survNom/survDen ~ 
            tenure*treatment,
          data = data, weights = survDen, family = binomial)))
  print("Interaction, Binomial: ")
  print(capture.output(summary(mai.b))[-(6:which(grepl("Deviance Residuals: ", capture.output(summary(mai.b))))-1)])
  
  mai.qb <- eval(substitute(glm(survNom/survDen ~ 
            tenure*treatment,
          data = data, weights = survDen, family = quasibinomial)))
  print("Interaction, Quasibinomial: ")
  print(capture.output(summary(mai.qb))[-(6:which(grepl("Deviance Residuals: ", capture.output(summary(mai.qb))))-1)])
  
  ma.qb <- eval(substitute(glm(survNom/survDen ~ 
            tenure+treatment,
          data = data, weights = survDen, family = quasibinomial)))
  print("No Interaction, Quasibinomial: ")
  print(capture.output(summary(mai.qb))[-(6:which(grepl("Deviance Residuals: ", capture.output(summary(mai.qb))))-1)])
  
  mai.models <- list(mai.b = mai.b, mai.qb = mai.qb, ma.qb = ma.qb)
  return(mai.models)
}
  
# Example
# test_fits <- fit_surv(data_in=hatch.data, tenure=des, treatment=ants,
#                  interaction="pw", survNom=n_hatched, survDen=med_t5eggs)

### Create confidence intervals in the link scale for plotting, and backtransform for plot
# Based on: https://fromthebottomoftheheap.net/2018/12/10/confidence-intervals-for-glms/
ci_for_plot <- function(data_in, survNom, survDen, 
                        tenure, treatment, model){
  
  data <- eval(substitute(
    data_in %>% filter(!is.na(tenure)) %>%
      select(location, tenure, treatment, survDen, survNom) %>%
      add_column(fit = predict(model, newdata = ., type = 'response'))
    ))
  
  ## grad the inverse link function
  ilink <- family(model)$linkinv
  
  ## add fit and se.fit on the **link** scale
  data_fit_link <- eval(substitute(
    data %>% add_column(
  setNames(as_tibble(predict(model, data, se.fit = TRUE)[1:2]),
           c('fit_link','se_link'))) %>%
## create the interval and backtransform
  mutate(fit_resp  = ilink(fit_link),
         conf_upr = ilink(fit_link + (2 * se_link)),
         conf_lwr = ilink(fit_link - (2 * se_link)))
    ))
  
  return(data_fit_link)
}

# Example
# test_fits.pw <- fit_surv(data_in=hatch.data, tenure=des, treatment=ants, 
#                  interaction="pw", survNom=n_hatched, survDen=med_t5eggs)
# 
# test_ci_data <- ci_for_plot(data_in=hatch.data, tenure=des, treatment=ants, 
#                  survNom=n_hatched, survDen=med_t5eggs,
#                  model = test_fits.pw$mai.qb)

### Plot model results with confidence intervals
plot_ci <- function(ci_data, survNom, survDen, treatment, tenure){
  (eval(substitute(plot <- ggplot(data = ci_data, 
       aes(x = tenure, y = fit, 
           color = treatment, fill = treatment)) +
    theme_publilia() +
    geom_point(aes(y = survNom/survDen), alpha = 0.25, size = 4, shape=16, key_glyph=draw_key_rect) + 
    geom_line(aes(y = fit), size = 1, key_glyph=draw_key_rect) +
    geom_ribbon(aes(ymin = conf_upr, ymax = conf_lwr),
                    alpha = 0.5, color = NA, key_glyph=draw_key_rect))))
#
}

# Example
test_fits.pw <- fit_surv(data_in=hatch.data, tenure=des, treatment=ants,
                 interaction="pw", survNom=n_hatched, survDen=med_t5eggs)

test_ci_data <- ci_for_plot(data_in=hatch.data, tenure=des, treatment=ants,
                 survNom=n_hatched, survDen=med_t5eggs,
                 model = test_fits.pw$mai.qb)

(p <- plot_ci(ci_data = test_ci_data, tenure = des, treatment=ants,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success") +
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))
summary(test_fits.pw$mai.qb)
```

# Final figures and stats using functions
Use the same data for each regression
```{r}
# I originally used the ants_removed as the predictor representing ants, but I am now redoing the analysis using whether ants were ever observed at the clutch.
surv_reg_data <- clutch_survivorship_data %>% 
  filter(!is.na(`visited in 4 days`)) %>%
  select(location, med_t5eggs, n_hatched, n_survived,
         des=last_des_rel2h, ants_removed, vis=`visited in 4 days`,
         females_removed, initiation_date, est_hatch) %>%
  mutate(n_survived = ifelse(n_survived/n_hatched > 1,# if n_survived/n_hatched>1
                             n_hatched, n_survived), # force n_survived/n_hatched=1
         ant_treatment=ifelse(ants_removed, "Removed", "Control")) %>%
  left_join(select(ant_counts, location, 
                   ever_antsP_b4h, ever_antsP_afh, ever_antsP)) %>%
  mutate(ants_b4h=ifelse(ever_antsP_b4h," ever", " never"),
         ants_afh=ifelse(ever_antsP_afh," ever"," never"),
         ants_ever=ifelse(ever_antsP," ever"," never")) %>%
  left_join(select(ant_n_days, -ants_everP, -ant_treatment, -females_removed)) %>%
  mutate(ants_gt2d=ifelse(antsP_gt2d," ants", " no ants"),
         ants_gt3d=ifelse(antsP_gt3d," ants", " no ants")) %>% 
  separate(location, into = c("DormPlant", "Leaf"), sep="_", remove=FALSE) %>%
  left_join(dplyr::select(moms_plant_data, DormPlant, last_visit_ends_P), by="DormPlant") %>%
  mutate(last_desP_rel2h = last_visit_ends_P-est_hatch,
         desP = last_desP_rel2h) 
```

### n_hatched/med_t5eggs ~ des+ants+vis+des:ants+des:vis+ants:vis
full - no coefs signif; remove three-way interaction
pairwise interaction - des**, des:ants*, vis*, ants:vis. USE THIS for main fig
no vis - des***, ants** (but missing vis* and ants:vis. from above)
```{r}
# vis - full model
des_hatch.vis.full.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ant_treatment, vis=vis,
                              interaction="full")

des_hatch.vis.full.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_hatched, survDen=med_t5eggs,
                                  tenure=des, treatment=ant_treatment, vis=vis,
                                  model = des_hatch.vis.full.fits$mai.qb)

(des_hatch.vis.full.qb.p <- plot_ci_vis(ci_data=des_hatch.vis.full.qb.ci,
                                        tenure=des, treatment=ant_treatment, vis=vis,
                                        survNom=n_hatched, survDen=med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_hatch.vis.full.fits$mai.qb) # no coefs signif; remove three-way interaction

# vis - pairwise interactions only
des_hatch.vis.pw.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ant_treatment, vis=vis,
                              interaction="pw")

des_hatch.vis.pw.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_hatched, survDen=med_t5eggs,
                                  tenure=des, treatment=ant_treatment, vis=vis,
                                  model = des_hatch.vis.pw.fits$mai.qb)

(des_hatch.vis.pw.qb.p <- plot_ci_vis(ci_data=des_hatch.vis.pw.qb.ci, 
                                      tenure=des, treatment=ant_treatment, vis=vis,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_hatch.vis.pw.fits$mai.qb) # des**, des:ants*, vis*, ants:vis. **USE THIS**

# no vis - pairwise interactions only
des_hatch.pw.fits <- fit_surv(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ant_treatment,
                              interaction="pw")

des_hatch.pw.qb.ci <- ci_for_plot(data_in=surv_reg_data, 
                                  survNom=n_hatched, survDen=med_t5eggs,
                                  tenure=des, treatment=ant_treatment,
                                  model = des_hatch.pw.fits$mai.qb)

(des_hatch.pw.qb.p <- plot_ci(ci_data=des_hatch.pw.qb.ci, 
                                  tenure=des, treatment=ant_treatment,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_hatch.pw.fits$mai.qb) # des***, ants** (missing signif vis* and ants:vis.)

## Drop in deviance: none significant, go with second model (vis, pairwise)
anova(des_hatch.vis.full.fits$mai.qb, des_hatch.vis.pw.fits$mai.qb, test = "Chisq") # ns
anova(des_hatch.vis.pw.fits$mai.qb, des_hatch.pw.fits$mai.qb, test = "Chisq") # ns
```

### n_survived/n_hatched ~ des+ants+vis+des:ants+des:vis+ants:vis
full - no coefs signif; remove three-way interaction
pairwise interaction - des:ants*, vis:ants. USE THIS for main fig
no vis - des:ants** (but missing vis:ants. from above)
```{r}
# vis - full interactions
des_Nsurv.vis.full.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ant_treatment, vis=vis,
                              interaction="full")

des_Nsurv.vis.full.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=des, treatment=ant_treatment, vis=vis,
                                  model = des_Nsurv.vis.full.fits$mai.qb)

(des_Nsurv.vis.full.qb.p <- plot_ci_vis(ci_data=des_Nsurv.vis.full.qb.ci, 
                              tenure=des, treatment=ant_treatment, vis=vis,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.vis.full.fits$mai.qb) # all coefs ns; drop three-way interaction

# vis - pairwise interactions only
des_Nsurv.vis.pw.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ant_treatment, vis=vis,
                              interaction="pw")

des_Nsurv.vis.pw.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=des, treatment=ant_treatment, vis=vis,
                                  model = des_Nsurv.vis.pw.fits$mai.qb)

(des_Nsurv.vis.pw.qb.p <- plot_ci_vis(ci_data=des_Nsurv.vis.pw.qb.ci, 
                              tenure=des, treatment=ant_treatment, vis=vis,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.vis.pw.fits$mai.qb) # des:ants*, vis:ants.

# no vis - pairwise interactions only
des_Nsurv.pw.fits <- fit_surv(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ant_treatment,
                              interaction="pw")

des_Nsurv.pw.qb.ci <- ci_for_plot(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=des, treatment=ant_treatment,
                                  model = des_Nsurv.pw.fits$mai.qb)

(des_Nsurv.pw.qb.p <- plot_ci(ci_data=des_Nsurv.pw.qb.ci, 
                                  tenure=des, treatment=ant_treatment,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.pw.fits$mai.qb) # des:ants**

## Drop in deviance: none significant, go with second model (vis, pairwise)
anova(des_Nsurv.vis.full.fits$mai.qb, des_Nsurv.vis.pw.fits$mai.qb, test = "Chisq") # ns
anova(des_Nsurv.vis.pw.fits$mai.qb, des_Nsurv.pw.fits$mai.qb, test = "Chisq") # ns
```

### n_survived/med_t5eggs ~ des+ants+vis+des:ants+des:vis+ants:vis
full - no coefs signif;  USE THIS for predicting fitness
pairwise interaction - no signif coefs but ants:vis <0.10
no vis - no signif coefs but ants and des:ants <0.10
```{r}
# vis - full interactions
des_Esurv.vis.full.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=des, treatment=ant_treatment, vis=vis,
                              interaction="full")

des_Esurv.vis.full.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=med_t5eggs,
                                  tenure=des, treatment=ant_treatment, vis=vis,
                                  model = des_Esurv.vis.full.fits$mai.qb)

(des_Esurv.vis.full.qb.p <- plot_ci_vis(ci_data=des_Esurv.vis.full.qb.ci, 
                              tenure=des, treatment=ant_treatment, vis=vis,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Esurv.vis.full.fits$mai.qb) # ** use this for predicting fitness

# vis - pairwise interactions only
des_Esurv.vis.pw.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=des, treatment=ant_treatment, vis=vis,
                              interaction="pw")

des_Esurv.vis.pw.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=med_t5eggs,
                                  tenure=des, treatment=ant_treatment, vis=vis,
                                  model = des_Esurv.vis.pw.fits$mai.qb)

(des_Esurv.vis.pw.qb.p <- plot_ci_vis(ci_data=des_Esurv.vis.pw.qb.ci, 
                              tenure=des, treatment=ant_treatment, vis=vis,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Esurv.vis.pw.fits$mai.qb) # no signif coefs but ants:vis <0.10

# no vis - pairwise interactions only
des_Esurv.pw.fits <- fit_surv(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=des, treatment=ant_treatment,
                              interaction="pw")

des_Esurv.pw.qb.ci <- ci_for_plot(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=med_t5eggs,
                                  tenure=des, treatment=ant_treatment,
                                  model = des_Esurv.pw.fits$mai.qb)

(des_Esurv.pw.qb.p <- plot_ci(ci_data=des_Esurv.pw.qb.ci, 
                                  tenure=des, treatment=ant_treatment,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Esurv.pw.fits$mai.qb) # no signif coefs but ants and des:ants <0.10

## Drop in deviance: none significant, go with second model (vis, pairwise)
anova(des_Esurv.vis.full.fits$mai.qb, des_Esurv.vis.pw.fits$mai.qb, test = "Chisq") # ns
anova(des_Esurv.vis.pw.fits$mai.qb, des_Esurv.pw.fits$mai.qb, test = "Chisq") # ns
```

### n_survived/med_t5eggs ~ med_t5eggs * ants * vis
I don't think this is as informative as n_survived/n_hatched, may mention but not show?
full - eggs*, vis* eggs:vis*, eggs:ants.
pairwise interaction - no signif coefs but vis and eggs:vis <0.10
no vis - no signif coefs
```{r}
# vis - full interactions
egg_Esurv.vis.full.fits <- fit_surv_vis(data_in=filter(surv_reg_data, females_removed), 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=med_t5eggs, treatment=ant_treatment, vis=vis,
                              interaction="full")

egg_Esurv.vis.full.qb.ci <- ci_for_plot_vis(data_in=filter(surv_reg_data, females_removed), 
                                  survNom=n_survived, survDen=med_t5eggs,
                                  tenure=med_t5eggs, treatment=ant_treatment, vis=vis,
                                  model = egg_Esurv.vis.full.fits$mai.qb)

(egg_Esurv.vis.full.qb.p <- plot_ci_vis(ci_data=egg_Esurv.vis.full.qb.ci, 
                              tenure=med_t5eggs, treatment=ant_treatment, vis=vis,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Clutch size (number of eggs)") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(egg_Esurv.vis.full.fits$mai.qb) # eggs*, vis* eggs:vis*, eggs:ants.

# vis - pairwise interactions only
egg_Esurv.vis.pw.fits <- fit_surv_vis(data_in=filter(surv_reg_data, females_removed), 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=med_t5eggs, treatment=ant_treatment, vis=vis,
                              interaction="pw")

egg_Esurv.vis.pw.qb.ci <- ci_for_plot_vis(data_in=filter(surv_reg_data, females_removed), 
                                  survNom=n_survived, survDen=med_t5eggs,
                                  tenure=med_t5eggs, treatment=ant_treatment, vis=vis,
                                  model = egg_Esurv.vis.pw.fits$mai.qb)

(egg_Esurv.vis.pw.qb.p <- plot_ci_vis(ci_data=egg_Esurv.vis.pw.qb.ci, 
                              tenure=med_t5eggs, treatment=ant_treatment, vis=vis,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Clutch size (number of eggs)") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(egg_Esurv.vis.pw.fits$mai.qb) # no signif coefs but vis and eggs:vis <0.10

# no vis - pairwise interactions only
egg_Esurv.pw.fits <- fit_surv(data_in=filter(surv_reg_data, females_removed), 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=med_t5eggs, treatment=ant_treatment,
                              interaction="pw")

egg_Esurv.pw.qb.ci <- ci_for_plot(data_in=filter(surv_reg_data, females_removed), 
                                  survNom=n_survived, survDen=med_t5eggs,
                                  tenure=med_t5eggs, treatment=ant_treatment,
                                  model = egg_Esurv.pw.fits$mai.qb)

(egg_Esurv.pw.qb.p <- plot_ci(ci_data=egg_Esurv.pw.qb.ci, 
                                  tenure=med_t5eggs, treatment=ant_treatment,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Clutch size (number of eggs)") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(egg_Esurv.pw.fits$mai.qb) # no signif coefs

## Drop in deviance: none significant, go with second model (vis, pairwise)
anova(egg_Esurv.vis.full.fits$mai.qb, egg_Esurv.vis.pw.fits$mai.qb, test = "Chisq") # ns
anova(egg_Esurv.vis.pw.fits$mai.qb, egg_Esurv.pw.fits$mai.qb, test = "Chisq") # ns
```

### n_survived/n_hatched ~ med_t5eggs * ants * vis
full - all but ants * or **
pairwise interaction - vis*, eggs:vis*, eggs. (drop-in-deviance signif)
no vis - no signif coefs (drop-in-deviance <0.10)

Note that this is the only set of models where drop-in-deviance test (full->pairwise) was actually significant, so would it be best to keep the pairwise model? The fit on the intercept for visVisited, AntsRemoved looks really strange on the plot, which makes me think there are just too few data points for this if I'm just using the female removal data. If I include the control data it is hard to decouple egg/nymph guarding from larger clutches, so I think maybe I should skip on this (I wish I had more [both female removal and control] data!!!)
```{r}
# vis - full interactions
egg_Nsurv.vis.full.fits <- fit_surv_vis(data_in=filter(surv_reg_data, females_removed), 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=med_t5eggs, treatment=ant_treatment, vis=vis,
                              interaction="full")

egg_Nsurv.vis.full.qb.ci <- ci_for_plot_vis(data_in=filter(surv_reg_data, females_removed), 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=med_t5eggs, treatment=ant_treatment, vis=vis,
                                  model = egg_Nsurv.vis.full.fits$mai.qb)

(egg_Nsurv.vis.full.qb.p <- plot_ci_vis(ci_data=egg_Nsurv.vis.full.qb.ci, 
                              tenure=med_t5eggs, treatment=ant_treatment, vis=vis,
                              survNom=n_survived, survDen=n_hatched) +
    xlab("Clutch size (number of eggs)") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(egg_Nsurv.vis.full.fits$mai.qb) # all but ants * or **

# vis - pairwise interactions only
egg_Nsurv.vis.pw.fits <- fit_surv_vis(data_in=filter(surv_reg_data, females_removed), 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=med_t5eggs, treatment=ant_treatment, vis=vis,
                              interaction="pw")

egg_Nsurv.vis.pw.qb.ci <- ci_for_plot_vis(data_in=filter(surv_reg_data, females_removed), 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=med_t5eggs, treatment=ant_treatment, vis=vis,
                                  model = egg_Nsurv.vis.pw.fits$mai.qb)

(egg_Nsurv.vis.pw.qb.p <- plot_ci_vis(ci_data=egg_Nsurv.vis.pw.qb.ci, 
                              tenure=med_t5eggs, treatment=ant_treatment, vis=vis,
                              survNom=n_survived, survDen=n_hatched) +
    xlab("Clutch size (number of eggs)") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(egg_Nsurv.vis.pw.fits$mai.qb) # vis*, eggs:vis*, eggs. (missing three-way interaction)

# no vis - pairwise interactions only
egg_Nsurv.pw.fits <- fit_surv(data_in=filter(surv_reg_data, females_removed), 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=med_t5eggs, treatment=ant_treatment,
                              interaction="pw")

egg_Nsurv.pw.qb.ci <- ci_for_plot(data_in=filter(surv_reg_data, females_removed), 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=med_t5eggs, treatment=ant_treatment,
                                  model = egg_Nsurv.pw.fits$mai.qb)

(egg_Nsurv.pw.qb.p <- plot_ci(ci_data=egg_Nsurv.pw.qb.ci,
                              tenure=med_t5eggs, treatment=ant_treatment,
                              survNom=n_survived, survDen=n_hatched) +
    xlab("Clutch size (number of eggs)") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(egg_Nsurv.pw.fits$mai.qb) # no signif coefs

## Drop in deviance: none significant, go with second model (vis, pairwise)
anova(egg_Nsurv.vis.full.fits$mai.qb, egg_Nsurv.vis.pw.fits$mai.qb, test = "Chisq") # *
anova(egg_Nsurv.vis.pw.fits$mai.qb, egg_Nsurv.pw.fits$mai.qb, test = "Chisq") # .
```

## Changing the ants parameter to reflect which clutches are actually visited
### n_hatched/med_t5eggs ~ des+ants+vis+des:ants+des:vis+ants:vis
*ants=ants_b4h*
full - no coefs signif; remove three-way interaction
pairwise interaction - des**, des:ants*, vis*, ants:vis. USE THIS for main fig
no vis - des***, ants** (but missing vis* and ants:vis. from above)
```{r}
# vis - full model
des_hatch.ants_b4h.vis.full.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ants_b4h, vis=vis,
                              interaction="full")

des_hatch.ants_b4h.vis.full.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_hatched, survDen=med_t5eggs,
                                  tenure=des, treatment=ants_b4h, vis=vis,
                                  model = des_hatch.ants_b4h.vis.full.fits$mai.qb)

(des_hatch.ants_b4h.vis.full.qb.p <- plot_ci_vis(ci_data=des_hatch.ants_b4h.vis.full.qb.ci,
                                        tenure=des, treatment=ants_b4h, vis=vis,
                                        survNom=n_hatched, survDen=med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_hatch.vis.full.fits$mai.qb) # no coefs signif; remove three-way interaction

# vis - pairwise interactions only
des_hatch.ants_b4h.vis.pw.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ants_b4h, vis=vis,
                              interaction="pw")

des_hatch.ants_b4h.vis.pw.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_hatched, survDen=med_t5eggs,
                                  tenure=des, treatment=ants_b4h, vis=vis,
                                  model = des_hatch.ants_b4h.vis.pw.fits$mai.qb)

(des_hatch.ants_b4h.vis.pw.qb.p <- plot_ci_vis(ci_data=des_hatch.ants_b4h.vis.pw.qb.ci, 
                                      tenure=des, treatment=ants_b4h, vis=vis,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_hatch.vis.pw.fits$mai.qb) # des**, des:ants*, vis*, ants:vis. **USE THIS**

# no vis - pairwise interactions only
des_hatch.ants_b4h.pw.fits <- fit_surv(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ants_b4h,
                              interaction="pw")

des_hatch.ants_b4h.pw.qb.ci <- ci_for_plot(data_in=surv_reg_data, 
                                  survNom=n_hatched, survDen=med_t5eggs,
                                  tenure=des, treatment=ants_b4h,
                                  model = des_hatch.ants_b4h.pw.fits$mai.qb)

(des_hatch.ants_b4h.pw.qb.p <- plot_ci(ci_data=des_hatch.ants_b4h.pw.qb.ci, 
                                  tenure=des, treatment=ants_b4h,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_hatch.ants_b4h.pw.fits$mai.qb) # des***, ants** (missing signif vis* and ants:vis.)

## Drop in deviance: none significant, go with second model (vis, pairwise)
anova(des_hatch.ants_b4h.vis.full.fits$mai.qb, des_hatch.ants_b4h.vis.pw.fits$mai.qb, test = "Chisq") # ns
anova(des_hatch.ants_b4h.vis.pw.fits$mai.qb, des_hatch.ants_b4h.pw.fits$mai.qb, test = "Chisq") # ns
```

### n_hatched/med_t5eggs ~ des+ants+vis+des:ants+des:vis+ants:vis
*ants=ants_ever*
full - no coefs signif; remove three-way interaction
pairwise interaction - des**, des:ants*, vis*, ants:vis. USE THIS for main fig
no vis - des***, ants** (but missing vis* and ants:vis. from above)
```{r}
# vis - full model
des_hatch.ants_ever.vis.full.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ants_ever, vis=vis,
                              interaction="full")

des_hatch.ants_ever.vis.full.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_hatched, survDen=med_t5eggs,
                                  tenure=des, treatment=ants_ever, vis=vis,
                                  model = des_hatch.ants_ever.vis.full.fits$mai.qb)

(des_hatch.ants_ever.vis.full.qb.p <- plot_ci_vis(ci_data=des_hatch.ants_ever.vis.full.qb.ci,
                                        tenure=des, treatment=ants_ever, vis=vis,
                                        survNom=n_hatched, survDen=med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_hatch.ants_ever.vis.full.fits$mai.qb) # no coefs signif; remove three-way interaction

# vis - pairwise interactions only
des_hatch.ants_ever.vis.pw.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ants_ever, vis=vis,
                              interaction="pw")

des_hatch.ants_ever.vis.pw.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_hatched, survDen=med_t5eggs,
                                  tenure=des, treatment=ants_ever, vis=vis,
                                  model = des_hatch.ants_ever.vis.pw.fits$mai.qb)

(des_hatch.ants_ever.vis.pw.qb.p <- plot_ci_vis(ci_data=des_hatch.ants_ever.vis.pw.qb.ci, 
                                      tenure=des, treatment=ants_ever, vis=vis,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_hatch.ants_ever.vis.pw.fits$mai.qb) # des**, des:ants*, vis*, ants:vis. **USE THIS**

# no vis - pairwise interactions only
des_hatch.ants_ever.pw.fits <- fit_surv(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ants_ever,
                              interaction="pw")

des_hatch.ants_ever.pw.qb.ci <- ci_for_plot(data_in=surv_reg_data, 
                                  survNom=n_hatched, survDen=med_t5eggs,
                                  tenure=des, treatment=ants_ever,
                                  model = des_hatch.ants_ever.pw.fits$mai.qb)

(des_hatch.ants_ever.pw.qb.p <- plot_ci(ci_data=des_hatch.ants_ever.pw.qb.ci, 
                                  tenure=des, treatment=ants_ever,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_hatch.ants_ever.pw.fits$mai.qb) # des***, ants** (missing signif vis* and ants:vis.)

## Drop in deviance: none significant, go with second model (vis, pairwise)
anova(des_hatch.ants_ever.vis.full.fits$mai.qb, des_hatch.ants_ever.vis.pw.fits$mai.qb, test = "Chisq") # ns
anova(des_hatch.ants_ever.vis.pw.fits$mai.qb, des_hatch.ants_ever.pw.fits$mai.qb, test = "Chisq") # ns
```

### n_survived/n_hatched ~ des+ants+vis+des:ants+des:vis+ants:vis
*ants=ants_b4h*
full - no coefs signif; remove three-way interaction
pairwise interaction - des:ants*, vis:ants. USE THIS for main fig
no vis - des:ants** (but missing vis:ants. from above)
```{r}
# vis - full interactions
des_Nsurv.ants_b4h.vis.full.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ants_b4h, vis=vis,
                              interaction="full")

des_Nsurv.ants_b4h.vis.full.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=des, treatment=ants_b4h, vis=vis,
                                  model = des_Nsurv.ants_b4h.vis.full.fits$mai.qb)

(des_Nsurv.ants_b4h.full.qb.p <- plot_ci_vis(ci_data=des_Nsurv.ants_b4h.vis.full.qb.ci, 
                              tenure=des, treatment=ants_b4h, vis=vis,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.ants_b4h.vis.full.fits$mai.qb) # all coefs ns; drop three-way interaction

# vis - pairwise interactions only
des_Nsurv.ants_b4h.vis.pw.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ants_b4h, vis=vis,
                              interaction="pw")

des_Nsurv.ants_b4h.vis.pw.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=des, treatment=ants_b4h, vis=vis,
                                  model = des_Nsurv.ants_b4h.vis.pw.fits$mai.qb)

(des_Nsurv.ants_b4h.pw.qb.p <- plot_ci_vis(ci_data=des_Nsurv.ants_b4h.vis.pw.qb.ci, 
                              tenure=des, treatment=ants_b4h, vis=vis,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.ants_b4h.vis.pw.fits$mai.qb) # des:ants*, vis:ants.

# no vis - pairwise interactions only
des_Nsurv.ants_b4h.pw.fits <- fit_surv(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ants_b4h,
                              interaction="pw")

des_Nsurv.ants_b4h.pw.qb.ci <- ci_for_plot(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=des, treatment=ants_b4h,
                                  model = des_Nsurv.ants_b4h.pw.fits$mai.qb)

(des_Nsurv.ants_b4h.pw.qb.p <- plot_ci(ci_data=des_Nsurv.ants_b4h.pw.qb.ci, 
                                  tenure=des, treatment=ants_b4h,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.ants_b4h.pw.fits$mai.qb) # des:ants**

## Drop in deviance: none significant, go with second model (vis, pairwise)
anova(des_Nsurv.ants_b4h.vis.full.fits$mai.qb, des_Nsurv.ants_b4h.vis.pw.fits$mai.qb, test = "Chisq") # ns
anova(des_Nsurv.ants_b4h.vis.pw.fits$mai.qb, des_Nsurv.ants_b4h.pw.fits$mai.qb, test = "Chisq") # ns
```

### n_survived/n_hatched ~ des+ants+vis+des:ants+des:vis+ants:vis
*ants=ants_afh*
full - no coefs signif; remove three-way interaction
pairwise interaction - des:ants*, vis:ants. USE THIS for main fig
no vis - des:ants** (but missing vis:ants. from above)
```{r}
# vis - full interactions
des_Nsurv.ants_afh.vis.full.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ants_afh, vis=vis,
                              interaction="full")

des_Nsurv.ants_afh.vis.full.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=des, treatment=ants_afh, vis=vis,
                                  model = des_Nsurv.ants_afh.vis.full.fits$mai.qb)

(des_Nsurv.ants_afh.full.qb.p <- plot_ci_vis(ci_data=des_Nsurv.ants_afh.vis.full.qb.ci, 
                              tenure=des, treatment=ants_afh, vis=vis,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.ants_afh.vis.full.fits$mai.qb) # all coefs ns; drop three-way interaction

# vis - pairwise interactions only
des_Nsurv.ants_afh.vis.pw.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ants_afh, vis=vis,
                              interaction="pw")

des_Nsurv.ants_afh.vis.pw.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=des, treatment=ants_afh, vis=vis,
                                  model = des_Nsurv.ants_afh.vis.pw.fits$mai.qb)

(des_Nsurv.ants_afh.pw.qb.p <- plot_ci_vis(ci_data=des_Nsurv.ants_afh.vis.pw.qb.ci, 
                              tenure=des, treatment=ants_afh, vis=vis,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.ants_afh.vis.pw.fits$mai.qb) # des:ants*, vis:ants.

# no vis - pairwise interactions only
des_Nsurv.ants_afh.pw.fits <- fit_surv(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ants_afh,
                              interaction="pw")

des_Nsurv.ants_afh.pw.qb.ci <- ci_for_plot(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=des, treatment=ants_afh,
                                  model = des_Nsurv.ants_afh.pw.fits$mai.qb)

(des_Nsurv.ants_afh.pw.qb.p <- plot_ci(ci_data=des_Nsurv.ants_afh.pw.qb.ci, 
                                  tenure=des, treatment=ants_afh,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.ants_afh.pw.fits$mai.qb) # des:ants**

## Drop in deviance: none significant, go with second model (vis, pairwise)
anova(des_Nsurv.ants_afh.vis.full.fits$mai.qb, des_Nsurv.ants_afh.vis.pw.fits$mai.qb, test = "Chisq") # ns
anova(des_Nsurv.ants_afh.vis.pw.fits$mai.qb, des_Nsurv.ants_afh.pw.fits$mai.qb, test = "Chisq") # ns
```

### n_survived/n_hatched ~ des+ants+vis+des:ants+des:vis+ants:vis
*ants=ants_ever*
full - no coefs signif; remove three-way interaction
pairwise interaction - des:ants*, vis:ants. USE THIS for main fig
no vis - des:ants** (but missing vis:ants. from above)
```{r}
# vis - full interactions
des_Nsurv.ants_ever.vis.full.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ants_ever, vis=vis,
                              interaction="full")

des_Nsurv.ants_ever.vis.full.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=des, treatment=ants_ever, vis=vis,
                                  model = des_Nsurv.ants_ever.vis.full.fits$mai.qb)

(des_Nsurv.ants_ever.vis.full.qb.p <- plot_ci_vis(ci_data=des_Nsurv.ants_ever.vis.full.qb.ci, 
                              tenure=des, treatment=ants_ever, vis=vis,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.ants_ever.vis.full.fits$mai.qb) # all coefs ns; drop three-way interaction

# vis - pairwise interactions only
des_Nsurv.ants_ever.vis.pw.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ants_ever, vis=vis,
                              interaction="pw")

des_Nsurv.ants_ever.vis.pw.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=des, treatment=ants_ever, vis=vis,
                                  model = des_Nsurv.ants_ever.vis.pw.fits$mai.qb)

(des_Nsurv.ants_ever.vis.pw.qb.p <- plot_ci_vis(ci_data=des_Nsurv.ants_ever.vis.pw.qb.ci, 
                              tenure=des, treatment=ants_ever, vis=vis,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.ants_ever.vis.pw.fits$mai.qb) # des:ants*, vis:ants.

# no vis - pairwise interactions only
des_Nsurv.ants_ever.pw.fits <- fit_surv(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ants_ever,
                              interaction="pw")

des_Nsurv.ants_ever.pw.qb.ci <- ci_for_plot(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=des, treatment=ants_ever,
                                  model = des_Nsurv.ants_ever.pw.fits$mai.qb)

(des_Nsurv.ants_ever.pw.qb.p <- plot_ci(ci_data=des_Nsurv.ants_ever.pw.qb.ci, 
                                  tenure=des, treatment=ants_ever,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.ants_ever.pw.fits$mai.qb) # des:ants**

## Drop in deviance: none significant, go with second model (vis, pairwise)
anova(des_Nsurv.ants_ever.vis.full.fits$mai.qb, des_Nsurv.ants_ever.vis.pw.fits$mai.qb, test = "Chisq") # ns
anova(des_Nsurv.ants_ever.vis.pw.fits$mai.qb, des_Nsurv.ants_ever.pw.fits$mai.qb, test = "Chisq") # ns
```

### n_survived/med_t5eggs ~ des+ants+vis+des:ants+des:vis+ants:vis
*ants=ants_ever*
full - no coefs signif;  USE THIS for predicting fitness
pairwise interaction - no signif coefs but ants:vis <0.10
no vis - no signif coefs but ants and des:ants <0.10
```{r}
# vis - full interactions
des_Esurv.ants_ever.vis.full.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=des, treatment=ants_ever, vis=vis,
                              interaction="full")

des_Esurv.ants_ever.vis.full.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=med_t5eggs,
                                  tenure=des, treatment=ants_ever, vis=vis,
                                  model = des_Esurv.ants_ever.vis.full.fits$mai.qb)

(des_Esurv.ants_ever.vis.full.qb.p <- plot_ci_vis(ci_data=des_Esurv.ants_ever.vis.full.qb.ci, 
                              tenure=des, treatment=ants_ever, vis=vis,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Esurv.ants_ever.vis.full.fits$mai.qb) # ** use this for predicting fitness

# vis - pairwise interactions only
des_Esurv.ants_ever.vis.pw.fits <- fit_surv_vis(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=des, treatment=ants_ever, vis=vis,
                              interaction="pw")

des_Esurv.ants_ever.vis.pw.qb.ci <- ci_for_plot_vis(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=med_t5eggs,
                                  tenure=des, treatment=ants_ever, vis=vis,
                                  model = des_Esurv.ants_ever.vis.pw.fits$mai.qb)

(des_Esurv.ants_ever.vis.pw.qb.p <- plot_ci_vis(ci_data=des_Esurv.ants_ever.vis.pw.qb.ci, 
                              tenure=des, treatment=ants_ever, vis=vis,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Esurv.ants_ever.vis.pw.fits$mai.qb) # no signif coefs but ants_ever:vis <0.10

# no vis - pairwise interactions only
des_Esurv.ants_ever.pw.fits <- fit_surv(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=des, treatment=ants_ever,
                              interaction="pw")

des_Esurv.ants_ever.pw.qb.ci <- ci_for_plot(data_in=surv_reg_data, 
                                  survNom=n_survived, survDen=med_t5eggs,
                                  tenure=des, treatment=ants_ever,
                                  model = des_Esurv.ants_ever.pw.fits$mai.qb)

(des_Esurv.ants_ever.pw.qb.p <- plot_ci(ci_data=des_Esurv.ants_ever.pw.qb.ci, 
                                  tenure=des, treatment=ants_ever,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Esurv.ants_ever.pw.fits$mai.qb) # no signif coefs but ants_ever and des:ants_ever <0.10

## Drop in deviance: none significant, go with second model (vis, pairwise)
anova(des_Esurv.ants_ever.vis.full.fits$mai.qb, des_Esurv.ants_ever.vis.pw.fits$mai.qb, test = "Chisq") # ns
anova(des_Esurv.ants_ever.vis.pw.fits$mai.qb, des_Esurv.ants_ever.pw.fits$mai.qb, test = "Chisq") # ns
```

### n_survived/med_t5eggs ~ med_t5eggs * ants * vis
*ants=ants_ever*
This is just impossible. There's too little data for ants never. Plus clutch size is confounded by guarding duration, and ants ever is also confounded by guarding duration.
*Is that a problem for other comparison?*

### n_survived/n_hatched ~ med_t5eggs * ants * vis
*ants=ants_ever*
Same problem with too few data as for n_hatched/med_t5eggs

#### Does removing late season clutches that likely didn't reach max n_N5 change the results?
```{r}
cutoff_date<-as_date("2019-06-10")
surv_reg_data_filt <- filter(surv_reg_data, initiation_date<=cutoff_date)

# hatching
des_hatch.ants_ever.pw.fits.filt <- fit_surv(data_in=surv_reg_data_filt, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ants_ever,
                              interaction="pw")

des_hatch.ants_ever.pw.qb.ci.filt <- ci_for_plot(data_in=surv_reg_data_filt, 
                                  survNom=n_hatched, survDen=med_t5eggs,
                                  tenure=des, treatment=ants_ever,
                                  model = des_hatch.ants_ever.pw.fits.filt$mai.qb)

(des_hatch.ants_ever.pw.qb.p.filt <- plot_ci(ci_data=des_hatch.ants_ever.pw.qb.ci.filt, 
                                  tenure=des, treatment=ants_ever,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_hatch.ants_ever.pw.fits.filt$mai.qb) 


# Nsurv
des_Nsurv.ants_ever.pw.fits.filt <- fit_surv(data_in=surv_reg_data_filt, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ants_ever,
                              interaction="pw")

des_Nsurv.ants_ever.pw.qb.ci.filt <- ci_for_plot(data_in=surv_reg_data_filt, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=des, treatment=ants_ever,
                                  model = des_Nsurv.ants_ever.pw.fits.filt$mai.qb)

(des_Nsurv.ants_ever.pw.qb.p.filt <- plot_ci(ci_data=des_Nsurv.ants_ever.pw.qb.ci.filt, 
                                  tenure=des, treatment=ants_ever,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.ants_ever.pw.fits.filt$mai.qb) # des:ants**


# Esurv
des_Esurv.ants_ever.pw.fits.filt <- fit_surv(data_in=surv_reg_data_filt, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=des, treatment=ants_ever,
                              interaction="pw")

des_Esurv.ants_ever.pw.qb.ci.filt <- ci_for_plot(data_in=surv_reg_data_filt, 
                                  survNom=n_survived, survDen=med_t5eggs,
                                  tenure=des, treatment=ants_ever,
                                  model = des_Esurv.ants_ever.pw.fits.filt$mai.qb)

(des_Esurv.ants_ever.pw.qb.p.filt <- plot_ci(ci_data=des_Esurv.ants_ever.pw.qb.ci.filt, 
                                  tenure=des, treatment=ants_ever,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Esurv.ants_ever.pw.fits.filt$mai.qb)

egg::ggarrange(des_hatch.ants_ever.pw.qb.p.filt+
                 theme(legend.position="none"),
               des_Nsurv.ants_ever.pw.qb.p.filt+
                 theme(legend.position="none"),
               des_Esurv.ants_ever.pw.qb.p.filt+
                 theme(legend.position="none")+ylim(0,1),
               labels=c("A","B","C"),
               nrow=3)
```

#### Does focusing only on the clutches where females were not removed change anything?
```{r}
surv_reg_data_filtFemRem <- filter(surv_reg_data, !females_removed)

# hatching
des_hatch.ants_ever.pw.fits.filtFemRem <- fit_surv(data_in=surv_reg_data_filtFemRem, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ants_ever,
                              interaction="pw")

des_hatch.ants_ever.pw.qb.ci.filtFemRem <- ci_for_plot(data_in=surv_reg_data_filtFemRem, 
                                  survNom=n_hatched, survDen=med_t5eggs,
                                  tenure=des, treatment=ants_ever,
                                  model = des_hatch.ants_ever.pw.fits.filtFemRem$mai.qb)

(des_hatch.ants_ever.pw.qb.p.filtFemRem <- plot_ci(ci_data=des_hatch.ants_ever.pw.qb.ci.filtFemRem, 
                                  tenure=des, treatment=ants_ever,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_hatch.ants_ever.pw.fits.filtFemRem$mai.qb) 


# Nsurv
des_Nsurv.ants_ever.pw.fits.filtFemRem <- fit_surv(data_in=surv_reg_data_filtFemRem, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ants_ever,
                              interaction="pw")

des_Nsurv.ants_ever.pw.qb.ci.filtFemRem <- ci_for_plot(data_in=surv_reg_data_filtFemRem, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=des, treatment=ants_ever,
                                  model = des_Nsurv.ants_ever.pw.fits.filtFemRem$mai.qb)

(des_Nsurv.ants_ever.pw.qb.p.filtFemRem <- plot_ci(ci_data=des_Nsurv.ants_ever.pw.qb.ci.filtFemRem, 
                                  tenure=des, treatment=ants_ever,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.ants_ever.pw.fits.filtFemRem$mai.qb) # des:ants**


# Esurv
des_Esurv.ants_ever.pw.fits.filtFemRem <- fit_surv(data_in=surv_reg_data_filtFemRem, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=des, treatment=ants_ever,
                              interaction="pw")

des_Esurv.ants_ever.pw.qb.ci.filtFemRem <- ci_for_plot(data_in=surv_reg_data_filtFemRem, 
                                  survNom=n_survived, survDen=med_t5eggs,
                                  tenure=des, treatment=ants_ever,
                                  model = des_Esurv.ants_ever.pw.fits.filtFemRem$mai.qb)

(des_Esurv.ants_ever.pw.qb.p.filtFemRem <- plot_ci(ci_data=des_Esurv.ants_ever.pw.qb.ci.filtFemRem, 
                                  tenure=des, treatment=ants_ever,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Esurv.ants_ever.pw.fits.filtFemRem$mai.qb)

egg::ggarrange(des_hatch.ants_ever.pw.qb.p.filtFemRem+
                 theme(legend.position="none"),
               des_Nsurv.ants_ever.pw.qb.p.filtFemRem+
                 theme(legend.position="none"),
               des_Esurv.ants_ever.pw.qb.p.filtFemRem+
                 theme(legend.position="none")+ylim(0,1),
               labels=c("A","B","C"),
               nrow=3)
```

```{r}
# Compare ants_treatment to ants_ever and unfilt to filt
(survivorship.ants_treatment.final.p <- 
    egg::ggarrange(des_hatch.pw.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.pw.qb.p+
                 theme(legend.position="none"),
               des_Esurv.pw.qb.p+
                 theme(legend.position="none")+ylim(0,1),
               labels=c("A","B","C"),
               nrow=1))

(survivorship.ants_ever.final.p <- 
    egg::ggarrange(des_hatch.ants_ever.pw.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.ants_ever.pw.qb.p+
                 theme(legend.position="none"),
               des_Esurv.ants_ever.pw.qb.p+
                 theme(legend.position="none")+ylim(0,1),
               labels=c("A","B","C"),
               nrow=1))

# ggsave("CHAPTER/survivorship.ants_treatment.final.png",
#        survivorship.ants_treatment.final.p,
#        device="png", width = 300, height = 110, units = "mm", dpi = "print")

# ggsave("CHAPTER/survivorship.ants_ever.final.png",
#        survivorship.ants_ever.final.p,
#        device="png", width = 300, height = 110, units = "mm", dpi = "print")
```


### Compare qaicc values from various models in a table
Method taken from: https://cran.r-project.org/web/packages/bbmle/vignettes/quasi.pdf

Fit the model twice, once with a regular likelihood model (family=binomial,
poisson, etc.) and once with the quasi- variant — extract the log-
likelihood from the former and the dispersion parameter from the latter.
```{r}
# Calculate qAICc
library(bbmle)

get_qaicc <- function(model.fits) {
  model.qaicc <- qAICc(model.fits$mai.b,
        dispersion=summary(model.fits$mai.qb)$dispersion,
        nobs = nrow(model.fits$mai.qb$data))
  return(model.qaicc)
}

des_hatch.vis.full.qaicc <- get_qaicc(des_hatch.vis.full.fits)
des_hatch.vis.pw.qaicc <- get_qaicc(des_hatch.vis.pw.fits)
des_hatch.pw.qaicc <- get_qaicc(des_hatch.pw.fits)
des_hatch.ants_ever.vis.full.qaicc <- get_qaicc(des_hatch.ants_ever.vis.full.fits)
des_hatch.ants_ever.vis.pw.qaicc <- get_qaicc(des_hatch.ants_ever.vis.pw.fits)
des_hatch.ants_ever.pw.qaicc <- get_qaicc(des_hatch.ants_ever.pw.fits)

des_hatch.qaicc <- data.frame(model = c("vis.full", "vis.pw", "pw",
                     "ants_ever.vis.full", "ants_ever.vis.pw", "ants_ever.pw"), 
       qaicc = c(des_hatch.vis.full.qaicc,
                 des_hatch.vis.pw.qaicc,
                 des_hatch.pw.qaicc,
                 des_hatch.ants_ever.vis.full.qaicc, 
                 des_hatch.ants_ever.vis.pw.qaicc, 
                 des_hatch.ants_ever.pw.qaicc))

des_Nsurv.vis.full.qaicc <- get_qaicc(des_Nsurv.vis.full.fits)
des_Nsurv.vis.pw.qaicc <- get_qaicc(des_Nsurv.vis.pw.fits)
des_Nsurv.pw.qaicc <- get_qaicc(des_Nsurv.pw.fits)
des_Nsurv.ants_ever.vis.full.qaicc <- get_qaicc(des_Nsurv.ants_ever.vis.full.fits)
des_Nsurv.ants_ever.vis.pw.qaicc <- get_qaicc(des_Nsurv.ants_ever.vis.pw.fits)
des_Nsurv.ants_ever.pw.qaicc <- get_qaicc(des_Nsurv.ants_ever.pw.fits)

des_Nsurv.qaicc <- data.frame(model = c("vis.full", "vis.pw", "pw",
                     "ants_ever.vis.full", "ants_ever.vis.pw", "ants_ever.pw"), 
       qaicc = c(des_Nsurv.vis.full.qaicc,
                 des_Nsurv.vis.pw.qaicc,
                 des_Nsurv.pw.qaicc,
                 des_Nsurv.ants_ever.vis.full.qaicc, 
                 des_Nsurv.ants_ever.vis.pw.qaicc, 
                 des_Nsurv.ants_ever.pw.qaicc))

des_Esurv.vis.full.qaicc <- get_qaicc(des_Esurv.vis.full.fits)
des_Esurv.vis.pw.qaicc <- get_qaicc(des_Esurv.vis.pw.fits)
des_Esurv.pw.qaicc <- get_qaicc(des_Esurv.pw.fits)
des_Esurv.ants_ever.vis.full.qaicc <- get_qaicc(des_Esurv.ants_ever.vis.full.fits)
des_Esurv.ants_ever.vis.pw.qaicc <- get_qaicc(des_Esurv.ants_ever.vis.pw.fits)
des_Esurv.ants_ever.pw.qaicc <- get_qaicc(des_Esurv.ants_ever.pw.fits)

des_Esurv.qaicc <- data.frame(model = c("vis.full", "vis.pw", "pw",
                     "ants_ever.vis.full", "ants_ever.vis.pw", "ants_ever.pw"), 
       qaicc = c(des_Esurv.vis.full.qaicc,
                 des_Esurv.vis.pw.qaicc,
                 des_Esurv.pw.qaicc,
                 des_Esurv.ants_ever.vis.full.qaicc, 
                 des_Esurv.ants_ever.vis.pw.qaicc, 
                 des_Esurv.ants_ever.pw.qaicc))
```

### Combining plots for paper
*ants=ants_ever* for all
n_hatched/med_t5eggs ~ des+ants+vis+des:ants+des:vis+ants:vis

```{r}
# n_hatched/med_t5eggs ~ des+ants+vis+des:ants+des:vis+ants:vis
des_hatch.qaicc
des_hatch.ants_ever.vis.full.qb.p # qaicc=254.8996
summary(des_hatch.ants_ever.vis.full.fits$mai.qb)
des_hatch.ants_ever.vis.pw.qb.p # qaicc=253.4002
summary(des_hatch.ants_ever.vis.pw.fits$mai.qb)
des_hatch.ants_ever.pw.qb.p # qaicc=251.2537 **>2
summary(des_hatch.ants_ever.pw.fits$mai.qb)

# n_survived/n_hatched ~ des+ants+vis+des:ants+des:vis+ants:vis
des_Nsurv.qaicc
des_Nsurv.ants_ever.vis.full.qb.p # qaicc=223.9026
summary(des_Nsurv.ants_ever.vis.full.fits$mai.qb)
des_Nsurv.ants_ever.vis.pw.qb.p # qaicc=223.0314
summary(des_Nsurv.ants_ever.vis.pw.fits$mai.qb)
des_Nsurv.ants_ever.pw.qb.p # qaicc=220.4654 **>2
summary(des_Nsurv.ants_ever.pw.fits$mai.qb)

# n_survived/med_t5eggs ~ des+ants+vis+des:ants+des:vis+ants:vis
summary(des_Esurv.ants_ever.vis.full.fits$mai.qb)
des_Esurv.ants_ever.vis.full.qb.p # qaicc=201.6597
summary(des_Esurv.ants_ever.vis.pw.fits$mai.qb)
des_Esurv.ants_ever.vis.pw.qb.p # qaicc=200.9795
summary(des_Esurv.ants_ever.pw.fits$mai.qb)
des_Esurv.ants_ever.pw.qb.p # qaicc=197.3052 **>2


# So the three best qaicc models to show in tables/plots of main all don't have vis:
des_hatch.ants_ever.pw.qb.p
summary(des_hatch.ants_ever.pw.fits$mai.qb)
des_Nsurv.ants_ever.pw.qb.p
summary(des_Nsurv.ants_ever.pw.fits$mai.qb)
des_Esurv.ants_ever.pw.qb.p
summary(des_Esurv.ants_ever.pw.fits$mai.qb)

(des_hatch.ants_ever.pw.qb.p <- plot_ci(ci_data=des_hatch.ants_ever.pw.qb.ci, 
                                  tenure=des, treatment=ants_ever,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

(des_Nsurv.ants_ever.pw.qb.p <- plot_ci(ci_data=des_Nsurv.ants_ever.pw.qb.ci, 
                                  tenure=des, treatment=ants_ever,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

(des_Esurv.ants_ever.pw.qb.p <- plot_ci(ci_data=des_Esurv.ants_ever.pw.qb.ci, 
                                  tenure=des, treatment=ants_ever,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

egg::ggarrange(des_hatch.ants_ever.pw.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.ants_ever.pw.qb.p+
                 theme(legend.position="none"),
               des_Esurv.ants_ever.pw.qb.p+ylim(0,1)+
                 theme(legend.position=c(0.8,0.9)),
               labels=c("A","B","C"),
               nrow=3)

# But should I show vis.pw in the supplement? Nothing interesting to see really. All the plots look the same.
egg::ggarrange(des_hatch.ants_ever.vis.pw.qb.p,
               des_Nsurv.ants_ever.vis.pw.qb.p,
               des_Esurv.ants_ever.vis.pw.qb.p+ylim(0,1),
               labels=c("A","B","C"),
               nrow=3)
```




### number of clutches on plant
The model performs well for hatching but overfits/underestimates survivorship. Would adding number of clutches help?
```{r}
clutch_survivorship_data %>% 
  filter(!is.na(`visited in 4 days`)) %>%
  select(location, med_t5eggs, n_hatched, n_survived,
         des=last_des_rel2h, ants=ants_removed, vis=`visited in 4 days`,
         females_removed, n_clutches_on_plant) %>%
  mutate(n_survived=ifelse(n_survived/n_hatched > 1,# if n_survived/n_hatched>1
                           n_hatched, n_survived), # force n_survived/n_hatched=1
         ants=ifelse(ants, "Removed", "Control"),
         Nclutches=cut(n_clutches_on_plant, breaks=c(0,1,2,7), labels=c("1","2",">2"))) %>%
  count(Nclutches, ants, vis)

clutch_survivorship_data %>% 
  filter(!is.na(`visited in 4 days`)) %>%
  select(location, med_t5eggs, n_hatched, n_survived,
         des=last_des_rel2h, ants=ants_removed, vis=`visited in 4 days`,
         females_removed, n_clutches_on_plant) %>%
  mutate(n_survived=ifelse(n_survived/n_hatched > 1,# if n_survived/n_hatched>1
                           n_hatched, n_survived), # force n_survived/n_hatched=1
         ants=ifelse(ants, "Removed", "Control"),
         Nclutches=cut(n_clutches_on_plant, breaks=c(0,1,2,7), labels=c("1","2",">2"))) %>%
  ggplot(data=.,aes(x=des, y=n_hatched, shape=ants, color=Nclutches)) +
    geom_point() +
    geom_smooth(method=lm, se=F) +
  facet_wrap(~vis)

clutch_survivorship_data %>% 
  filter(!is.na(`visited in 4 days`)) %>%
  select(location, med_t5eggs, n_hatched, n_survived,
         des=last_des_rel2h, ants=ants_removed, vis=`visited in 4 days`,
         females_removed, n_clutches_on_plant) %>%
  mutate(n_survived=ifelse(n_survived/n_hatched > 1,# if n_survived/n_hatched>1
                           n_hatched, n_survived), # force n_survived/n_hatched=1
         ants=ifelse(ants, "Removed", "Control"),
         Nclutches=cut(n_clutches_on_plant, breaks=c(0,1,2,7), labels=c("1","2",">2"))) %>%
  ggplot(data=.,aes(x=des, y=n_survived, shape=ants, color=Nclutches)) +
    geom_point() +
    geom_smooth(method=lm, se=F) +
  facet_wrap(~vis)


clutch_survivorship_data %>% 
  filter(!is.na(`visited in 4 days`)) %>%
  select(location, med_t5eggs, n_hatched, n_survived,
         des=last_des_rel2h, ants=ants_removed, vis=`visited in 4 days`,
         females_removed, n_clutches_on_plant) %>%
  mutate(n_survived=ifelse(n_survived/n_hatched > 1,# if n_survived/n_hatched>1
                           n_hatched, n_survived), # force n_survived/n_hatched=1
         ants=ifelse(ants, "Removed", "Control")) %>%
  count(n_clutches_on_plant)

```

Number of clutches per plants doesn't explain the high n_survived counts!
```{r}
clutch_survivorship_data %>% 
  filter(!is.na(`visited in 4 days`)) %>%
  select(location, med_t5eggs, n_hatched, n_survived,
         des=last_des_rel2h, ants=ants_removed, vis=`visited in 4 days`,
         females_removed, n_clutches_on_plant) %>%
  mutate(n_survived=ifelse(n_survived/n_hatched > 1,# if n_survived/n_hatched>1
                           n_hatched, n_survived), # force n_survived/n_hatched=1
         ants=ifelse(ants, "Removed", "Control"),
         Nclutches=cut(n_clutches_on_plant, breaks=c(0,1,2,7), labels=c("1","2",">2"))) %>%
  ggplot(data=.,aes(x=des, y=n_survived/n_hatched, linetype=ants, color=Nclutches)) +
    geom_point() +
    geom_smooth(method=lm, se=F) +
  facet_wrap(~vis)

clutch_survivorship_data %>% 
  filter(!is.na(`visited in 4 days`),
         n_survived>0) %>%
  select(location, med_t5eggs, n_hatched, n_survived,
         des=last_des_rel2h, ants=ants_removed, vis=`visited in 4 days`,
         females_removed, n_clutches_on_plant) %>%
  mutate(n_survived=ifelse(n_survived/n_hatched > 1,# if n_survived/n_hatched>1
                           n_hatched, n_survived), # force n_survived/n_hatched=1
         ants=ifelse(ants, "Removed", "Control"),
         Nclutches=cut(n_clutches_on_plant, breaks=c(0,1,2,7), labels=c("1","2",">2"))) %>%
  ggplot(data=.,aes(x=des, y=n_survived/n_hatched, linetype=ants, color=Nclutches)) +
    geom_point() +
    geom_smooth(method=lm, se=F) +
  facet_wrap(~vis)
```

Dorms?
It does look like there is some variation in the 
```{r}
clutch_survivorship_data %>% 
  filter(!is.na(`visited in 4 days`)) %>%
  select(location, med_t5eggs, n_hatched, n_survived,
         des=last_des_rel2h, ants=ants_removed, vis=`visited in 4 days`,
         females_removed, n_clutches_on_plant) %>%
  mutate(n_survived=ifelse(n_survived/n_hatched > 1,# if n_survived/n_hatched>1
                           n_hatched, n_survived), # force n_survived/n_hatched=1
         ants=ifelse(ants, "Removed", "Control"),
         Nclutches=cut(n_clutches_on_plant, breaks=c(0,1,2,7), labels=c("1","2",">2")),
         Dorm=substr(location,1,1)) %>%
  ggplot(data=.,aes(x=des, y=n_survived/n_hatched, color=Dorm, shape=ants, linetype=ants)) +
    geom_point() +
    geom_smooth(method=lm, se=F) +
  facet_wrap(~vis)

clutch_survivorship_data %>% 
  filter(!is.na(`visited in 4 days`)) %>%
  select(location, med_t5eggs, n_hatched, n_survived,
         des=last_des_rel2h, ants=ants_removed, vis=`visited in 4 days`,
         females_removed, n_clutches_on_plant) %>%
  mutate(n_survived=ifelse(n_survived/n_hatched > 1,# if n_survived/n_hatched>1
                           n_hatched, n_survived), # force n_survived/n_hatched=1
         ants=ifelse(ants, "Removed", "Control"),
         Nclutches=cut(n_clutches_on_plant, breaks=c(0,1,2,7), labels=c("1","2",">2")),
         Dorm=substr(location,1,1)) %>%
  ggplot(data=.,aes(x=des, y=n_hatched/med_t5eggs, color=Dorm, shape=ants, linetype=ants)) +
    geom_point() +
    geom_smooth(method=lm, se=F)+
  facet_wrap(~vis)
```


### A very quick exploration of plant-level nymph survivorship
Note that I shouldn't include clutches that were laid so late that nymphs (or adults) had not all hatched/survived, depending on the metric of interest.
```{r}
N_plant_max_data <- All_data_v6_clutch_status_stats_v2 %>%
  mutate(DormPlant = paste0(Dorm, Plant)) %>%
  group_by(Date, DormPlant) %>%
    filter(any(!is.na(initiation_date))) %>%
    distinct(Date, DormPlant, Eggs, N1, N2, N5, n_A, n_clutches_on_plant) %>%
    summarize(N1_P = sum(N1, na.rm=T),
              N2_P = sum(N2, na.rm=T),
              N5_P = sum(N5, na.rm=T),
              N_P = sum(N1, N2, N5, na.rm=T),
              N5toA_P = sum(N5, n_A, na.rm=T),
              A_P = sum(n_A, na.rm=T)) %>%
  ungroup() %>%
  group_by(DormPlant) %>%
    summarize(N1_P_max = max(N1_P),
              N2_P_max = max(N2_P),
              N5_P_max = max(N5_P),
              N_P_max = max(N_P),
              N5toA_P_max = max(N5toA_P),
              A_P_max = max(A_P)) %>%
  ungroup()

moms_plant_data <- visited_1st_4d_data %>%
  filter(!is.na(initiation_date)) %>%
  separate(location, "_", into=c("DormPlant","Leaf")) %>%
  group_by(DormPlant) %>%
  summarize(n_moms_alltime = n(),
            n_moms_leaf_H = sum(est_rel2h>=0, na.rm=T),
            any_moms_leaf_H = any(est_rel2h>=0, na.rm=T),
            last_visit_ends_P = max(visit_ends, na.rm=T),
            n_moms_P_H = sum((last_visit_ends_P-est_hatch)>=0, na.rm=T),
            any_moms_P_H = any((last_visit_ends_P-est_hatch)>=0, na.rm=T),
            n_moms_P_8afterH = sum((last_visit_ends_P-est_hatch+8)>=0, na.rm=T),
            any_moms_P_8afterH = sum((last_visit_ends_P-est_hatch+8)>=0, na.rm=T),
            n_clutches_on_plant = first(n_clutches_on_plant)) %>%
  ungroup()

ant_counts_DormPlant <- ant_counts %>%
  separate(location, "_", into=c("DormPlant","Leaf")) %>%
  group_by(DormPlant) %>%
    summarize(any_antsP = ifelse(any(ever_antsP, na.rm=T), "some ants", "never ants")) %>%
  ungroup %>%
  distinct(DormPlant, any_antsP)
  
top5eggs_DormPlant <- top5eggs_summary %>%
  separate(location, "_", into=c("DormPlant","Leaf")) %>%
  group_by(DormPlant) %>%
    summarize(sum_medt5eggsP = sum(med_t5eggs, na.rm=T)) %>%
  ungroup()

# when is the maximum number of nymphs reached?
maxN_plant_date_data <- All_data_v6_clutch_status_stats_v2 %>%
  mutate(DormPlant = paste0(Dorm, Plant)) %>%
  group_by(Date, DormPlant) %>%
    filter(any(!is.na(initiation_date))) %>%
    distinct(Date, DormPlant, Eggs, N1, N2, N5, n_A, n_clutches_on_plant) %>%
    summarize(N_plant = sum(N1, N2, N5, na.rm=T)) %>%
  ungroup() %>%
  group_by(DormPlant) %>% dplyr::slice_max(N_plant, with_ties=F) %>% ungroup() %>%
  select(DormPlant, maxN_plant_date = Date)

# when is the maximum number of adults reached?
maxN5toA_plant_date_data <- All_data_v6_clutch_status_stats_v2 %>%
  mutate(DormPlant = paste0(Dorm, Plant)) %>%
  group_by(Date, DormPlant) %>%
    filter(any(!is.na(initiation_date))) %>%
    distinct(Date, DormPlant, Eggs, N1, N2, N5, n_A, n_clutches_on_plant) %>%
    summarize(N5toA_plant = sum(n_A, N5, na.rm=T)) %>%
  ungroup() %>%
  group_by(DormPlant) %>% dplyr::slice_max(N5toA_plant, with_ties=F) %>% ungroup() %>%
  select(DormPlant, maxN5toA_plant_date = Date)
  
last_obs_date <- All_data_v6_clutch_status_stats_v2 %>%
  mutate(DormPlant = paste0(Dorm, Plant)) %>%
  group_by(DormPlant) %>% dplyr::slice_max(Date, with_ties=F) %>% ungroup() %>%
  select(DormPlant, last_obs_date = Date)

survival_plant_data <- N_plant_max_data %>%
  left_join(moms_plant_data) %>%
  left_join(ant_counts_DormPlant) %>%
  left_join(top5eggs_DormPlant) %>%
  left_join(maxN_plant_date_data) %>%
  left_join(maxN5toA_plant_date_data) %>%
  left_join(last_obs_date)
  

survival_plant_data %>%
  filter(maxN_plant_date>=(last_obs_date-4))

survival_plant_data %>%
  filter(maxN5toA_plant_date>=(last_obs_date-4))

survival_plant_data %>%
  filter(maxN5toA_plant_date==last_obs_date)

survival_plant_data %>%
  filter(!is.na(any_antsP)) %>% # why does these exist?
  #filter(!(maxN_plant_date==last_obs_date)) %>%
  ggplot(data=., aes(x=any_moms_P_H, y=N_P_max/sum_medt5eggsP, 
                     fill=any_antsP)) +
  geom_boxplot() +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3) +
  facet_wrap(~n_clutches_on_plant>1)

survival_plant_data %>%
  filter(!is.na(any_antsP)) %>% # why does these exist?
  #filter(!(maxN5toA_plant_date==last_obs_date)) %>%
  ggplot(data=., aes(x=any_moms_P_H, y=N5toA_P_max/N_P_max, 
                     fill=any_antsP)) +
  geom_boxplot() +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3) +
  facet_wrap(~n_clutches_on_plant>1)

survival_plant_data %>%
  filter(!is.na(any_antsP)) %>% # why does these exist?
  filter(!(maxN5toA_plant_date==last_obs_date)) %>%
  ggplot(data=., aes(x=any_moms_P_H, y=N5toA_P_max/N_P_max, 
                     fill=any_antsP)) +
  geom_boxplot() +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3) +
  facet_wrap(~n_clutches_on_plant>1)

survival_plant_data %>%
  filter(!(maxN5toA_plant_date>=(last_obs_date-8))) %>%
  ggplot(data=., aes(x=any_moms_P_H, y=N5toA_P_max/sum_medt5eggsP, 
                     fill=any_antsP)) +
  geom_boxplot() +
  geom_point(pch = 21, position=position_jitterdodge(jitter.width=0.25), size=3) +
  facet_wrap(~n_clutches_on_plant>1)
  
survival_plant_data %>%
  filter(!(maxN5toA_plant_date>=(last_obs_date-8))) %>%
  ggplot(data=., aes(x=any_moms_P_H, y=N5toA_P_max/N_P_max, 
                     fill=any_antsP)) +
  geom_boxplot()

# Next step: what is the expected interval from laying eggs to new adults, and from hatching to new adults?
# Here, I didn't add N5 plus A, but I did for previous iterations of the analysis. 

# first nymphs/adults
N1_first_date <- clutch_unambig_NOr_revised_ENAa_summary_v2 %>%
  filter(N1_NOr>0) %>% group_by(NOr_rev_loc) %>% dplyr::slice_head(n=1) %>% ungroup() %>%
  select(NOr_rev_loc, N1_first_date=Date)

N2_first_date <- clutch_unambig_NOr_revised_ENAa_summary_v2 %>%
  filter(N2_NOr>0) %>% group_by(NOr_rev_loc) %>% dplyr::slice_head(n=1) %>% ungroup() %>%
  select(NOr_rev_loc, N2_first_date=Date)

N5_first_date <- clutch_unambig_NOr_revised_ENAa_summary_v2 %>%
  filter(N5_NOr>0) %>% group_by(NOr_rev_loc) %>% dplyr::slice_head(n=1) %>% ungroup() %>%
  select(NOr_rev_loc, N5_first_date=Date)

A_first_date <- clutch_unambig_NOr_revised_ENAa_summary_v2 %>%
  filter(A_NOr>0) %>% group_by(NOr_rev_loc) %>% dplyr::slice_head(n=1) %>% ungroup() %>%
  select(NOr_rev_loc, A_first_date=Date)

clutch_first_dates_data <- clutch_unambig_NOr_revised_ENAa_summary_imfilt_success_summary_v2 %>%
  select(NOr_rev_loc, initiation_date, females_removed, ants_removed) %>%
  left_join(N1_first_date) %>%
  left_join(N2_first_date) %>%
  left_join(N5_first_date) %>%
  left_join(A_first_date) %>%
  mutate(E2N_int = N1_first_date-initiation_date,
         N2N5_int = N5_first_date-N1_first_date,
         E2N5_int = N5_first_date-initiation_date,
         E2A_int = A_first_date-initiation_date,
         N52A_int = A_first_date-N5_first_date,
         N12N2_int = N2_first_date-N1_first_date)

clutch_first_dates_data %>%
  ggplot(data=.) +
  geom_boxplot(aes(x="E2N", y=E2N_int)) +
  geom_jitter(aes(x="E2N", y=E2N_int)) +
  geom_boxplot(aes(x="N2N5", y=N2N5_int)) + 
  geom_jitter(aes(x="N2N5", y=N2N5_int)) +
  geom_boxplot(aes(x="E2N5", y=E2N5_int)) +
  geom_jitter(aes(x="E2N5", y=E2N5_int)) +
  geom_boxplot(aes(x="E2A", y=E2A_int)) +
  geom_jitter(aes(x="E2A", y=E2A_int)) +
  geom_boxplot(aes(x="N52A", y=N52A_int)) +
  geom_jitter(aes(x="N52A", y=N52A_int)) +
  geom_boxplot(aes(x="N12N2", y=N12N2_int)) +
  geom_jitter(aes(x="N12N2", y=N12N2_int))
  
# most clutches have begun to yield N5 by 60 days after initiation (median ~ 50 days)

surv_reg_data_plant <- clutch_survivorship_data %>% 
  filter(!is.na(`visited in 4 days`)) %>%
  select(location, med_t5eggs, n_hatched, n_survived,
         des=last_des_rel2h, ants_removed, vis=`visited in 4 days`,
         females_removed) %>%
  mutate(n_survived = ifelse(n_survived/n_hatched > 1,# if n_survived/n_hatched>1
                             n_hatched, n_survived), # force n_survived/n_hatched=1
         ant_treatment=ifelse(ants_removed, "Removed", "Control")) %>%
  left_join(select(ant_counts, location, 
                   ever_antsP_b4h, ever_antsP_afh, ever_antsP)) %>%
  mutate(ants_b4h=ifelse(ever_antsP_b4h," ever", " never"),
         ants_afh=ifelse(ever_antsP_afh," ever"," never"),
         ants_ever=ifelse(ever_antsP," ever"," never"))
```

Does latest desert date on *plant* explain the high hatching success for early latest desertion date on clutch?
```{r}
surv_reg_data_LastDesPlant <- surv_reg_data #%>% 
  #separate(location, into = c("DormPlant", "Leaf"), sep="_", remove=FALSE) %>%
  #left_join(dplyr::select(moms_plant_data, DormPlant, last_visit_ends_P), by="DormPlant") %>%
  #mutate(last_desP_rel2h = last_visit_ends_P-est_hatch) 

ggplot(data = surv_reg_data_LastDesPlant, aes(x=des, y = last_desP_rel2h)) +
  geom_count(aes(color=vis), alpha=0.50) +
  geom_abline(slope=1,intercept=0, color="red")

ggplot(data = filter(surv_reg_data_LastDesPlant, !females_removed), aes(x=des, y = last_desP_rel2h)) +
  geom_count(aes(color=vis), alpha=0.50) +
  geom_abline(slope=1,intercept=0, color="red")

# hatching
des_hatch.ants_ever.pw.fits.LastDesPlant <- fit_surv(data_in=surv_reg_data_LastDesPlant, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=last_desP_rel2h, treatment=ants_ever,
                              interaction="pw")

des_hatch.ants_ever.pw.qb.ci.LastDesPlant <- ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
                                  survNom=n_hatched, survDen=med_t5eggs,
                                  tenure=last_desP_rel2h, treatment=ants_ever,
                                  model = des_hatch.ants_ever.pw.fits.LastDesPlant$mai.qb)

(des_hatch.ants_ever.pw.qb.p.LastDesPlant <- plot_ci(ci_data=des_hatch.ants_ever.pw.qb.ci.LastDesPlant, 
                                  tenure=last_desP_rel2h, treatment=ants_ever,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion from the plant relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_hatch.ants_ever.pw.fits.LastDesPlant$mai.qb) 


# Nsurv
des_Nsurv.ants_ever.pw.fits.LastDesPlant <- fit_surv(data_in=surv_reg_data_LastDesPlant, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=last_desP_rel2h, treatment=ants_ever,
                              interaction="pw")

des_Nsurv.ants_ever.pw.qb.ci.LastDesPlant <- ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=last_desP_rel2h, treatment=ants_ever,
                                  model = des_Nsurv.ants_ever.pw.fits.LastDesPlant$mai.qb)

(des_Nsurv.ants_ever.pw.qb.p.LastDesPlant <- plot_ci(ci_data=des_Nsurv.ants_ever.pw.qb.ci.LastDesPlant, 
                                  tenure=last_desP_rel2h, treatment=ants_ever,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion from the plant relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.ants_ever.pw.fits.LastDesPlant$mai.qb) # des:ants**


# Esurv
des_Esurv.ants_ever.pw.fits.LastDesPlant <- fit_surv(data_in=surv_reg_data_LastDesPlant, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=last_desP_rel2h, treatment=ants_ever,
                              interaction="pw")

des_Esurv.ants_ever.pw.qb.ci.LastDesPlant <- ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
                                  survNom=n_survived, survDen=med_t5eggs,
                                  tenure=last_desP_rel2h, treatment=ants_ever,
                                  model = des_Esurv.ants_ever.pw.fits.LastDesPlant$mai.qb)

(des_Esurv.ants_ever.pw.qb.p.LastDesPlant <- plot_ci(ci_data=des_Esurv.ants_ever.pw.qb.ci.LastDesPlant, 
                                  tenure=last_desP_rel2h, treatment=ants_ever,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion from the plant relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Esurv.ants_ever.pw.fits.LastDesPlant$mai.qb)

egg::ggarrange(des_hatch.ants_ever.pw.qb.p.LastDesPlant+
                 theme(legend.position="none"),
               des_Nsurv.ants_ever.pw.qb.p.LastDesPlant+
                 theme(legend.position="none"),
               des_Esurv.ants_ever.pw.qb.p.LastDesPlant+
                 theme(legend.position="none")+ylim(0,1),
               labels=c("A","B","C"),
               nrow=3)

des_hatch.ants_ever.LastDesPlant.tbl <- 
  tbl_regression(des_hatch.ants_ever.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()
des_Nsurv.ants_ever.LastDesPlant.tbl <- 
  tbl_regression(des_Nsurv.ants_ever.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()
des_Esurv.ants_ever.LastDesPlant.tbl <- 
  tbl_regression(des_Esurv.ants_ever.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()

(ants_ever.LastDesPlant.tbl_merge <- 
  tbl_merge(
    tbls = list(des_hatch.ants_ever.LastDesPlant.tbl, 
                des_Nsurv.ants_ever.LastDesPlant.tbl, 
                des_Esurv.ants_ever.LastDesPlant.tbl),
    tab_spanner = c("**Hatching success**", 
                    "**Survivorship of nymphs**", 
                    "**Survivorship of eggs**")
  ) %>%
  modify_header(label = "**Variable**") %>%
  bold_labels() %>% italicize_levels())

```



ants treatment
```{r}
# hatching
des_hatch.pw.fits.LastDesPlant <- fit_surv(data_in=surv_reg_data_LastDesPlant, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=last_desP_rel2h, treatment=ant_treatment,
                              interaction="pw")

des_hatch.pw.qb.ci.LastDesPlant <- ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
                                  survNom=n_hatched, survDen=med_t5eggs,
                                  tenure=last_desP_rel2h, treatment=ant_treatment,
                                  model = des_hatch.pw.fits.LastDesPlant$mai.qb)

(des_hatch.pw.qb.p.LastDesPlant <- plot_ci(ci_data=des_hatch.pw.qb.ci.LastDesPlant, 
                                  tenure=last_desP_rel2h, treatment=ant_treatment,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion from the plant relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_hatch.pw.fits.LastDesPlant$mai.qb) 


# Nsurv
des_Nsurv.pw.fits.LastDesPlant <- fit_surv(data_in=surv_reg_data_LastDesPlant, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=last_desP_rel2h, treatment=ant_treatment,
                              interaction="pw")

des_Nsurv.pw.qb.ci.LastDesPlant <- ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
                                  survNom=n_survived, survDen=n_hatched,
                                  tenure=last_desP_rel2h, treatment=ant_treatment,
                                  model = des_Nsurv.pw.fits.LastDesPlant$mai.qb)

(des_Nsurv.pw.qb.p.LastDesPlant <- plot_ci(ci_data=des_Nsurv.pw.qb.ci.LastDesPlant, 
                                  tenure=last_desP_rel2h, treatment=ant_treatment,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion from the plant relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Nsurv.pw.fits.LastDesPlant$mai.qb) # des:ants**


# Esurv
des_Esurv.pw.fits.LastDesPlant <- fit_surv(data_in=surv_reg_data_LastDesPlant, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=last_desP_rel2h, treatment=ant_treatment,
                              interaction="pw")

des_Esurv.pw.qb.ci.LastDesPlant <- ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
                                  survNom=n_survived, survDen=med_t5eggs,
                                  tenure=last_desP_rel2h, treatment=ant_treatment,
                                  model = des_Esurv.pw.fits.LastDesPlant$mai.qb)

(des_Esurv.pw.qb.p.LastDesPlant <- plot_ci(ci_data=des_Esurv.pw.qb.ci.LastDesPlant, 
                                  tenure=last_desP_rel2h, treatment=ant_treatment,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion from the plant relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

summary(des_Esurv.pw.fits.LastDesPlant$mai.qb)

egg::ggarrange(des_hatch.pw.qb.p.LastDesPlant+
                 theme(legend.position="none"),
               des_Nsurv.pw.qb.p.LastDesPlant+
                 theme(legend.position="none"),
               des_Esurv.pw.qb.p.LastDesPlant+
                 theme(legend.position="none")+ylim(0,1),
               labels=c("A","B","C"),
               nrow=3)

des_hatch.LastDesPlant.tbl <- 
  tbl_regression(des_hatch.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ant_treatment ~ "Ants")) %>% bold_p()
des_Nsurv.LastDesPlant.tbl <- 
  tbl_regression(des_Nsurv.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ant_treatment ~ "Ants")) %>% bold_p()
des_Esurv.LastDesPlant.tbl <- 
  tbl_regression(des_Esurv.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ant_treatment ~ "Ants")) %>% bold_p()

(treatment.LastDesPlant.tbl_merge <- 
  tbl_merge(
    tbls = list(des_hatch.LastDesPlant.tbl, 
                des_Nsurv.LastDesPlant.tbl, 
                des_Esurv.LastDesPlant.tbl),
    tab_spanner = c("**Hatching success**", 
                    "**Survivorship of nymphs**", 
                    "**Survivorship of eggs**")
  ) %>%
  modify_header(label = "**Variable**") %>%
  bold_labels() %>% italicize_levels())

# qaicc
des_hatch.qaicc
get_qaicc(des_hatch.pw.fits.LastDesPlant)
des_Nsurv.qaicc
get_qaicc(des_Nsurv.pw.fits.LastDesPlant)
des_Esurv.qaicc
get_qaicc(des_Esurv.pw.fits.LastDesPlant)
```


# Final stats, plots for paper
main = ants_removed vs. control
supplement = ever ants vs. never any ants

## dataset summary table
### main
last_desL*ants_ever
```{r}

(surv_reg_data.tbl_summary.ants_ever <- surv_reg_data %>%
  mutate(ants = ifelse(ever_antsP, "Ever ants", "Never ants"),
         females = ifelse(females_removed, "Females removed", "Control"),
         `desertion date rel. to hatch` = des,
         `visited early` = vis,
         `n eggs` = med_t5eggs,
         `n hatched` = n_hatched,
         `n survived` = n_survived) %>%
  select(ants, females, `desertion date rel. to hatch`, `visited early`, 
         `n eggs`, `n hatched`, `n survived`) %>%
  group_by(females, ants) %>%
  tbl_summary(by = ants) %>%
  bold_labels() %>% italicize_levels() %>%
  add_n() %>% add_p() %>% bold_p())

surv_reg_data.tbl_summary.ants_ever %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv.data_summary.desL.ants_ever.docx")
```

### supp
last_desL*ant_treatment
```{r}
(surv_reg_data.tbl_summary.ants_treatment <- surv_reg_data %>%
  mutate(ants = ifelse(ants_removed, "Ant exclusion", "Control"),
         females = ifelse(females_removed, "Females removed", "Control"),
         `desertion date rel. to hatch` = des,
         `visited early` = vis,
         `n eggs` = med_t5eggs,
         `n hatched` = n_hatched,
         `n survived` = n_survived) %>%
  select(ants, females, `desertion date rel. to hatch`, `visited early`, 
         `n eggs`, `n hatched`, `n survived`) %>%
  group_by(females, ants) %>%
  tbl_summary(by = ants) %>%
  bold_labels() %>% italicize_levels() %>%
  add_n() %>% add_p() %>% bold_p())

surv_reg_data.tbl_summary.ants_treatment %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv.data_summary.desL.ants_treatment.docx")
```

last_desP*ants_ever
```{r}
(surv_reg_data.tbl_summary.ants_ever.LastDesPlant <- surv_reg_data_LastDesPlant %>%
  mutate(ants = ifelse(ever_antsP, "Ever ants", "Never ants"),
         females = ifelse(females_removed, "Females removed", "Control"),
         `desertion of clutch rel. to hatch` = des,
         `desertion of plant rel. to hatch` = last_desP_rel2h,
         `visited early` = vis,
         `n eggs` = med_t5eggs,
         `n hatched` = n_hatched,
         `n survived` = n_survived) %>%
  select(ants, females, `desertion of clutch rel. to hatch`, `desertion of plant rel. to hatch`,
         `n eggs`, `n hatched`, `n survived`) %>%
  tbl_strata(
    strata = females,
    ~.x %>%
      tbl_summary(by = ants) %>% bold_labels() %>% italicize_levels() %>% add_n()))

surv_reg_data.tbl_summary.ants_ever.LastDesPlant %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv.data_summary.desP.ants_ever.docx")
```

## stats
### main
last_desL*ants_ever
```{r}
des_hatch.ants_ever.tbl <- 
  tbl_regression(des_hatch.ants_ever.pw.fits$mai.qb, exponentiate=T,
                 label=list(des ~ "Desertion rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()
des_Nsurv.ants_ever.tbl <- 
  tbl_regression(des_Nsurv.ants_ever.pw.fits$mai.qb, exponentiate=T,
                 label=list(des ~ "Desertion rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()
des_Esurv.ants_ever.tbl <- 
  tbl_regression(des_Esurv.ants_ever.pw.fits$mai.qb, exponentiate=T,
                 label=list(des ~ "Desertion rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()

(ants_ever.tbl_merge <- 
  tbl_merge(
    tbls = list(des_hatch.ants_ever.tbl, 
                des_Nsurv.ants_ever.tbl, 
                des_Esurv.ants_ever.tbl),
    tab_spanner = c("**Hatching success**", 
                    "**Survivorship of nymphs**", 
                    "**Survivorship of eggs**")
  ) %>%
  modify_header(label = "**Variable**") %>%
  bold_labels() %>% italicize_levels())

ants_ever.tbl_merge %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv.reg_summary.desL.ants_ever.docx")
```

### supp
last_desL*ant_treatment
```{r}
# qaicc
des_hatch.qaicc
des_Nsurv.qaicc
des_Esurv.qaicc

# So the three best qaicc models to show in tables/plots of main all don't have vis:
summary(des_hatch.pw.fits$mai.qb)
summary(des_Nsurv.pw.fits$mai.qb)
summary(des_Esurv.pw.fits$mai.qb)

des_hatch.ants_trt.tbl <- 
  tbl_regression(des_hatch.pw.fits$mai.qb, exponentiate=T,
                 label=list(des ~ "Desertion rel. hatch",
                          ant_treatment ~ "Ants")) %>% bold_p()
des_Nsurv.ants_trt.tbl <- tbl_regression(des_Nsurv.pw.fits$mai.qb, exponentiate=T,
                 label=list(des ~ "Desertion rel. hatch",
                          ant_treatment ~ "Ants")) %>% bold_p()
des_Esurv.ants_trt.tbl <- tbl_regression(des_Esurv.pw.fits$mai.qb, exponentiate=T,
                 label=list(des ~ "Desertion rel. hatch",
                          ant_treatment ~ "Ants")) %>% bold_p()

(ants_trt.tbl_merge <- 
  tbl_merge(
    tbls = list(des_hatch.ants_trt.tbl, 
                des_Nsurv.ants_trt.tbl, 
                des_Esurv.ants_trt.tbl),
    tab_spanner = c("**Hatching success**", 
                    "**Survivorship of nymphs**", 
                    "**Survivorship of eggs**")
  ) %>%
  modify_header(label = "**Variable**") %>%
  bold_labels() %>% italicize_levels())

ants_trt.tbl_merge %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv.reg_summary.desL.ants_treatment.docx")
```

last_desP*ants_ever
```{r}
# qaicc
des_hatch.qaicc
get_qaicc(des_hatch.ants_ever.pw.fits.LastDesPlant)
des_Nsurv.qaicc
get_qaicc(des_Nsurv.ants_ever.pw.fits.LastDesPlant)
des_Esurv.qaicc
get_qaicc(des_Esurv.ants_ever.pw.fits.LastDesPlant)

# So the three best qaicc models to show in tables/plots of main all don't have vis:
summary(des_hatch.ants_ever.pw.fits.LastDesPlant$mai.qb)
summary(des_Nsurv.ants_ever.pw.fits.LastDesPlant$mai.qb)
summary(des_Esurv.ants_ever.pw.fits.LastDesPlant$mai.qb)

des_hatch.ants_ever.LastDesPlant.tbl <- 
  tbl_regression(des_hatch.ants_ever.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()
des_Nsurv.ants_ever.LastDesPlant.tbl <- 
  tbl_regression(des_Nsurv.ants_ever.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()
des_Esurv.ants_ever.LastDesPlant.tbl <- 
  tbl_regression(des_Esurv.ants_ever.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()

(ants_ever.LastDesPlant.tbl_merge <- 
  tbl_merge(
    tbls = list(des_hatch.ants_ever.LastDesPlant.tbl, 
                des_Nsurv.ants_ever.LastDesPlant.tbl, 
                des_Esurv.ants_ever.LastDesPlant.tbl),
    tab_spanner = c("**Hatching success**", 
                    "**Survivorship of nymphs**", 
                    "**Survivorship of eggs**")
  ) %>%
  modify_header(label = "**Variable**") %>%
  bold_labels() %>% italicize_levels())

ants_ever.LastDesPlant.tbl_merge %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv.reg_summary.desP.ants_ever.docx")
```


## figures
### main
```{r}
des_hatch.ants_ever.pw.qb.p <- plot_ci(ci_data=des_hatch.ants_ever.pw.qb.ci, 
                                  tenure=des, treatment=ants_ever,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

des_Nsurv.ants_ever.pw.qb.p <- plot_ci(ci_data=des_Nsurv.ants_ever.pw.qb.ci, 
                                  tenure=des, treatment=ants_ever,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

des_Esurv.ants_ever.pw.qb.p <- plot_ci(ci_data=des_Esurv.ants_ever.pw.qb.ci, 
                                  tenure=des, treatment=ants_ever,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black"), labels=c("Ever ants", "Never ants")) +
    scale_fill_manual(values = c("brown1", "black"), labels=c("Ever ants", "Never ants")) 

(survivorship.ants_ever.final.p <- 
    egg::ggarrange(des_hatch.ants_ever.pw.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.ants_ever.pw.qb.p+
                 theme(legend.position="none"),
               des_Esurv.ants_ever.pw.qb.p+
                 theme(legend.position=c(0.5,0.9))+ylim(0,1),
               labels=c("A","B","C"),
               nrow=1))

ggsave("survivorship.desL.ants_ever.final.png",
       survivorship.ants_ever.final.p,
       device="png", width = 300, height = 110, units = "mm", dpi = "print")
```

### supp
last_desL*ant_treatment
```{r}
des_hatch.pw.qb.p <- plot_ci(ci_data=des_hatch.pw.qb.ci, 
                                  tenure=des, treatment=ant_treatment,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

des_Nsurv.pw.qb.p <- plot_ci(ci_data=des_Nsurv.pw.qb.ci, 
                                  tenure=des, treatment=ant_treatment,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

des_Esurv.pw.qb.p <- plot_ci(ci_data=des_Esurv.pw.qb.ci, 
                                  tenure=des, treatment=ant_treatment,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion date relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black"), labels=c("Ever ants", "Never ants")) +
    scale_fill_manual(values = c("brown1", "black"), labels=c("Ever ants", "Never ants")) 

(survivorship.ants_treatment.final.p <- 
    egg::ggarrange(des_hatch.pw.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.pw.qb.p+
                 theme(legend.position="none"),
               des_Esurv.pw.qb.p+
                 theme(legend.position=c(0.5,0.9))+ylim(0,1),
               labels=c("A","B","C"),
               nrow=1))

ggsave("survivorship.desL.ants_treatment.final.png",
       survivorship.ants_treatment.final.p,
       device="png", width = 300, height = 110, units = "mm", dpi = "print")
```

last_desP*ants_ever
```{r}
des_hatch.desP.ants_ever.pw.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_hatched, survDen=med_t5eggs,
              model = des_hatch.ants_ever.pw.fits.LastDesPlant$mai.qb)

des_Nsurv.desP.ants_ever.pw.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_survived, survDen=n_hatched,
              model = des_Nsurv.ants_ever.pw.fits.LastDesPlant$mai.qb)

des_Esurv.desP.ants_ever.pw.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_survived, survDen=med_t5eggs,
              model = des_Esurv.ants_ever.pw.fits.LastDesPlant$mai.qb)


des_hatch.ants_ever.LastDesPlant.tbl <- 
  tbl_regression(des_hatch.ants_ever.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()

des_hatch.desP.ants_ever.pw.qb.p <- plot_ci(ci_data=des_hatch.desP.ants_ever.pw.qb.ci, 
                                  tenure=last_desP_rel2h, treatment=ants_ever,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion from plant relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

des_Nsurv.desP.ants_ever.pw.qb.p <- plot_ci(ci_data=des_Nsurv.desP.ants_ever.pw.qb.ci, 
                                  tenure=last_desP_rel2h, treatment=ants_ever,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion from plant relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

des_Esurv.desP.ants_ever.pw.qb.p <- plot_ci(ci_data=des_Esurv.desP.ants_ever.pw.qb.ci, 
                                  tenure=last_desP_rel2h, treatment=ants_ever,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion from plant relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black"), labels=c("Ever ants", "Never ants")) +
    scale_fill_manual(values = c("brown1", "black"), labels=c("Ever ants", "Never ants")) 

(survivorship.desP.ants_ever.final.p <- 
    egg::ggarrange(des_hatch.desP.ants_ever.pw.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.desP.ants_ever.pw.qb.p+
                 theme(legend.position="none"),
               des_Esurv.desP.ants_ever.pw.qb.p+
                 theme(legend.position=c(0.5,0.9))+ylim(0,1),
               labels=c("A","B","C"),
               nrow=1))

ggsave("survivorship.desP.ants_ever.final.png",
       survivorship.desP.ants_ever.final.p,
       device="png", width = 300, height = 110, units = "mm", dpi = "print")
```

last_desP*ants_ever female removal control only
```{r}
surv_reg_data_LastDesPlant_filtFemRem <- filter(surv_reg_data_LastDesPlant, !females_removed)

des_hatch.ants_ever.filtFemRem.pw.fits.LastDesPlant <- fit_surv(data_in=surv_reg_data_LastDesPlant_filtFemRem, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=last_desP_rel2h, treatment=ants_ever,
                              interaction="pw")

des_Nsurv.ants_ever.filtFemRem.pw.fits.LastDesPlant <- fit_surv(data_in=surv_reg_data_LastDesPlant_filtFemRem, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_survived, survDen=n_hatched,
                              interaction="pw")

des_Esurv.ants_ever.filtFemRem.pw.fits.LastDesPlant <- fit_surv(data_in=surv_reg_data_LastDesPlant_filtFemRem, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_survived, survDen=med_t5eggs,
                              interaction="pw")

des_hatch.desP.ants_ever.filtFemRem.pw.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant_filtFemRem, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_hatched, survDen=med_t5eggs,
              model = des_hatch.ants_ever.pw.fits.LastDesPlant$mai.qb)

des_Nsurv.desP.ants_ever.filtFemRem.pw.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant_filtFemRem, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_survived, survDen=n_hatched,
              model = des_Nsurv.ants_ever.pw.fits.LastDesPlant$mai.qb)

des_Esurv.desP.ants_ever.filtFemRem.pw.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant_filtFemRem, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_survived, survDen=med_t5eggs,
              model = des_Esurv.ants_ever.pw.fits.LastDesPlant$mai.qb)


des_hatch.ants_ever.filtFemRem.LastDesPlant.tbl <- 
  tbl_regression(des_hatch.ants_ever.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()

des_hatch.desP.ants_ever.filtFemRem.pw.qb.p <- plot_ci(ci_data=des_hatch.desP.ants_ever.filtFemRem.pw.qb.ci, 
                                  tenure=last_desP_rel2h, treatment=ants_ever,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion from plant relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

des_Nsurv.desP.ants_ever.filtFemRem.pw.qb.p <- plot_ci(ci_data=des_Nsurv.desP.ants_ever.filtFemRem.pw.qb.ci, 
                                  tenure=last_desP_rel2h, treatment=ants_ever,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion from plant relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

des_Esurv.desP.ants_ever.filtFemRem.pw.qb.p <- plot_ci(ci_data=des_Esurv.desP.ants_ever.filtFemRem.pw.qb.ci, 
                                  tenure=last_desP_rel2h, treatment=ants_ever,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion from plant relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black"), labels=c("Ever ants", "Never ants")) +
    scale_fill_manual(values = c("brown1", "black"), labels=c("Ever ants", "Never ants")) 

(survivorship.desP.ants_ever.filtFemRem.final.p <- 
    egg::ggarrange(des_hatch.desP.ants_ever.filtFemRem.pw.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.desP.ants_ever.filtFemRem.pw.qb.p+
                 theme(legend.position="none"),
               des_Esurv.desP.ants_ever.filtFemRem.pw.qb.p+
                 theme(legend.position=c(0.5,0.9))+ylim(0,1),
               labels=c("A","B","C"),
               nrow=1))

ggsave("survivorship.desP.ants_ever.filtFemRem.final.png",
       survivorship.desP.ants_ever.filtFemRem.final.p,
       device="png", width = 300, height = 110, units = "mm", dpi = "print")
```

last_desP*ants_ever filtFemRem regression table
```{r}
des_hatch.ants_ever.filtFemRem.LastDesPlant.tbl <- 
  tbl_regression(des_hatch.ants_ever.filtFemRem.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()
des_Nsurv.ants_ever.filtFemRem.LastDesPlant.tbl <- 
  tbl_regression(des_Nsurv.ants_ever.filtFemRem.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()
des_Esurv.ants_ever.filtFemRem.LastDesPlant.tbl <- 
  tbl_regression(des_Esurv.ants_ever.filtFemRem.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()

(ants_ever.filtFemRem.LastDesPlant.tbl_merge <- 
  tbl_merge(
    tbls = list(des_hatch.ants_ever.LastDesPlant.tbl, 
                des_Nsurv.ants_ever.LastDesPlant.tbl, 
                des_Esurv.ants_ever.LastDesPlant.tbl),
    tab_spanner = c("**Hatching success**", 
                    "**Survivorship of nymphs**", 
                    "**Survivorship of eggs**")
  ) %>%
  modify_header(label = "**Variable**") %>%
  bold_labels() %>% italicize_levels())

ants_ever.filtFemRem.LastDesPlant.tbl_merge %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv.reg_summary.desP.ants_ever.filtFemRem.docx")
```

last_desP*ants_ever female removal control only
```{r}
des_hatch.ants_ever.filtFemRem.pw.fits.LastDesPlant <- fit_surv(data_in=surv_reg_data_LastDesPlant_filtFemRem, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=last_desP_rel2h, treatment=ants_ever,
                              interaction="pw")

des_Nsurv.ants_ever.filtFemRem.pw.fits.LastDesPlant <- fit_surv(data_in=surv_reg_data_LastDesPlant_filtFemRem, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_survived, survDen=n_hatched,
                              interaction="pw")

des_Esurv.ants_ever.filtFemRem.pw.fits.LastDesPlant <- fit_surv(data_in=surv_reg_data_LastDesPlant_filtFemRem, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_survived, survDen=med_t5eggs,
                              interaction="pw")

des_hatch.desP.ants_ever.filtFemRem.pw.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant_filtFemRem, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_hatched, survDen=med_t5eggs,
              model = des_hatch.ants_ever.pw.fits.LastDesPlant$mai.qb)

des_Nsurv.desP.ants_ever.filtFemRem.pw.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant_filtFemRem, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_survived, survDen=n_hatched,
              model = des_Nsurv.ants_ever.pw.fits.LastDesPlant$mai.qb)

des_Esurv.desP.ants_ever.filtFemRem.pw.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant_filtFemRem, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_survived, survDen=med_t5eggs,
              model = des_Esurv.ants_ever.pw.fits.LastDesPlant$mai.qb)


des_hatch.ants_ever.filtFemRem.LastDesPlant.tbl <- 
  tbl_regression(des_hatch.ants_ever.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()

des_hatch.desP.ants_ever.filtFemRem.pw.qb.p <- plot_ci(ci_data=des_hatch.desP.ants_ever.filtFemRem.pw.qb.ci, 
                                  tenure=last_desP_rel2h, treatment=ants_ever,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion from plant relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

des_Nsurv.desP.ants_ever.filtFemRem.pw.qb.p <- plot_ci(ci_data=des_Nsurv.desP.ants_ever.filtFemRem.pw.qb.ci, 
                                  tenure=last_desP_rel2h, treatment=ants_ever,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion from plant relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

des_Esurv.desP.ants_ever.filtFemRem.pw.qb.p <- plot_ci(ci_data=des_Esurv.desP.ants_ever.filtFemRem.pw.qb.ci, 
                                  tenure=last_desP_rel2h, treatment=ants_ever,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion from plant relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black"), labels=c("Ever ants", "Never ants")) +
    scale_fill_manual(values = c("brown1", "black"), labels=c("Ever ants", "Never ants")) 

(survivorship.desP.ants_ever.filtFemRem.final.p <- 
    egg::ggarrange(des_hatch.desP.ants_ever.filtFemRem.pw.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.desP.ants_ever.filtFemRem.pw.qb.p+
                 theme(legend.position="none"),
               des_Esurv.desP.ants_ever.filtFemRem.pw.qb.p+
                 theme(legend.position=c(0.5,0.9))+ylim(0,1),
               labels=c("A","B","C"),
               nrow=1))

ggsave("survivorship.desP.ants_ever.filtFemRem.final.png",
       survivorship.desP.ants_ever.filtFemRem.final.p,
       device="png", width = 300, height = 110, units = "mm", dpi = "print")
```

does adding a quadratic term improve model fit and performance?
```{r}
### fit survivorship model
fit_surv_quad <- function(data_in, survNom, survDen, tenure, 
                     treatment){
  data <- eval(substitute(data_in %>% filter(!is.na(tenure))))
  
  mai.b <- eval(substitute(glm(survNom/survDen ~
            tenure*treatment + (I(as.numeric(tenure)^2))*treatment,
          data = data, weights = survDen, family = binomial)))
  print("Interaction, Binomial: ")
  print(capture.output(summary(mai.b))[-(6:which(grepl("Deviance Residuals: ", capture.output(summary(mai.b))))-1)])

  mai.qb <- eval(substitute(glm(survNom/survDen ~
            tenure*treatment + (I(as.numeric(tenure)^2))*treatment,
          data = data, weights = survDen, family = quasibinomial)))
  print("Interaction, Quasibinomial: ")
  print(capture.output(summary(mai.qb))[-(6:which(grepl("Deviance Residuals: ", capture.output(summary(mai.qb))))-1)])

  ma.qb <- eval(substitute(glm(survNom/survDen ~
            tenure+treatment + (I(as.numeric(tenure)^2))*treatment,
          data = data, weights = survDen, family = quasibinomial)))
  print("No Interaction, Quasibinomial: ")
  print(capture.output(summary(ma.qb))[-(6:which(grepl("Deviance Residuals: ", capture.output(summary(ma.qb))))-1)])
      
    mai.models <- list(mai.b = mai.b, mai.qb = mai.qb, ma.qb = ma.qb)
  return(mai.models)
}

## DesP  
# ants_ever, desP
des_hatch.ants_ever.LastDesPlant.quad.fits <- fit_surv_quad(data_in=surv_reg_data_LastDesPlant, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=last_desP_rel2h, treatment=ants_ever)

des_hatch.ants_ever.LastDesPlant.quad.ci <- ci_for_plot(data_in=surv_reg_data_LastDesPlant,
            model=des_hatch.ants_ever.LastDesPlant.quad.fits$mai.qb,
            survNom=n_hatched, survDen=med_t5eggs, tenure=last_desP_rel2h, treatment=ants_ever)

plot_ci(ci_data = des_hatch.ants_ever.LastDesPlant.quad.ci, 
                  tenure = last_desP_rel2h, treatment=ants_ever,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion of plant date relative to hatch") +
    ylab("Hatching success") +
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))
summary(des_hatch.ants_ever.LastDesPlant.quad.fits$mai.qb)

get_qaicc(des_hatch.ants_ever.pw.fits.LastDesPlant)
get_qaicc(des_hatch.ants_ever.LastDesPlant.quad.fits)

des_Nsurv.ants_ever.LastDesPlant.quad.fits <- fit_surv_quad(data_in=surv_reg_data_LastDesPlant, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=last_desP_rel2h, treatment=ants_ever)

des_Nsurv.ants_ever.LastDesPlant.quad.ci <- ci_for_plot(data_in=surv_reg_data_LastDesPlant,
            model=des_Nsurv.ants_ever.LastDesPlant.quad.fits$mai.qb,
            survNom=n_survived, survDen=n_hatched, tenure=last_desP_rel2h, treatment=ants_ever)

plot_ci(ci_data = des_Nsurv.ants_ever.LastDesPlant.quad.ci, 
                  tenure = last_desP_rel2h, treatment=ants_ever,
             survNom = n_survived, survDen = n_hatched) +
    xlab("Latest desertion of plant date relative to hatch") +
    ylab("Survivorship of nymphs") +
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))
summary(des_Nsurv.ants_ever.LastDesPlant.quad.fits$mai.qb)

get_qaicc(des_Nsurv.ants_ever.pw.fits.LastDesPlant)
get_qaicc(des_Nsurv.ants_ever.LastDesPlant.quad.fits)

des_Esurv.ants_ever.LastDesPlant.quad.fits <- fit_surv_quad(data_in=surv_reg_data_LastDesPlant, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=last_desP_rel2h, treatment=ants_ever)

des_Esurv.ants_ever.LastDesPlant.quad.ci <- ci_for_plot(data_in=surv_reg_data_LastDesPlant,
            model=des_Esurv.ants_ever.LastDesPlant.quad.fits$mai.qb,
            survNom=n_survived, survDen=med_t5eggs, tenure=last_desP_rel2h, treatment=ants_ever)

plot_ci(ci_data = des_Esurv.ants_ever.LastDesPlant.quad.ci, 
                  tenure = last_desP_rel2h, treatment=ants_ever,
             survNom = n_survived, survDen = med_t5eggs) +
    xlab("Latest desertion of plant date relative to hatch") +
    ylab("Survivorship of eggs") +
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))
summary(des_Esurv.ants_ever.LastDesPlant.quad.fits$mai.qb)

get_qaicc(des_Esurv.ants_ever.pw.fits.LastDesPlant)
get_qaicc(des_Esurv.ants_ever.LastDesPlant.quad.fits)

# ant_treatment, desP
des_hatch.ant_treatment.LastDesPlant.quad.fits <- fit_surv_quad(data_in=surv_reg_data_LastDesPlant, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=last_desP_rel2h, treatment=ant_treatment)

des_hatch.ant_treatment.LastDesPlant.quad.ci <- ci_for_plot(data_in=surv_reg_data_LastDesPlant,
            model=des_hatch.ant_treatment.LastDesPlant.quad.fits$mai.qb,
            survNom=n_hatched, survDen=med_t5eggs, tenure=last_desP_rel2h, treatment=ant_treatment)

plot_ci(ci_data = des_hatch.ant_treatment.LastDesPlant.quad.ci, 
                  tenure = last_desP_rel2h, treatment=ant_treatment,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion of plant date relative to hatch") +
    ylab("Hatching success") +
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))
summary(des_hatch.ant_treatment.LastDesPlant.quad.fits$mai.qb)

#get_qaicc(des_hatch.ant_treatment.pw.fits.LastDesPlant)
get_qaicc(des_hatch.ant_treatment.LastDesPlant.quad.fits)

des_Nsurv.ant_treatment.LastDesPlant.quad.fits <- fit_surv_quad(data_in=surv_reg_data_LastDesPlant, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=last_desP_rel2h, treatment=ant_treatment)

des_Nsurv.ant_treatment.LastDesPlant.quad.ci <- ci_for_plot(data_in=surv_reg_data_LastDesPlant,
            model=des_Nsurv.ant_treatment.LastDesPlant.quad.fits$mai.qb,
            survNom=n_survived, survDen=n_hatched, tenure=last_desP_rel2h, treatment=ant_treatment)

plot_ci(ci_data = des_Nsurv.ant_treatment.LastDesPlant.quad.ci, 
                  tenure = last_desP_rel2h, treatment=ant_treatment,
             survNom = n_survived, survDen = n_hatched) +
    xlab("Latest desertion of plant date relative to hatch") +
    ylab("Survivorship of nymphs") +
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))
summary(des_Nsurv.ant_treatment.LastDesPlant.quad.fits$mai.qb)

#get_qaicc(des_Nsurv.ant_treatment.pw.fits.LastDesPlant)
get_qaicc(des_Nsurv.ant_treatment.LastDesPlant.quad.fits)

des_Esurv.ant_treatment.LastDesPlant.quad.fits <- fit_surv_quad(data_in=surv_reg_data_LastDesPlant, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=last_desP_rel2h, treatment=ant_treatment)

des_Esurv.ant_treatment.LastDesPlant.quad.ci <- ci_for_plot(data_in=surv_reg_data_LastDesPlant,
            model=des_Esurv.ant_treatment.LastDesPlant.quad.fits$mai.qb,
            survNom=n_survived, survDen=med_t5eggs, tenure=last_desP_rel2h, treatment=ant_treatment)

plot_ci(ci_data = des_Esurv.ant_treatment.LastDesPlant.quad.ci, 
                  tenure = last_desP_rel2h, treatment=ant_treatment,
             survNom = n_survived, survDen = med_t5eggs) +
    xlab("Latest desertion of plant date relative to hatch") +
    ylab("Survivorship of eggs") +
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))
summary(des_Esurv.ant_treatment.LastDesPlant.quad.fits$mai.qb)

#get_qaicc(des_Esurv.ant_treatment.pw.fits.LastDesPlant)
get_qaicc(des_Esurv.ant_treatment.LastDesPlant.quad.fits)


## DesL
# ants_ever, desL
des_hatch.ants_ever.desL.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ants_ever)

des_hatch.ants_ever.desL.quad.ci <- ci_for_plot(data_in=surv_reg_data,
            model=des_hatch.ants_ever.desL.quad.fits$mai.qb,
            survNom=n_hatched, survDen=med_t5eggs, tenure=des, treatment=ants_ever)

(des_hatch.desL.ants_ever.quad.qb.p <- plot_ci(ci_data = des_hatch.ants_ever.desL.quad.ci, 
                  tenure = des, treatment=ants_ever,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion of leaf date relative to hatch") +
    ylab("Hatching success") +
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))
summary(des_hatch.ants_ever.desL.quad.fits$mai.qb)

#get_qaicc(des_hatch.ants_ever.pw.fits.desL)
get_qaicc(des_hatch.ants_ever.desL.quad.fits)

des_Nsurv.ants_ever.desL.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ants_ever)

des_Nsurv.ants_ever.desL.quad.ci <- ci_for_plot(data_in=surv_reg_data,
            model=des_Nsurv.ants_ever.desL.quad.fits$mai.qb,
            survNom=n_survived, survDen=n_hatched, tenure=des, treatment=ants_ever)

(des_Nsurv.desL.ants_ever.quad.qb.p <- plot_ci(ci_data = des_Nsurv.ants_ever.desL.quad.ci, 
                  tenure = des, treatment=ants_ever,
             survNom = n_survived, survDen = n_hatched) +
    xlab("Latest desertion of leaf date relative to hatch") +
    ylab("Survivorship of nymphs") +
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))
summary(des_Nsurv.ants_ever.desL.quad.fits$mai.qb)

#get_qaicc(des_Nsurv.ants_ever.pw.fits.desL)
get_qaicc(des_Nsurv.ants_ever.desL.quad.fits)

des_Esurv.ants_ever.desL.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=des, treatment=ants_ever)

des_Esurv.ants_ever.desL.quad.ci <- ci_for_plot(data_in=surv_reg_data,
            model=des_Esurv.ants_ever.desL.quad.fits$mai.qb,
            survNom=n_survived, survDen=med_t5eggs, tenure=des, treatment=ants_ever)

(des_Esurv.desL.ants_ever.quad.qb.p <- plot_ci(ci_data = des_Esurv.ants_ever.desL.quad.ci, 
                  tenure = des, treatment=ants_ever,
             survNom = n_survived, survDen = med_t5eggs) +
    xlab("Latest desertion of leaf date relative to hatch") +
    ylab("Survivorship of eggs") +
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))
summary(des_Esurv.ants_ever.desL.quad.fits$mai.qb)

#get_qaicc(des_Esurv.ants_ever.pw.fits.desL)
get_qaicc(des_Esurv.ants_ever.desL.quad.fits)

# ant_treatment, desL
des_hatch.ant_treatment.desL.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ant_treatment)

des_hatch.ant_treatment.desL.quad.ci <- ci_for_plot(data_in=surv_reg_data,
            model=des_hatch.ant_treatment.desL.quad.fits$mai.qb,
            survNom=n_hatched, survDen=med_t5eggs, tenure=des, treatment=ant_treatment)

plot_ci(ci_data = des_hatch.ant_treatment.desL.quad.ci, 
                  tenure = des, treatment=ant_treatment,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion of plant date relative to hatch") +
    ylab("Hatching success") +
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))
summary(des_hatch.ant_treatment.desL.quad.fits$mai.qb)

#get_qaicc(des_hatch.ant_treatment.pw.fits.desL)
get_qaicc(des_hatch.ant_treatment.desL.quad.fits)

des_Nsurv.ant_treatment.desL.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ant_treatment)

des_Nsurv.ant_treatment.desL.quad.ci <- ci_for_plot(data_in=surv_reg_data,
            model=des_Nsurv.ant_treatment.desL.quad.fits$mai.qb,
            survNom=n_survived, survDen=n_hatched, tenure=des, treatment=ant_treatment)

plot_ci(ci_data = des_Nsurv.ant_treatment.desL.quad.ci, 
                  tenure = des, treatment=ant_treatment,
             survNom = n_survived, survDen = n_hatched) +
    xlab("Latest desertion of plant date relative to hatch") +
    ylab("Survivorship of nymphs") +
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))
summary(des_Nsurv.ant_treatment.desL.quad.fits$mai.qb)

#get_qaicc(des_Nsurv.ant_treatment.pw.fits.desL)
get_qaicc(des_Nsurv.ant_treatment.desL.quad.fits)

des_Esurv.ant_treatment.desL.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=des, treatment=ant_treatment)

des_Esurv.ant_treatment.desL.quad.ci <- ci_for_plot(data_in=surv_reg_data,
            model=des_Esurv.ant_treatment.desL.quad.fits$mai.qb,
            survNom=n_survived, survDen=med_t5eggs, tenure=des, treatment=ant_treatment)

plot_ci(ci_data = des_Esurv.ant_treatment.desL.quad.ci, 
                  tenure = des, treatment=ant_treatment,
             survNom = n_survived, survDen = med_t5eggs) +
    xlab("Latest desertion of plant date relative to hatch") +
    ylab("Survivorship of eggs") +
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))
summary(des_Esurv.ant_treatment.desL.quad.fits$mai.qb)

#get_qaicc(des_Esurv.ant_treatment.pw.fits.desL)
get_qaicc(des_Esurv.ant_treatment.desL.quad.fits)
```

last_desP * ants_ever + last_desP^2 * ants_ever
```{r}
des_hatch.desP.ants_ever.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_hatched, survDen=med_t5eggs,
              model = des_hatch.ants_ever.LastDesPlant.quad.fits$mai.qb)

des_Nsurv.desP.ants_ever.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_survived, survDen=n_hatched,
              model = des_Nsurv.ants_ever.LastDesPlant.quad.fits$mai.qb)

des_Esurv.desP.ants_ever.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=last_desP_rel2h, treatment=ants_ever,
              survNom=n_survived, survDen=med_t5eggs,
              model = des_Esurv.ants_ever.LastDesPlant.quad.fits$mai.qb)


des_hatch.ants_ever.LastDesPlant.tbl <- 
  tbl_regression(des_hatch.ants_ever.pw.fits.LastDesPlant$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()

des_hatch.desP.ants_ever.quad.qb.p <- plot_ci(ci_data=des_hatch.desP.ants_ever.quad.qb.ci, 
                                  tenure=last_desP_rel2h, treatment=ants_ever,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion from plant relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

des_Nsurv.desP.ants_ever.quad.qb.p <- plot_ci(ci_data=des_Nsurv.desP.ants_ever.quad.qb.ci, 
                                  tenure=last_desP_rel2h, treatment=ants_ever,
             survNom=n_survived, survDen=n_hatched) +
    xlab("Latest desertion from plant relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

des_Esurv.desP.ants_ever.quad.qb.p <- plot_ci(ci_data=des_Esurv.desP.ants_ever.quad.qb.ci, 
                                  tenure=last_desP_rel2h, treatment=ants_ever,
             survNom=n_survived, survDen=med_t5eggs) +
    xlab("Latest desertion from plant relative to hatch") +
    ylab("Survivorship of eggs (eggs/adults)") + 
    scale_color_manual(values = c("brown1", "black"), labels=c("Ever ants", "Never ants")) +
    scale_fill_manual(values = c("brown1", "black"), labels=c("Ever ants", "Never ants")) 

(survivorship.desP.ants_ever.quad.final.p <- 
    egg::ggarrange(des_hatch.desP.ants_ever.quad.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.desP.ants_ever.quad.qb.p+
                 theme(legend.position="none"),
               des_Esurv.desP.ants_ever.quad.qb.p+
                 theme(legend.position=c(0.5,0.9))+ylim(0,1),
               labels=c("A","B","C"),
               nrow=1))

ggsave("survivorship.desP.ants_ever.quad.final.png",
       survivorship.desP.ants_ever.quad.final.p,
       device="png", width = 300, height = 110, units = "mm", dpi = "print")
```

quadratic regression table
```{r}
desP_hatch.ants_ever.quad.tbl <- 
  tbl_regression(des_hatch.ants_ever.LastDesPlant.quad.fits$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()
desP_Nsurv.ants_ever.quad.tbl <- 
  tbl_regression(des_Nsurv.ants_ever.LastDesPlant.quad.fits$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()
desP_Esurv.ants_ever.quad.tbl <- 
  tbl_regression(des_Esurv.ants_ever.LastDesPlant.quad.fits$mai.qb, exponentiate=T,
                 label=list(last_desP_rel2h ~ "Desertion of plant rel. hatch",
                          ants_ever ~ "Ants")) %>% bold_p()

(desP.ants_ever.quad.tbl_merge <- 
  tbl_merge(
    tbls = list(desP_hatch.ants_ever.quad.tbl, 
                desP_Nsurv.ants_ever.quad.tbl, 
                desP_Esurv.ants_ever.quad.tbl),
    tab_spanner = c("**Hatching success**", 
                    "**Survivorship of nymphs**", 
                    "**Survivorship of eggs**")
  ) %>%
  modify_header(label = "**Variable**") %>%
  bold_labels() %>% italicize_levels())

desP.ants_ever.quad.tbl_merge %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv.reg_summary.desP.ants_ever.quad.docx")
```


model comparison table
```{r}
des_hatch.ants_ever.pw.fits.LastDesPlant.null <- 
  glm(data=surv_reg_data_LastDesPlant,
      n_hatched/med_t5eggs ~ 1, family=quasibinomial, weights=med_t5eggs)

with(anova(des_hatch.ants_ever.pw.fits.LastDesPlant.null,
           des_hatch.ants_ever.pw.fits.LastDesPlant$mai.qb),
     pchisq(Deviance,Df,lower.tail=FALSE)[2]) 

des_hatch.pw.fits.null <- 
  glm(data=surv_reg_data,
      n_hatched/med_t5eggs ~ 1, family=quasibinomial, weights=med_t5eggs)

with(anova(des_hatch.pw.fits.null,
           des_hatch.pw.fits$mai.qb),
     pchisq(Deviance,Df,lower.tail=FALSE)[2]) 

# qaicc
(qAICc_gt_tbl <- tibble(
  Model = rep(c("last desert clutch, ant treatment","last desert clutch, ever ants", 
                "last desert plant, ant treatment", "last desert plant, ever ants"),3),
  Response = c(rep("Hatching success",4), rep("Survivorship of nymphs",4), rep("Survivorship of eggs",4)),
  qAICc = c(
    get_qaicc(des_hatch.pw.fits),
    get_qaicc(des_hatch.ants_ever.pw.fits),
    get_qaicc(des_hatch.pw.fits.LastDesPlant),
    get_qaicc(des_hatch.ants_ever.pw.fits.LastDesPlant),
    get_qaicc(des_Nsurv.pw.fits),
    get_qaicc(des_Nsurv.ants_ever.pw.fits),
    get_qaicc(des_Nsurv.pw.fits.LastDesPlant),
    get_qaicc(des_Nsurv.ants_ever.pw.fits.LastDesPlant),
    get_qaicc(des_Esurv.pw.fits),
    get_qaicc(des_Esurv.ants_ever.pw.fits),
    get_qaicc(des_Esurv.pw.fits.LastDesPlant),
    get_qaicc(des_Esurv.ants_ever.pw.fits.LastDesPlant))
  ) %>% 
  group_by(Response) %>%
    arrange(qAICc) %>%
    mutate('delta-qAICc' = qAICc - first(qAICc)) %>%
  gt() %>%
  fmt_number(columns=c(`qAICc`, `delta-qAICc`), decimals=2))

qAICc_gt_tbl %>%
  gt::gtsave(filename="survivorsip_models.qAICc_comparison.rtf")
  

# qAICc into separate tables
# qaicc
(qAICc_gt_tbl_hatch <- tibble(
  Model = c("desert leaf + ant treatment + desert leaf*ant treatment",
            "desert leaf + ants ever + desert leaf*ants ever",
            "desert plant + ant treatment + desert plant*ant treatment",
            "desert plant + ants ever + desert plant*ants ever",
            "desert leaf + ant treatment + desert leaf*ant treatment + 
            desert leaf^2 + desert leaf^2*ant treatment",
            "desert leaf + ants ever + desert leaf*ants ever + 
            desert leaf^2 + desert leaf^2*ants ever",
            "desert plant + ant treatment + desert plant*ant treatment + 
            desert plant^2 + desert plant^2*ant treatment",
            "desert plant + ants ever + desert plant*ants ever + 
            desert plant^2 + desert plant^2*ants ever"),
  Response = c(rep("Hatching success",8)),
  qAICc = c(
    get_qaicc(des_hatch.pw.fits),
    get_qaicc(des_hatch.ants_ever.pw.fits),
    get_qaicc(des_hatch.pw.fits.LastDesPlant),
    get_qaicc(des_hatch.ants_ever.pw.fits.LastDesPlant),
    get_qaicc(des_hatch.ant_treatment.desL.quad.fits),
    get_qaicc(des_hatch.ants_ever.desL.quad.fits),
    get_qaicc(des_hatch.ant_treatment.LastDesPlant.quad.fits),
    get_qaicc(des_hatch.ants_ever.LastDesPlant.quad.fits))
  ) %>% 
  arrange(qAICc) %>%
  mutate('delta-qAICc' = qAICc - first(qAICc)) %>%
  gt() %>%
  fmt_number(columns=c(`qAICc`, `delta-qAICc`), decimals=2))

(qAICc_gt_tbl_Nsurv <- tibble(
  Model = c("desert leaf + ant treatment + desert leaf*ant treatment",
            "desert leaf + ants ever + desert leaf*ants ever",
            "desert plant + ant treatment + desert plant*ant treatment",
            "desert plant + ants ever + desert plant*ants ever",
            "desert leaf + ant treatment + desert leaf*ant treatment + 
            desert leaf^2 + desert leaf^2*ant treatment",
            "desert leaf + ants ever + desert leaf*ants ever + 
            desert leaf^2 + desert leaf^2*ants ever",
            "desert plant + ant treatment + desert plant*ant treatment + 
            desert plant^2 + desert plant^2*ant treatment",
            "desert plant + ants ever + desert plant*ants ever + 
            desert plant^2 + desert plant^2*ants ever"),
  Response = c(rep("Survivorship of nymphs",8)),
  qAICc = c(
    get_qaicc(des_Nsurv.pw.fits),
    get_qaicc(des_Nsurv.ants_ever.pw.fits),
    get_qaicc(des_Nsurv.pw.fits.LastDesPlant),
    get_qaicc(des_Nsurv.ants_ever.pw.fits.LastDesPlant),
    get_qaicc(des_Nsurv.ant_treatment.desL.quad.fits),
    get_qaicc(des_Nsurv.ants_ever.desL.quad.fits),
    get_qaicc(des_Nsurv.ant_treatment.LastDesPlant.quad.fits),
    get_qaicc(des_Nsurv.ants_ever.LastDesPlant.quad.fits))
  ) %>% 
  arrange(qAICc) %>%
  mutate('delta-qAICc' = qAICc - first(qAICc)) %>%
  gt() %>%
  fmt_number(columns=c(`qAICc`, `delta-qAICc`), decimals=2))

(qAICc_gt_tbl_Esurv <- tibble(
  Model = c("desert leaf + ant treatment + desert leaf*ant treatment",
            "desert leaf + ants ever + desert leaf*ants ever",
            "desert plant + ant treatment + desert plant*ant treatment",
            "desert plant + ants ever + desert plant*ants ever",
            "desert leaf + ant treatment + desert leaf*ant treatment + 
            desert leaf^2 + desert leaf^2*ant treatment",
            "desert leaf + ants ever + desert leaf*ants ever + 
            desert leaf^2 + desert leaf^2*ants ever",
            "desert plant + ant treatment + desert plant*ant treatment + 
            desert plant^2 + desert plant^2*ant treatment",
            "desert plant + ants ever + desert plant*ants ever + 
            desert plant^2 + desert plant^2*ants ever"),
  Response = c(rep("Survivorship of eggs",8)),
  qAICc = c(
    get_qaicc(des_Esurv.pw.fits),
    get_qaicc(des_Esurv.ants_ever.pw.fits),
    get_qaicc(des_Esurv.pw.fits.LastDesPlant),
    get_qaicc(des_Esurv.ants_ever.pw.fits.LastDesPlant),
    get_qaicc(des_Esurv.ant_treatment.desL.quad.fits),
    get_qaicc(des_Esurv.ants_ever.desL.quad.fits),
    get_qaicc(des_Esurv.ant_treatment.LastDesPlant.quad.fits),
    get_qaicc(des_Esurv.ants_ever.LastDesPlant.quad.fits))
  ) %>% 
  arrange(qAICc) %>%
  mutate('delta-qAICc' = qAICc - first(qAICc)) %>%
  gt() %>%
  fmt_number(columns=c(`qAICc`, `delta-qAICc`), decimals=2))
```

### Plot only the best model (based on qAICc) for each response variable.
#### Hatching success
`desert_leaf * ants_ever`, `desert_plant * ants_ever`, `desert_plant * ants_treatment`, and `desert_plant * ants_ever + desert_plant^2 * ants_ever` are all equivalent (delta-qAICc < 2) and all models tested were within 4 qAICc of the best model, probably reflecting poor fit and small effect of desertion time and ants on hatching across all models.

Showing the top 4 models:
```{r}
qAICc_gt_tbl_hatch

tbl_regression(des_hatch.ants_ever.pw.fits$mai.qb, exponentiate=T) %>% bold_p()
des_hatch.ants_ever.pw.qb.p

tbl_regression(des_hatch.ants_ever.pw.fits.LastDesPlant$mai.qb, exponentiate=T) %>% bold_p()
des_hatch.ants_ever.pw.qb.p.LastDesPlant

tbl_regression(des_hatch.pw.fits.LastDesPlant$mai.qb, exponentiate=T) %>% bold_p()
des_hatch.pw.qb.p.LastDesPlant

tbl_regression(des_hatch.ants_ever.LastDesPlant.quad.fits$mai.qb, exponentiate=T) %>% bold_p()
des_hatch.desP.ants_ever.quad.qb.p
```

#### Nymph survivorship
The clear winner here is `desert_plant * ants_ever + desert_plant^2 * ants_ever` (second best, quadratic leaf_desertion, is qAICc=28.28 higher).

Showing just the best model: `desert_plant * ants_ever + desert_plant^2 * ants_ever`
```{r}
qAICc_gt_tbl_Nsurv

tbl_regression(des_Nsurv.ants_ever.LastDesPlant.quad.fits$mai.qb, exponentiate=T) %>% bold_p()
des_Nsurv.desP.ants_ever.quad.qb.p

# Compare to model I was showing in the main text before:
tbl_regression(des_Nsurv.ants_ever.pw.fits$mai.qb, exponentiate=T) %>% bold_p()
des_Nsurv.ants_ever.pw.qb.p
```

#### Egg to adult survivorship
The clear winner here is `desert_plant * ants_ever + desert_plant^2 * ants_ever` (second best, quadratic leaf_desertion, is qAICc=28.28 higher).

The problem is that the 95% conf int in the plot looks really awful at the earliest desertion dates.
I guess because there's not enough data to resolve whether there truly is a drop in survivorship after a certain late desertion date (concave down), and since the quadratic term is still significant and there are fewer values at lower desertion dates, it forces a concave-up curve. This is probably why the models that include a quadratic term have generally wider (and uglier) confidence intervals.

Showing just the best model: `desert_plant * ants_ever + desert_plant^2 * ants_ever`
```{r}
qAICc_gt_tbl_Esurv

tbl_regression(des_Esurv.ants_ever.desL.quad.fits$mai.qb, exponentiate=T) %>% bold_p()
des_Esurv.desL.ants_ever.quad.qb.p

tbl_regression(des_Esurv.ants_ever.LastDesPlant.quad.fits$mai.qb, exponentiate=T) %>% bold_p()

# Compare to model I was showing in the main text before:
tbl_regression(des_Esurv.ants_ever.pw.fits$mai.qb, exponentiate=T) %>% bold_p()
des_Esurv.ants_ever.pw.qb.p
```

#### Putting the best (quad) models together
```{r}
egg::ggarrange(des_hatch.desP.ants_ever.quad.qb.p+ # desP was lowest qAICc
                 theme(legend.position="none"),
               des_Nsurv.desP.ants_ever.quad.qb.p+ # desP was lowest qAICc
                 theme(legend.position="none"),
               des_Esurv.desP.ants_ever.quad.qb.p+ # desP was lowest qAICc
                 theme(legend.position=c(0.8,0.8))+ylim(0,1),
               labels=c("A","B","C"),
               ncol=3)

egg::ggarrange(des_hatch.desL.ants_ever.quad.qb.p+ # desL was lowest qAICc
                 theme(legend.position="none"),
               des_Nsurv.desL.ants_ever.quad.qb.p+ # desL was lowest qAICc
                 theme(legend.position="none"),
               des_Esurv.desL.ants_ever.quad.qb.p+ # desL was lowest qAICc
                 theme(legend.position=c(0.8,0.8))+ylim(0,1),
               labels=c("A","B","C"),
               ncol=3)

# Compare to old main figure
egg::ggarrange(des_hatch.ants_ever.pw.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.ants_ever.pw.qb.p+
                 theme(legend.position="none"),
               des_Esurv.ants_ever.pw.qb.p+
                 theme(legend.position=c(0.8,0.8))+ylim(0,1),
               labels=c("A","B","C"),
               ncol=3)
```

### ants_gt2d
desP.ants_gt2d.quad.qb.p
```{r}
# hatching success
des_hatch.desP.ants_gt2d.quad.fits <- fit_surv_quad(data_in=surv_reg_data_LastDesPlant, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=last_desP_rel2h, treatment=ants_gt2d)

des_hatch.desP.ants_gt2d.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=last_desP_rel2h, treatment=ants_gt2d,
              survNom=n_hatched, survDen=med_t5eggs,
              model = des_hatch.desP.ants_gt2d.quad.fits$mai.qb)

(des_hatch.desP.ants_gt2d.quad.qb.p <- plot_ci(ci_data=des_hatch.desP.ants_gt2d.quad.qb.ci, 
                                  tenure=last_desP_rel2h, treatment=ants_gt2d,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion from plant relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

# nymph survivorship
des_Nsurv.desP.ants_gt2d.quad.fits <- fit_surv_quad(data_in=surv_reg_data_LastDesPlant, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=last_desP_rel2h, treatment=ants_gt2d)

des_Nsurv.desP.ants_gt2d.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=last_desP_rel2h, treatment=ants_gt2d,
              survNom=n_survived, survDen=n_hatched,
              model = des_Nsurv.desP.ants_gt2d.quad.fits$mai.qb)

(des_Nsurv.desP.ants_gt2d.quad.qb.p <- plot_ci(ci_data=des_Nsurv.desP.ants_gt2d.quad.qb.ci, 
                                  tenure=last_desP_rel2h, treatment=ants_gt2d,
             survNom = n_survived, survDen = n_hatched) +
    xlab("Latest desertion from plant relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

# egg survivorship
des_Esurv.desP.ants_gt2d.quad.fits <- fit_surv_quad(data_in=surv_reg_data_LastDesPlant, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=last_desP_rel2h, treatment=ants_gt2d)

des_Esurv.desP.ants_gt2d.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=last_desP_rel2h, treatment=ants_gt2d,
              survNom=n_survived, survDen=med_t5eggs,
              model = des_Esurv.desP.ants_gt2d.quad.fits$mai.qb)

(des_Esurv.desP.ants_gt2d.quad.qb.p <- plot_ci(ci_data=des_Esurv.desP.ants_gt2d.quad.qb.ci, 
                                  tenure=last_desP_rel2h, treatment=ants_gt2d,
             survNom = n_survived, survDen = med_t5eggs) +
    xlab("Latest desertion from plant relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))

egg::ggarrange(des_hatch.desP.ants_gt2d.quad.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.desP.ants_gt2d.quad.qb.p+
                 theme(legend.position="none"),
               des_Esurv.desP.ants_gt2d.quad.qb.p+
                 theme(legend.position=c(0.8,0.8))+ylim(0,1),
               labels=c("A","B","C"),
               ncol=3)

```

desL.ants_gt2d.quad.qb.p
```{r}
# hatching success
des_hatch.desL.ants_gt2d.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ants_gt2d)

des_hatch.desL.ants_gt2d.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=des, treatment=ants_gt2d,
              survNom=n_hatched, survDen=med_t5eggs,
              model = des_hatch.desL.ants_gt2d.quad.fits$mai.qb)

(des_hatch.desL.ants_gt2d.quad.qb.p <- plot_ci(ci_data=des_hatch.desL.ants_gt2d.quad.qb.ci, 
                                  tenure=des, treatment=ants_gt2d,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion from leaf relative to hatch") +
    ylab("Hatching success (eggs/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))
summary(des_hatch.desL.ants_gt2d.quad.fits$mai.qb)

# nymph survivorship
des_Nsurv.desL.ants_gt2d.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ants_gt2d)

des_Nsurv.desL.ants_gt2d.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=des, treatment=ants_gt2d,
              survNom=n_survived, survDen=n_hatched,
              model = des_Nsurv.desL.ants_gt2d.quad.fits$mai.qb)

(des_Nsurv.desL.ants_gt2d.quad.qb.p <- plot_ci(ci_data=des_Nsurv.desL.ants_gt2d.quad.qb.ci, 
                                  tenure=des, treatment=ants_gt2d,
             survNom = n_survived, survDen = n_hatched) +
    xlab("Latest desertion from leaf relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))
summary(des_Nsurv.desL.ants_gt2d.quad.fits$mai.qb)

# egg survivorship
des_Esurv.desL.ants_gt2d.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=des, treatment=ants_gt2d)

des_Esurv.desL.ants_gt2d.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=des, treatment=ants_gt2d,
              survNom=n_survived, survDen=med_t5eggs,
              model = des_Esurv.desL.ants_gt2d.quad.fits$mai.qb)

(des_Esurv.desL.ants_gt2d.quad.qb.p <- plot_ci(ci_data=des_Esurv.desL.ants_gt2d.quad.qb.ci, 
                                  tenure=des, treatment=ants_gt2d,
             survNom = n_survived, survDen = med_t5eggs) +
    xlab("Latest desertion from leaf relative to hatch") +
    ylab("Survivorship of nymphs (nymphs/adults)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black")))
summary(des_Esurv.desL.ants_gt2d.quad.fits$mai.qb)

egg::ggarrange(des_hatch.desL.ants_gt2d.quad.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.desL.ants_gt2d.quad.qb.p+
                 theme(legend.position="none"),
               des_Esurv.desL.ants_gt2d.quad.qb.p+
                 theme(legend.position=c(0.8,0.8))+ylim(0,1),
               labels=c("A","B","C"),
               ncol=3)

hatch.desL.ants_gt2d.quad.qb.tbl <- 
  tbl_regression(des_hatch.desL.ants_gt2d.quad.fits$mai.qb, exponentiate=T,
                 label=list(des ~ "Desertion of leaf rel. hatch",
                            `I(as.numeric(des)^2)` ~ "(Desertion of leaf rel. hatch)^2",
                            ants_gt2d ~ "Ants >2 days")) %>% bold_p()
Nsurv.desL.ants_gt2d.quad.qb.tbl <- 
  tbl_regression(des_Nsurv.desL.ants_gt2d.quad.fits$mai.qb, exponentiate=T,
                 label=list(des ~ "Desertion of leaf rel. hatch",
                            `I(as.numeric(des)^2)` ~ "(Desertion of leaf rel. hatch)^2",
                            ants_gt2d ~ "Ants >2 days")) %>% bold_p()
Esurv.desL.ants_gt2d.quad.qb.tbl <- 
  tbl_regression(des_Esurv.desL.ants_gt2d.quad.fits$mai.qb, exponentiate=T,
                 label=list(des ~ "Desertion of leaf rel. hatch",
                            `I(as.numeric(des)^2)` ~ "(Desertion of leaf rel. hatch)^2",
                            ants_gt2d ~ "Ants >2 days")) %>% bold_p()

(desP.ants_gt2d.quad.qb.tbl.merge <- 
  tbl_merge(
    tbls = list(hatch.desL.ants_gt2d.quad.qb.tbl, 
                Nsurv.desL.ants_gt2d.quad.qb.tbl, 
                Esurv.desL.ants_gt2d.quad.qb.tbl),
    tab_spanner = c("**Hatching success**", 
                    "**Survivorship of nymphs**", 
                    "**Survivorship of eggs**")
  ) %>%
  modify_header(label = "**Variable**") %>%
  bold_labels() %>% italicize_levels())
```

qaicc
```{r}
# qAICc into separate tables
# qaicc
(qAICc_gt_tbl_hatch_gt2d <- tibble(
  Model = c("desert leaf + ants ever + desert leaf*ants ever",
            "desert plant + ants ever + desert plant*ants ever",
            "desert leaf + ants ever + desert leaf*ants ever + 
            desert leaf^2 + desert leaf^2*ants ever",
            "desert plant + ants ever + desert plant*ants ever + 
            desert plant^2 + desert plant^2*ants ever",
            "desert leaf + ants >2days + desert leaf*ants >2days + 
            desert leaf^2 + desert leaf^2*ants >2days",
            "desert plant + ants >2days + desert plant*ants >2days + 
            desert plant^2 + desert plant^2*ants >2days"),
  Response = c(rep("Hatching success",6)),
  qAICc = c(
    get_qaicc(des_hatch.ants_ever.pw.fits),
    get_qaicc(des_hatch.ants_ever.pw.fits.LastDesPlant),
    get_qaicc(des_hatch.ants_ever.desL.quad.fits),
    get_qaicc(des_hatch.ants_ever.LastDesPlant.quad.fits),
    get_qaicc(des_hatch.desL.ants_gt2d.quad.fits),
    get_qaicc(des_hatch.desP.ants_gt2d.quad.fits))
  ) %>% 
  arrange(qAICc) %>%
  mutate('delta-qAICc' = qAICc - first(qAICc)) %>%
  gt() %>%
  fmt_number(columns=c(`qAICc`, `delta-qAICc`), decimals=2))

(qAICc_gt_tbl_Nsurv_gt2d <- tibble(
  Model = c("desert leaf + ants ever + desert leaf*ants ever",
            "desert plant + ants ever + desert plant*ants ever",
            "desert leaf + ants ever + desert leaf*ants ever + 
            desert leaf^2 + desert leaf^2*ants ever",
            "desert plant + ants ever + desert plant*ants ever + 
            desert plant^2 + desert plant^2*ants ever",
            "desert leaf + ants >2days + desert leaf*ants >2days + 
            desert leaf^2 + desert leaf^2*ants >2days",
            "desert plant + ants >2days + desert plant*ants >2days + 
            desert plant^2 + desert plant^2*ants >2days"),
  Response = c(rep("Survivorship of nymphs",6)),
  qAICc = c(
    get_qaicc(des_Nsurv.ants_ever.pw.fits),
    get_qaicc(des_Nsurv.ants_ever.pw.fits.LastDesPlant),
    get_qaicc(des_Nsurv.ants_ever.desL.quad.fits),
    get_qaicc(des_Nsurv.ants_ever.LastDesPlant.quad.fits),
    get_qaicc(des_Nsurv.desL.ants_gt2d.quad.fits),
    get_qaicc(des_Nsurv.desP.ants_gt2d.quad.fits))
  ) %>% 
  arrange(qAICc) %>%
  mutate('delta-qAICc' = qAICc - first(qAICc)) %>%
  gt() %>%
  fmt_number(columns=c(`qAICc`, `delta-qAICc`), decimals=2))

(qAICc_gt_tbl_Esurv_gt2d <- tibble(
  Model = c("desert leaf + ants ever + desert leaf*ants ever",
            "desert plant + ants ever + desert plant*ants ever",
            "desert leaf + ants ever + desert leaf*ants ever + 
            desert leaf^2 + desert leaf^2*ants ever",
            "desert plant + ants ever + desert plant*ants ever + 
            desert plant^2 + desert plant^2*ants ever",
            "desert leaf + ants >2days + desert leaf*ants >2days + 
            desert leaf^2 + desert leaf^2*ants >2days",
            "desert plant + ants >2days + desert plant*ants >2days + 
            desert plant^2 + desert plant^2*ants >2days"),
  Response = c(rep("Survivorship of eggs",6)),
  qAICc = c(
    get_qaicc(des_Esurv.ants_ever.pw.fits),
    get_qaicc(des_Esurv.ants_ever.pw.fits.LastDesPlant),
    get_qaicc(des_Esurv.ants_ever.desL.quad.fits),
    get_qaicc(des_Esurv.ants_ever.LastDesPlant.quad.fits),
    get_qaicc(des_Esurv.desL.ants_gt2d.quad.fits),
    get_qaicc(des_Esurv.desP.ants_gt2d.quad.fits))
  ) %>% 
  arrange(qAICc) %>%
  mutate('delta-qAICc' = qAICc - first(qAICc)) %>%
  gt() %>%
  fmt_number(columns=c(`qAICc`, `delta-qAICc`), decimals=2))
```

# Final (really this time) figures for the dissertation
Choosing the models strictly based on qAICc leads to some odd results that make biological interpretation too complciated.

Hatching success: All model types are within ~2 qAICc of each other, so pick whichever shows the biology best and is most consistent with Nsurv and Esurv.

Nymph survivorship: desP * ants_ever * desP^2 has the best qAICc, and the desL version has the second best. The desL version (which, for biological interpretation's sake, should be in the main figure) has very wide 95% CI on the left side, which sends off alarm bells that model fit may be a less robust to addition or subtraction of samples than the AIC suggests. 

Egg survivorship: desL * ants_ever * desL^2  has best qAICc, by far. Again the left side 95% CI is huge and it just looks terrible, suggesting to me that there may be too few influential points on the right side to conclusively support the convex up shape.

One problem with the ants_ever method is that the `never ants` level has a much smaller sample size than the `ever ants` level. I'm worried that this could make conclusive inference on the difference among these treatments or even just slope and shape could be shaky. Breaking the groups into `ants >2 days` vs `ants <=2 days` solves the unequal sample sizes problem and makes the desL figure more straightforward to interpret. The qAICc is considerably worse, but I'm concerned that it is only because ants ever was overfitting with too little data.

So, I'm making `desL * ants_gt2 * desL^2` the main figure and `desP * ants_gt2 * desP^2` the supplemental figure. I will report the qAICc of these two models, but not in a table. The data summary table, regression table and results text will need to change too.

*******

After running all these new regressions, I realize that the desL * ant treatment quadratic model has the lowest qAICc and the most interpretable plot and summary stats. I will use this instead.

And since the desP models perform poorly (both in terms of AICc and a convex up Nsurv fit), I just won't even include them in the supplement. I can include the desL `ants >2 days` in the supplement, but honestly it might not even be necessary since it looks so similar to the treatment-based model. I can just mention they are similar?

# Main - `desL * ants_gt2 * desL^2`

## Tables
```{r}
(surv_reg_data.tbl_summary.desL.ants_gt2d <- surv_reg_data %>%
  mutate(ants = ifelse(ants_gt2d==" ants", "ants >2 days", "ants <=2 days"),
         females = ifelse(females_removed, "Females removed", "Control"),
         `leaf desert date rel. hatch` = des,
         `visited early` = vis,
         `n eggs` = med_t5eggs,
         `n hatched` = n_hatched,
         `n survived` = n_survived) %>%
  select(ants, females, `leaf desert date rel. hatch`, `visited early`, 
         `n eggs`, `n hatched`, `n survived`) %>%
  group_by(females, ants) %>%
  tbl_summary(by = ants) %>%
  bold_labels() %>% italicize_levels() %>%
  add_n())

surv_reg_data.tbl_summary.desL.ants_gt2d %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv_reg_data.tbl_summary.desL.ants_gt2d.docx")
```

```{r}
hatch.desL.ants_gt2d.quad.qb.tbl <- 
  tbl_regression(des_hatch.desL.ants_gt2d.quad.fits$mai.qb, exponentiate=T,
                 label=list(des ~ "Leaf desert date",
                            `I(as.numeric(des)^2)` ~ "(Leaf desert date)^2",
                            ants_gt2d ~ "Ants >2 days")) %>% bold_p()
Nsurv.desL.ants_gt2d.quad.qb.tbl <- 
  tbl_regression(des_Nsurv.desL.ants_gt2d.quad.fits$mai.qb, exponentiate=T,
                 label=list(des ~ "Leaf desert date",
                            `I(as.numeric(des)^2)` ~ "(Leaf desert date)^2",
                            ants_gt2d ~ "Ants >2 days")) %>% bold_p()
Esurv.desL.ants_gt2d.quad.qb.tbl <- 
  tbl_regression(des_Esurv.desL.ants_gt2d.quad.fits$mai.qb, exponentiate=T,
                 label=list(des ~ "Leaf desert date",
                            `I(as.numeric(des)^2)` ~ "(Leaf desert date)^2",
                            ants_gt2d ~ "Ants >2 days")) %>% bold_p()

(desL.ants_gt2d.quad.qb.tbl.merge <- 
  tbl_merge(
    tbls = list(hatch.desL.ants_gt2d.quad.qb.tbl, 
                Nsurv.desL.ants_gt2d.quad.qb.tbl, 
                Esurv.desL.ants_gt2d.quad.qb.tbl),
    tab_spanner = c("**Hatching success**", 
                    "**Survivorship of nymphs**", 
                    "**Survivorship of eggs**")
  ) %>%
  modify_header(label = "**Variable**") %>%
  bold_labels() %>% italicize_levels())

desL.ants_gt2d.quad.qb.tbl.merge %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv.reg_summary.desL.ants_gt2d.quad.docx")
```

## Figures
```{r}
# hatching success
des_hatch.desL.ants_gt2d.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ants_gt2d)

des_hatch.desL.ants_gt2d.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=des, treatment=ants_gt2d,
              survNom=n_hatched, survDen=med_t5eggs,
              model = des_hatch.desL.ants_gt2d.quad.fits$mai.qb)

des_hatch.desL.ants_gt2d.quad.qb.p <- plot_ci(ci_data=des_hatch.desL.ants_gt2d.quad.qb.ci, 
                                  tenure=des, treatment=ants_gt2d,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date from leaf\nrelative to hatch") +
    ylab("Hatching success\n(nymphs/eggs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

# nymph survivorship
des_Nsurv.desL.ants_gt2d.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ants_gt2d)

des_Nsurv.desL.ants_gt2d.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=des, treatment=ants_gt2d,
              survNom=n_survived, survDen=n_hatched,
              model = des_Nsurv.desL.ants_gt2d.quad.fits$mai.qb)

des_Nsurv.desL.ants_gt2d.quad.qb.p <- plot_ci(ci_data=des_Nsurv.desL.ants_gt2d.quad.qb.ci, 
                                  tenure=des, treatment=ants_gt2d,
             survNom = n_survived, survDen = n_hatched) +
    xlab("Latest desertion date from leaf\nrelative to hatch") +
    ylab("Survivorship of nymphs\n(5th instars/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

# egg survivorship
des_Esurv.desL.ants_gt2d.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=des, treatment=ants_gt2d)

des_Esurv.desL.ants_gt2d.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=des, treatment=ants_gt2d,
              survNom=n_survived, survDen=med_t5eggs,
              model = des_Esurv.desL.ants_gt2d.quad.fits$mai.qb)

des_Esurv.desL.ants_gt2d.quad.qb.p <- plot_ci(ci_data=des_Esurv.desL.ants_gt2d.quad.qb.ci, 
                                  tenure=des, treatment=ants_gt2d,
             survNom = n_survived, survDen = med_t5eggs) +
    xlab("Latest desertion date from leaf\nrelative to hatch") +
    ylab("Survivorship of eggs\n(5th instars/eggs)") + 
    scale_color_manual(values = c("brown1", "black"), labels = c("ants > 2 days", "ants ≤ 2 days")) +
    scale_fill_manual(values = c("brown1", "black"), labels = c("ants > 2 days", "ants ≤ 2 days"))
  

(desL.ants_gt2d.quad.qb.p <- egg::ggarrange(des_hatch.desL.ants_gt2d.quad.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.desL.ants_gt2d.quad.qb.p+
                 theme(legend.position="none"),
               des_Esurv.desL.ants_gt2d.quad.qb.p+
                 theme(legend.position=c(0.8,0.95))+ylim(0,1),
               labels=c("A","B","C"),
               ncol=3))

ggsave("desL.ants_gt2d.quad.final.png",
       desL.ants_gt2d.quad.qb.p,
       device="png", width = 300, height = 110, units = "mm", dpi = "print")
```

# Supp 1 -`desL * ants_treatment * desL^2`
## Figures
```{r}
# hatching success
des_hatch.desL.ant_treatment.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ant_treatment)

des_hatch.desL.ant_treatment.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=des, treatment=ant_treatment,
              survNom=n_hatched, survDen=med_t5eggs,
              model = des_hatch.desL.ant_treatment.quad.fits$mai.qb)

des_hatch.desL.ant_treatment.quad.qb.p <- plot_ci(ci_data=des_hatch.desL.ant_treatment.quad.qb.ci, 
                                  tenure=des, treatment=ant_treatment,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date from leaf\nrelative to hatch") +
    ylab("Hatching success\n(nymphs/eggs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

# nymph survivorship
des_Nsurv.desL.ant_treatment.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ant_treatment)

des_Nsurv.desL.ant_treatment.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=des, treatment=ant_treatment,
              survNom=n_survived, survDen=n_hatched,
              model = des_Nsurv.desL.ant_treatment.quad.fits$mai.qb)

des_Nsurv.desL.ant_treatment.quad.qb.p <- plot_ci(ci_data=des_Nsurv.desL.ant_treatment.quad.qb.ci, 
                                  tenure=des, treatment=ant_treatment,
             survNom = n_survived, survDen = n_hatched) +
    xlab("Latest desertion date from leaf\nrelative to hatch") +
    ylab("Survivorship of nymphs\n(5th instars/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

# egg survivorship
des_Esurv.desL.ant_treatment.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=des, treatment=ant_treatment)

des_Esurv.desL.ant_treatment.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=des, treatment=ant_treatment,
              survNom=n_survived, survDen=med_t5eggs,
              model = des_Esurv.desL.ant_treatment.quad.fits$mai.qb)

des_Esurv.desL.ant_treatment.quad.qb.p <- plot_ci(ci_data=des_Esurv.desL.ant_treatment.quad.qb.ci, 
                                  tenure=des, treatment=ant_treatment,
             survNom = n_survived, survDen = med_t5eggs) +
    xlab("Latest desertion date from leaf\nrelative to hatch") +
    ylab("Survivorship of eggs\n(5th instars/eggs)") + 
    scale_color_manual(values = c("brown1", "black"), labels = c("Control", "Ant Exclusion")) +
    scale_fill_manual(values = c("brown1", "black"), labels = c("Control", "Ant Exclusion"))
  

(desL.ant_treatment.quad.qb.p <- egg::ggarrange(des_hatch.desL.ant_treatment.quad.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.desL.ant_treatment.quad.qb.p+
                 theme(legend.position="none"),
               des_Esurv.desL.ant_treatment.quad.qb.p+
                 theme(legend.position=c(0.8,0.95))+ylim(0,1),
               labels=c("A","B","C"),
               ncol=3))

ggsave("desL.ant_treatment.quad.final.png",
       desL.ant_treatment.quad.qb.p,
       device="png", width = 300, height = 110, units = "mm", dpi = "print")
```

## Tables
```{r}
(surv_reg_data.tbl_summary.desL.ant_treatment <- surv_reg_data %>%
  mutate(ants = ant_treatment,
         females = ifelse(females_removed, "Females removed", "Control"),
         `leaf desert date rel. hatch` = des,
         `visited early` = vis,
         `n eggs` = med_t5eggs,
         `n hatched` = n_hatched,
         `n survived` = n_survived) %>%
  select(ants, females, `leaf desert date rel. hatch`, `visited early`, 
         `n eggs`, `n hatched`, `n survived`) %>%
  group_by(females, ants) %>%
  tbl_summary(by = ants) %>%
  bold_labels() %>% italicize_levels() %>%
  add_n())

surv_reg_data.tbl_summary.desL.ant_treatment %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv_reg_data.tbl_summary.desL.ant_treatment.docx")
```

```{r}
hatch.desL.ant_treatment.quad.qb.tbl <- 
  tbl_regression(des_hatch.desL.ant_treatment.quad.fits$mai.qb, exponentiate=T,
                 label=list(des ~ "Leaf desert date",
                            `I(as.numeric(des)^2)` ~ "(Leaf desert date)^2",
                            ant_treatment ~ "Ants")) %>% bold_p()
Nsurv.desL.ant_treatment.quad.qb.tbl <- 
  tbl_regression(des_Nsurv.desL.ant_treatment.quad.fits$mai.qb, exponentiate=T,
                 label=list(des ~ "Leaf desert date",
                            `I(as.numeric(des)^2)` ~ "(Leaf desert date)^2",
                            ant_treatment ~ "Ants")) %>% bold_p()
Esurv.desL.ant_treatment.quad.qb.tbl <- 
  tbl_regression(des_Esurv.desL.ant_treatment.quad.fits$mai.qb, exponentiate=T,
                 label=list(des ~ "Leaf desert date",
                            `I(as.numeric(des)^2)` ~ "(Leaf desert date)^2",
                            ant_treatment ~ "Ants")) %>% bold_p()

(desL.ant_treatment.quad.qb.tbl.merge <- 
  tbl_merge(
    tbls = list(hatch.desL.ant_treatment.quad.qb.tbl, 
                Nsurv.desL.ant_treatment.quad.qb.tbl, 
                Esurv.desL.ant_treatment.quad.qb.tbl),
    tab_spanner = c("**Hatching success**", 
                    "**Survivorship of nymphs**", 
                    "**Survivorship of eggs**")
  ) %>%
  modify_header(label = "**Variable**") %>%
  bold_labels() %>% italicize_levels())

desL.ant_treatment.quad.qb.tbl.merge %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv.reg_summary.desL.ants_treatment.quad.docx")
```



# Supp 2 -`desP * ants_gt2 * desP^2`
## Figures
```{r}
# hatching success
des_hatch.desP.ants_gt2d.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=desP, treatment=ants_gt2d)

des_hatch.desP.ants_gt2d.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data, 
              tenure=desP, treatment=ants_gt2d,
              survNom=n_hatched, survDen=med_t5eggs,
              model = des_hatch.desP.ants_gt2d.quad.fits$mai.qb)

des_hatch.desP.ants_gt2d.quad.qb.p <- plot_ci(ci_data=des_hatch.desP.ants_gt2d.quad.qb.ci, 
                                  tenure=desP, treatment=ants_gt2d,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date from plant\nrelative to hatch") +
    ylab("Hatching success\n(nymphs/eggs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

# nymph survivorship
des_Nsurv.desP.ants_gt2d.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=desP, treatment=ants_gt2d)

des_Nsurv.desP.ants_gt2d.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data, 
              tenure=desP, treatment=ants_gt2d,
              survNom=n_survived, survDen=n_hatched,
              model = des_Nsurv.desP.ants_gt2d.quad.fits$mai.qb)

des_Nsurv.desP.ants_gt2d.quad.qb.p <- plot_ci(ci_data=des_Nsurv.desP.ants_gt2d.quad.qb.ci, 
                                  tenure=desP, treatment=ants_gt2d,
             survNom = n_survived, survDen = n_hatched) +
    xlab("Latest desertion date from plant\nrelative to hatch") +
    ylab("Survivorship of nymphs\n(5th instars/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

# egg survivorship
des_Esurv.desP.ants_gt2d.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=desP, treatment=ants_gt2d)

des_Esurv.desP.ants_gt2d.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data, 
              tenure=desP, treatment=ants_gt2d,
              survNom=n_survived, survDen=med_t5eggs,
              model = des_Esurv.desP.ants_gt2d.quad.fits$mai.qb)

des_Esurv.desP.ants_gt2d.quad.qb.p <- plot_ci(ci_data=des_Esurv.desP.ants_gt2d.quad.qb.ci, 
                                  tenure=desP, treatment=ants_gt2d,
             survNom = n_survived, survDen = med_t5eggs) +
    xlab("Latest desertion date from plant\nrelative to hatch") +
    ylab("Survivorship of eggs\n(5th instars/eggs)") + 
    scale_color_manual(values = c("brown1", "black"), labels = c("ants > 2 days", "ants ≤ 2 days")) +
    scale_fill_manual(values = c("brown1", "black"), labels = c("ants > 2 days", "ants ≤ 2 days"))
  

(desP.ants_gt2d.quad.qb.p <- egg::ggarrange(des_hatch.desP.ants_gt2d.quad.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.desP.ants_gt2d.quad.qb.p+
                 theme(legend.position="none"),
               des_Esurv.desP.ants_gt2d.quad.qb.p+
                 theme(legend.position=c(0.8,0.95))+ylim(0,1),
               labels=c("A","B","C"),
               ncol=3))

ggsave("desP.ants_gt2d.quad.final.png",
       desP.ants_gt2d.quad.qb.p,
       device="png", width = 300, height = 110, units = "mm", dpi = "print")
```

## Tables
don't need to include the data summary in supp, since the only thing that changes is the median (IQR) for desertion
```{r}
(surv_reg_data.tbl_summary.desP.ants_gt2d <- surv_reg_data %>%
  mutate(ants = ifelse(ants_gt2d==" ants", "ants >2 days", "ants <=2 days"),
         females = ifelse(females_removed, "Females removed", "Control"),
         `plant desert date rel. hatch` = desP,
         `visited early` = vis,
         `n eggs` = med_t5eggs,
         `n hatched` = n_hatched,
         `n survived` = n_survived) %>%
  select(ants, females, `plant desert date rel. hatch`, `visited early`, 
         `n eggs`, `n hatched`, `n survived`) %>%
  group_by(females, ants) %>%
  tbl_summary(by = ants) %>%
  bold_labels() %>% italicize_levels() %>%
  add_n())

surv_reg_data.tbl_summary.desP.ants_gt2d %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv_reg_data.tbl_summary.desP.ants_gt2d.docx")
```

```{r}
hatch.desP.ants_gt2d.quad.qb.tbl <- 
  tbl_regression(des_hatch.desP.ants_gt2d.quad.fits$mai.qb, exponentiate=T,
                 label=list(desP ~ "Leaf desert date",
                            `I(as.numeric(desP)^2)` ~ "(Leaf desert date)^2",
                            ants_gt2d ~ "Ants >2 days")) %>% bold_p()
Nsurv.desP.ants_gt2d.quad.qb.tbl <- 
  tbl_regression(des_Nsurv.desP.ants_gt2d.quad.fits$mai.qb, exponentiate=T,
                 label=list(desP ~ "Leaf desert date",
                            `I(as.numeric(desP)^2)` ~ "(Leaf desert date)^2",
                            ants_gt2d ~ "Ants >2 days")) %>% bold_p()
Esurv.desP.ants_gt2d.quad.qb.tbl <- 
  tbl_regression(des_Esurv.desP.ants_gt2d.quad.fits$mai.qb, exponentiate=T,
                 label=list(desP ~ "Leaf desert date",
                            `I(as.numeric(desP)^2)` ~ "(Leaf desert date)^2",
                            ants_gt2d ~ "Ants >2 days")) %>% bold_p()

(desP.ants_gt2d.quad.qb.tbl.merge <- 
  tbl_merge(
    tbls = list(hatch.desP.ants_gt2d.quad.qb.tbl, 
                Nsurv.desP.ants_gt2d.quad.qb.tbl, 
                Esurv.desP.ants_gt2d.quad.qb.tbl),
    tab_spanner = c("**Hatching success**", 
                    "**Survivorship of nymphs**", 
                    "**Survivorship of eggs**")
  ) %>%
  modify_header(label = "**Variable**") %>%
  bold_labels() %>% italicize_levels())

desP.ants_gt2d.quad.qb.tbl.merge %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv.reg_summary.desP.ants_gt2d.quad.docx")
```

# Supp 3 -`desP * ant_s_gt2_treatment * desP^2`
## Figures
```{r}
# hatching success
des_hatch.desP.ant_treatment.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=desP, treatment=ant_treatment)

des_hatch.desP.ant_treatment.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data, 
              tenure=desP, treatment=ant_treatment,
              survNom=n_hatched, survDen=med_t5eggs,
              model = des_hatch.desP.ant_treatment.quad.fits$mai.qb)

des_hatch.desP.ant_treatment.quad.qb.p <- plot_ci(ci_data=des_hatch.desP.ant_treatment.quad.qb.ci, 
                                  tenure=desP, treatment=ant_treatment,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date from plant\nrelative to hatch") +
    ylab("Hatching success\n(nymphs/eggs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

# nymph survivorship
des_Nsurv.desP.ant_treatment.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=desP, treatment=ant_treatment)

des_Nsurv.desP.ant_treatment.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data, 
              tenure=desP, treatment=ant_treatment,
              survNom=n_survived, survDen=n_hatched,
              model = des_Nsurv.desP.ant_treatment.quad.fits$mai.qb)

des_Nsurv.desP.ant_treatment.quad.qb.p <- plot_ci(ci_data=des_Nsurv.desP.ant_treatment.quad.qb.ci, 
                                  tenure=desP, treatment=ant_treatment,
             survNom = n_survived, survDen = n_hatched) +
    xlab("Latest desertion date from plant\nrelative to hatch") +
    ylab("Survivorship of nymphs\n(5th instars/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

# egg survivorship
des_Esurv.desP.ant_treatment.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=med_t5eggs,
                              tenure=desP, treatment=ant_treatment)

des_Esurv.desP.ant_treatment.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data, 
              tenure=desP, treatment=ant_treatment,
              survNom=n_survived, survDen=med_t5eggs,
              model = des_Esurv.desP.ant_treatment.quad.fits$mai.qb)

des_Esurv.desP.ant_treatment.quad.qb.p <- plot_ci(ci_data=des_Esurv.desP.ant_treatment.quad.qb.ci, 
                                  tenure=desP, treatment=ant_treatment,
             survNom = n_survived, survDen = med_t5eggs) +
    xlab("Latest desertion date from plant\nrelative to hatch") +
    ylab("Survivorship of eggs\n(5th instars/eggs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))
  

(desP.ant_treatment.quad.qb.p <- egg::ggarrange(des_hatch.desP.ant_treatment.quad.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.desP.ant_treatment.quad.qb.p+
                 theme(legend.position="none"),
               des_Esurv.desP.ant_treatment.quad.qb.p+
                 theme(legend.position=c(0.8,0.95))+ylim(0,1),
               labels=c("A","B","C"),
               ncol=3))

ggsave("desP.ant_treatment.quad.final.png",
       desP.ant_treatment.quad.qb.p,
       device="png", width = 300, height = 110, units = "mm", dpi = "print")
```

## Tables
don't need to include the data summary in supp, since the only thing that changes is the median (IQR) for desertion
```{r}
(surv_reg_data.tbl_summary.desP.ant_treatment <- surv_reg_data %>%
  mutate(ants = ifelse(ant_treatment==" ants", "ants >2 days", "ants <=2 days"),
         females = ifelse(females_removed, "Females removed", "Control"),
         `plant desert date rel. hatch` = desP,
         `visited early` = vis,
         `n eggs` = med_t5eggs,
         `n hatched` = n_hatched,
         `n survived` = n_survived) %>%
  select(ants, females, `plant desert date rel. hatch`, `visited early`, 
         `n eggs`, `n hatched`, `n survived`) %>%
  group_by(females, ants) %>%
  tbl_summary(by = ants) %>%
  bold_labels() %>% italicize_levels() %>%
  add_n())

surv_reg_data.tbl_summary.desP.ant_treatment %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv_reg_data.tbl_summary.desP.ant_treatment.docx")
```

```{r}
hatch.desP.ant_treatment.quad.qb.tbl <- 
  tbl_regression(des_hatch.desP.ant_treatment.quad.fits$mai.qb, exponentiate=T,
                 label=list(desP ~ "Leaf desert date",
                            `I(as.numeric(desP)^2)` ~ "(Leaf desert date)^2",
                            ant_treatment ~ "Ants")) %>% bold_p()
Nsurv.desP.ant_treatment.quad.qb.tbl <- 
  tbl_regression(des_Nsurv.desP.ant_treatment.quad.fits$mai.qb, exponentiate=T,
                 label=list(desP ~ "Leaf desert date",
                            `I(as.numeric(desP)^2)` ~ "(Leaf desert date)^2",
                            ant_treatment ~ "Ants")) %>% bold_p()
Esurv.desP.ant_treatment.quad.qb.tbl <- 
  tbl_regression(des_Esurv.desP.ant_treatment.quad.fits$mai.qb, exponentiate=T,
                 label=list(desP ~ "Leaf desert date",
                            `I(as.numeric(desP)^2)` ~ "(Leaf desert date)^2",
                            ant_treatment ~ "Ants")) %>% bold_p()

(desP.ant_treatment.quad.qb.tbl.merge <- 
  tbl_merge(
    tbls = list(hatch.desP.ant_treatment.quad.qb.tbl, 
                Nsurv.desP.ant_treatment.quad.qb.tbl, 
                Esurv.desP.ant_treatment.quad.qb.tbl),
    tab_spanner = c("**Hatching success**", 
                    "**Survivorship of nymphs**", 
                    "**Survivorship of eggs**")
  ) %>%
  modify_header(label = "**Variable**") %>%
  bold_labels() %>% italicize_levels())

desP.ant_treatment.quad.qb.tbl.merge %>%
  as_flex_table() %>%
  flextable::save_as_docx(path="surv.reg_summary.desP.ant_treatment.quad.docx")
```

# qAICc
```{r}
# qAICc into separate tables
# qaicc
(qAICc_gt_tbl_hatch_quad <- tibble(
  Model = c("desert leaf + ant treatment + desert leaf*ant treatment + 
            desert leaf^2 + desert leaf^2*ant treatment",
            "desert plant + ant treatment + desert plant*ant treatment + 
            desert plant^2 + desert plant^2*ant treatment",
            "desert leaf + ants >2days + desert leaf*ants >2days + 
            desert leaf^2 + desert leaf^2*ants >2days",
            "desert plant + ants >2days + desert plant*ants >2days + 
            desert plant^2 + desert plant^2*ants >2days"),
  Response = c(rep("Hatching success",4)),
  qAICc = c(
    get_qaicc(des_hatch.desL.ant_treatment.quad.fits),
    get_qaicc(des_hatch.desP.ant_treatment.quad.fits),
    get_qaicc(des_hatch.desL.ants_gt2d.quad.fits),
    get_qaicc(des_hatch.desP.ants_gt2d.quad.fits))
  ) %>% 
  arrange(qAICc) %>%
  mutate('delta-qAICc' = qAICc - first(qAICc)) %>%
  gt() %>%
  fmt_number(columns=c(`qAICc`, `delta-qAICc`), decimals=2))

(qAICc_gt_tbl_Nsurv_quad <- tibble(
  Model = c("desert leaf + ant treatment + desert leaf*ant treatment + 
            desert leaf^2 + desert leaf^2*ant treatment",
            "desert plant + ant treatment + desert plant*ant treatment + 
            desert plant^2 + desert plant^2*ant treatment",
            "desert leaf + ants >2days + desert leaf*ants >2days + 
            desert leaf^2 + desert leaf^2*ants >2days",
            "desert plant + ants >2days + desert plant*ants >2days + 
            desert plant^2 + desert plant^2*ants >2days"),
  Response = c(rep("Nymph survivorship",4)),
  qAICc = c(
    get_qaicc(des_Nsurv.desL.ant_treatment.quad.fits),
    get_qaicc(des_Nsurv.desP.ant_treatment.quad.fits),
    get_qaicc(des_Nsurv.desL.ants_gt2d.quad.fits),
    get_qaicc(des_Nsurv.desP.ants_gt2d.quad.fits))
  ) %>% 
  arrange(qAICc) %>%
  mutate('delta-qAICc' = qAICc - first(qAICc)) %>%
  gt() %>%
  fmt_number(columns=c(`qAICc`, `delta-qAICc`), decimals=2))

(qAICc_gt_tbl_hatch_quad <- tibble(
  Model = c("desert leaf + ant treatment + desert leaf*ant treatment + 
            desert leaf^2 + desert leaf^2*ant treatment",
            "desert plant + ant treatment + desert plant*ant treatment + 
            desert plant^2 + desert plant^2*ant treatment",
            "desert leaf + ants >2days + desert leaf*ants >2days + 
            desert leaf^2 + desert leaf^2*ants >2days",
            "desert plant + ants >2days + desert plant*ants >2days + 
            desert plant^2 + desert plant^2*ants >2days"),
  Response = c(rep("Egg survivorship",4)),
  qAICc = c(
    get_qaicc(des_Esurv.desL.ant_treatment.quad.fits),
    get_qaicc(des_Esurv.desP.ant_treatment.quad.fits),
    get_qaicc(des_Esurv.desL.ants_gt2d.quad.fits),
    get_qaicc(des_Esurv.desP.ants_gt2d.quad.fits))
  ) %>% 
  arrange(qAICc) %>%
  mutate('delta-qAICc' = qAICc - first(qAICc)) %>%
  gt() %>%
  fmt_number(columns=c(`qAICc`, `delta-qAICc`), decimals=2))
```

## Stats interpretation
```{r}
# function to get fits and confint
ci_for_stats <- function(data_in, model){
  
  data <- eval(substitute(
    data_in %>%
      add_column(fit = predict(model, newdata = ., type = 'response'))
    ))
  
  ## grad the inverse link function
  ilink <- family(model)$linkinv
  
  ## add fit and se.fit on the **link** scale
  data_fit_link <- eval(substitute(
    data %>% add_column(
  setNames(as_tibble(predict(model, data, se.fit = TRUE)[1:2]),
           c('fit_link','se_link'))) %>%
## create the interval and backtransform
  mutate(fit_resp  = ilink(fit_link),
         conf_upr = ilink(fit_link + (2 * se_link)),
         conf_lwr = ilink(fit_link - (2 * se_link)))
    ))
  
  return(data_fit_link)
}

# function to get max fit, plus upper and lower ci
get_max_fit <- function(data_in, model){
  
  max_fit <- eval(substitute(ci_for_stats(data_in=data_in, 
             model) %>%
  group_by(ant_treatment) %>%
  mutate(max = max(fit)) %>% filter(fit==max) %>% 
    select(ant_treatment, des, max)))
  
  max_upr <- eval(substitute(ci_for_stats(data_in=data_in, 
             model) %>%
  group_by(ant_treatment) %>%
  mutate(max_upr = max(conf_upr)) %>% filter(conf_upr==max_upr) %>% 
    select(ant_treatment, des_upr=des, max_upr)))
  
  max_lwr <- eval(substitute(ci_for_stats(data_in=data_in, 
             model) %>%
  group_by(ant_treatment) %>%
  mutate(max_lwr = max(conf_lwr)) %>% filter(conf_lwr==max_lwr) %>% 
    select(ant_treatment, des_lwr=des, max_lwr)))
  
  data_out <- max_fit %>% left_join(max_upr) %>% left_join(max_lwr)
  return(data_out)
}

## Hatch
# at -20,0,10 etc.
ci_for_stats(data_in=
               tibble(ant_treatment=c(rep("Control",5), rep("Removed",5)),
                      des=rep(c(-20,10,0,10,20),2)), 
             des_hatch.desL.ant_treatment.quad.fits$mai.qb)

# where is the maximum?
get_max_fit(data_in=tibble(ant_treatment=c(rep("Control",10000), rep("Removed",10000)),
                           des=rep(seq(-20,20,length.out=10000),2)),
            model=des_hatch.desL.ant_treatment.quad.fits$mai.qb)

# Nsurv
# at -20,0,10 etc.
ci_for_stats(data_in=
               tibble(ant_treatment=c(rep("Control",5), rep("Removed",5)),
                      des=rep(c(-20,10,0,10,20),2)), 
             des_Nsurv.desL.ant_treatment.quad.fits$mai.qb)

# where is the maximum?
get_max_fit(data_in=tibble(ant_treatment=c(rep("Control",10000), rep("Removed",10000)),
                           des=rep(seq(-20,20,length.out=10000),2)),
            model=des_Nsurv.desL.ant_treatment.quad.fits$mai.qb)

# Esurv
# at -20,0,10 etc.
ci_for_stats(data_in=
               tibble(ant_treatment=c(rep("Control",5), rep("Removed",5)),
                      des=rep(c(-20,10,0,10,20),2)), 
             des_Esurv.desL.ant_treatment.quad.fits$mai.qb)

# where is the maximum?
get_max_fit(data_in=tibble(ant_treatment=c(rep("Control",10000), rep("Removed",10000)),
                           des=rep(seq(-20,20,length.out=10000),2)),
            model=des_Esurv.desL.ant_treatment.quad.fits$mai.qb)
```



# Figures for FPO

## Figures
### Both colors
```{r}
# hatching success
des_hatch.desL.ant_treatment.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ant_treatment)

des_hatch.desL.ant_treatment.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=des, treatment=ant_treatment,
              survNom=n_hatched, survDen=med_t5eggs,
              model = des_hatch.desL.ant_treatment.quad.fits$mai.qb)

des_hatch.desL.ant_treatment.quad.qb.p <- plot_ci(ci_data=des_hatch.desL.ant_treatment.quad.qb.ci, 
                                  tenure=des, treatment=ant_treatment,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date from leaf\nrelative to hatch") +
    ylab("Hatching success\n(nymphs/eggs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

# nymph survivorship
des_Nsurv.desL.ant_treatment.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ant_treatment)

des_Nsurv.desL.ant_treatment.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=des, treatment=ant_treatment,
              survNom=n_survived, survDen=n_hatched,
              model = des_Nsurv.desL.ant_treatment.quad.fits$mai.qb)

des_Nsurv.desL.ant_treatment.quad.qb.p <- plot_ci(ci_data=des_Nsurv.desL.ant_treatment.quad.qb.ci, 
                                  tenure=des, treatment=ant_treatment,
             survNom = n_survived, survDen = n_hatched) +
    xlab("Latest desertion date from leaf\nrelative to hatch") +
    ylab("Survivorship of nymphs\n(5th instars/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

(FPO_desL.ant_treatment_allCols <- egg::ggarrange(des_hatch.desL.ant_treatment.quad.qb.p+
                 theme(legend.position="none"),
               des_Nsurv.desL.ant_treatment.quad.qb.p+
                 theme(legend.position="none")))

ggsave("FPO_desL.ant_treatment_allCols.png",
       FPO_desL.ant_treatment_allCols,
       device="png", width = 150, height = 200, units = "mm", dpi = "print")
```

### Black only
```{r}
# hatching success
des_hatch.desL.ant_treatment.quad.qb.p_blackOnly <- 
  ggplot(data = filter(des_hatch.desL.ant_treatment.quad.qb.ci,
                       ant_treatment=="Removed"), 
       aes(x = des, y = fit), 
           color = "black", fill = "black") +
    theme_publilia() +
    geom_point(aes(y = n_hatched/med_t5eggs), alpha = 0.25, size = 4, shape=16, key_glyph=draw_key_rect) + 
    geom_line(aes(y = fit), size = 1, key_glyph=draw_key_rect) +
    geom_ribbon(aes(ymin = conf_upr, ymax = conf_lwr),
                    alpha = 0.5, color = NA, key_glyph=draw_key_rect) +
      xlab("Latest desertion date from leaf\nrelative to hatch") +
    ylab("Hatching success\n(nymphs/eggs)")


# nymph survivorship
des_Nsurv.desL.ant_treatment.quad.qb.p_blackOnly <- 
  ggplot(data = filter(des_Nsurv.desL.ant_treatment.quad.qb.ci,
                       ant_treatment=="Removed"), 
       aes(x = des, y = fit), 
           color = "black", fill = "black") +
    theme_publilia() +
    geom_point(aes(y = n_survived/n_hatched), alpha = 0.25, size = 4, shape=16, key_glyph=draw_key_rect) + 
    geom_line(aes(y = fit), size = 1, key_glyph=draw_key_rect) +
    geom_ribbon(aes(ymin = conf_upr, ymax = conf_lwr),
                    alpha = 0.5, color = NA, key_glyph=draw_key_rect) +
  xlab("Latest desertion date from leaf\nrelative to hatch") +
    ylab("Survivorship of nymphs\n(5th instars/nymphs)")

(FPO_desL.ant_treatment_blackOnly <- egg::ggarrange(des_hatch.desL.ant_treatment.quad.qb.p_blackOnly+
                 theme(legend.position="none"),
               des_Nsurv.desL.ant_treatment.quad.qb.p_blackOnly+
                 theme(legend.position="none")))

ggsave("FPO_desL.ant_treatment_blackOnly.png",
       FPO_desL.ant_treatment_blackOnly,
       device="png", width = 150, height = 200, units = "mm", dpi = "print")
```

hatching success
```{r}
# hatching success
des_hatch.desL.ants_gt2d.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_hatched, survDen=med_t5eggs,
                              tenure=des, treatment=ants_gt2d)

des_hatch.desL.ants_gt2d.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=des, treatment=ants_gt2d,
              survNom=n_hatched, survDen=med_t5eggs,
              model = des_hatch.desL.ants_gt2d.quad.fits$mai.qb)

des_hatch.desL.ants_gt2d.quad.qb.p <- plot_ci(ci_data=des_hatch.desL.ants_gt2d.quad.qb.ci, 
                                  tenure=des, treatment=ants_gt2d,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date from leaf\nrelative to hatch") +
    ylab("Hatching success\n(nymphs/eggs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

plot_ci(ci_data=filter(des_hatch.desL.ants_gt2d.quad.qb.ci, 
                       ants_gt2d ), 
                                  tenure=des, treatment=ants_gt2d,
             survNom = n_hatched, survDen = med_t5eggs) +
    xlab("Latest desertion date from leaf\nrelative to hatch") +
    ylab("Hatching success\n(nymphs/eggs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))

```

nymph survivorship
```{r}
# nymph survivorship
des_Nsurv.desL.ants_gt2d.quad.fits <- fit_surv_quad(data_in=surv_reg_data, 
                              survNom=n_survived, survDen=n_hatched,
                              tenure=des, treatment=ants_gt2d)

des_Nsurv.desL.ants_gt2d.quad.qb.ci <- 
  ci_for_plot(data_in=surv_reg_data_LastDesPlant, 
              tenure=des, treatment=ants_gt2d,
              survNom=n_survived, survDen=n_hatched,
              model = des_Nsurv.desL.ants_gt2d.quad.fits$mai.qb)

des_Nsurv.desL.ants_gt2d.quad.qb.p <- plot_ci(ci_data=des_Nsurv.desL.ants_gt2d.quad.qb.ci, 
                                  tenure=des, treatment=ants_gt2d,
             survNom = n_survived, survDen = n_hatched) +
    xlab("Latest desertion date from leaf\nrelative to hatch") +
    ylab("Survivorship of nymphs\n(5th instars/nymphs)") + 
    scale_color_manual(values = c("brown1", "black")) +
    scale_fill_manual(values = c("brown1", "black"))
```

